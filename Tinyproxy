# 保存脚本
cat > /root/tinyproxy_manager.sh << 'SCRIPT_EOF'
#!/bin/bash

#==========================================
# Tinyproxy 一键交互式管理脚本
# 代理服务器端部署 & 管理
#==========================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
PLAIN='\033[0m'

CONF="/etc/tinyproxy/tinyproxy.conf"

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}错误: 请使用 root 用户运行此脚本！${PLAIN}"
        exit 1
    fi
}

get_ip() {
    local ip
    ip=$(curl -s4 ifconfig.me 2>/dev/null || curl -s4 ip.sb 2>/dev/null || hostname -I | awk '{print $1}')
    echo "$ip"
}

install_tinyproxy() {
    echo -e "${CYAN}========== 安装 Tinyproxy ==========${PLAIN}"

    if command -v tinyproxy &>/dev/null; then
        echo -e "${YELLOW}Tinyproxy 已安装，跳过安装步骤${PLAIN}"
    else
        if command -v apt &>/dev/null; then
            apt update -y && apt install -y tinyproxy
        elif command -v yum &>/dev/null; then
            yum install -y epel-release && yum install -y tinyproxy
        elif command -v dnf &>/dev/null; then
            dnf install -y tinyproxy
        else
            echo -e "${RED}不支持的包管理器，请手动安装 tinyproxy${PLAIN}"
            return 1
        fi
    fi

    # 备份原始配置
    [[ -f "$CONF" ]] && cp "$CONF" "${CONF}.bak.$(date +%s)"

    # 配置端口
    read -rp "请输入代理监听端口 [默认 8888]: " port
    port=${port:-8888}

    # 配置允许访问的客户端 IP
    read -rp "请输入允许连接的客户端服务器IP (留空则允许所有): " allow_ip

    # 是否设置认证
    read -rp "是否设置用户名密码认证? (y/n) [默认 n]: " set_auth
    set_auth=${set_auth:-n}

    auth_user=""
    auth_pass=""
    if [[ "$set_auth" == "y" || "$set_auth" == "Y" ]]; then
        read -rp "请输入用户名: " auth_user
        read -rp "请输入密码: " auth_pass
    fi

    # 生成配置文件
    cat > "$CONF" << EOF
User tinyproxy
Group tinyproxy
Port ${port}
Timeout 600
DefaultErrorFile "/usr/share/tinyproxy/default.html"
StatHost "tinyproxy.stats"
LogFile "/var/log/tinyproxy/tinyproxy.log"
LogLevel Info
MaxClients 200
EOF

    # 添加允许的IP
    if [[ -n "$allow_ip" ]]; then
        echo "Allow ${allow_ip}" >> "$CONF"
        echo -e "${GREEN}已限制仅允许 ${allow_ip} 连接${PLAIN}"
    else
        echo "# Allow all connections (no restriction)" >> "$CONF"
        echo -e "${YELLOW}未设置IP限制，所有IP均可连接（注意安全）${PLAIN}"
    fi

    # 添加认证
    if [[ -n "$auth_user" && -n "$auth_pass" ]]; then
        echo "BasicAuth ${auth_user} ${auth_pass}" >> "$CONF"
        echo -e "${GREEN}已设置认证: 用户名=${auth_user}${PLAIN}"
    fi

    # 确保日志目录存在
    mkdir -p /var/log/tinyproxy

    # 启动服务
    systemctl enable tinyproxy
    systemctl restart tinyproxy

    # 放行防火墙
    if command -v firewall-cmd &>/dev/null; then
        firewall-cmd --permanent --add-port=${port}/tcp
        firewall-cmd --reload
        echo -e "${GREEN}firewalld 已放行端口 ${port}${PLAIN}"
    elif command -v ufw &>/dev/null; then
        ufw allow ${port}/tcp
        echo -e "${GREEN}ufw 已放行端口 ${port}${PLAIN}"
    fi

    # 检查状态
    if systemctl is-active --quiet tinyproxy; then
        echo ""
        echo -e "${GREEN}============================================${PLAIN}"
        echo -e "${GREEN}  Tinyproxy 安装并启动成功!${PLAIN}"
        echo -e "${GREEN}============================================${PLAIN}"
        local myip=$(get_ip)
        echo -e "  代理地址: ${CYAN}${myip}:${port}${PLAIN}"
        [[ -n "$allow_ip" ]] && echo -e "  允许IP:   ${CYAN}${allow_ip}${PLAIN}"
        [[ -n "$auth_user" ]] && echo -e "  认证:     ${CYAN}${auth_user}:${auth_pass}${PLAIN}"
        echo ""
        echo -e "${YELLOW}>>> 客户端使用命令（复制到另一台服务器执行）:${PLAIN}"
        echo ""
        if [[ -n "$auth_user" ]]; then
            echo -e "  ${CYAN}# 临时使用（当前会话生效）${PLAIN}"
            echo -e "  export http_proxy=\"http://${auth_user}:${auth_pass}@${myip}:${port}\""
            echo -e "  export https_proxy=\"http://${auth_user}:${auth_pass}@${myip}:${port}\""
            echo ""
            echo -e "  ${CYAN}# 永久生效（写入 /etc/profile）${PLAIN}"
            echo -e "  echo 'export http_proxy=\"http://${auth_user}:${auth_pass}@${myip}:${port}\"' >> /etc/profile"
            echo -e "  echo 'export https_proxy=\"http://${auth_user}:${auth_pass}@${myip}:${port}\"' >> /etc/profile"
            echo -e "  source /etc/profile"
        else
            echo -e "  ${CYAN}# 临时使用（当前会话生效）${PLAIN}"
            echo -e "  export http_proxy=\"http://${myip}:${port}\""
            echo -e "  export https_proxy=\"http://${myip}:${port}\""
            echo ""
            echo -e "  ${CYAN}# 永久生效（写入 /etc/profile）${PLAIN}"
            echo -e "  echo 'export http_proxy=\"http://${myip}:${port}\"' >> /etc/profile"
            echo -e "  echo 'export https_proxy=\"http://${myip}:${port}\"' >> /etc/profile"
            echo -e "  source /etc/profile"
        fi
        echo ""
        echo -e "  ${CYAN}# 测试代理是否生效${PLAIN}"
        echo -e "  curl -x http://${myip}:${port} https://www.google.com"
        echo -e "${GREEN}============================================${PLAIN}"
    else
        echo -e "${RED}Tinyproxy 启动失败，请检查日志: journalctl -u tinyproxy${PLAIN}"
    fi
}

show_status() {
    echo -e "${CYAN}========== Tinyproxy 状态 ==========${PLAIN}"
    systemctl status tinyproxy --no-pager
    echo ""
    if [[ -f "$CONF" ]]; then
        local port=$(grep -E "^Port " "$CONF" | awk '{print $2}')
        local allow=$(grep -E "^Allow " "$CONF" | awk '{print $2}')
        local auth=$(grep -E "^BasicAuth " "$CONF")
        local myip=$(get_ip)
        echo -e "  监听端口: ${CYAN}${port}${PLAIN}"
        echo -e "  服务器IP: ${CYAN}${myip}${PLAIN}"
        [[ -n "$allow" ]] && echo -e "  允许IP:   ${CYAN}${allow}${PLAIN}" || echo -e "  允许IP:   ${YELLOW}所有${PLAIN}"
        [[ -n "$auth" ]] && echo -e "  认证:     ${CYAN}已开启${PLAIN}" || echo -e "  认证:     ${YELLOW}未开启${PLAIN}"
    fi
}

start_proxy() {
    systemctl start tinyproxy
    echo -e "${GREEN}Tinyproxy 已启动${PLAIN}"
}

stop_proxy() {
    systemctl stop tinyproxy
    echo -e "${YELLOW}Tinyproxy 已停止${PLAIN}"
}

restart_proxy() {
    systemctl restart tinyproxy
    echo -e "${GREEN}Tinyproxy 已重启${PLAIN}"
}

change_port() {
    read -rp "请输入新端口: " new_port
    if [[ -z "$new_port" ]]; then
        echo -e "${RED}端口不能为空${PLAIN}"
        return
    fi
    sed -i "s/^Port .*/Port ${new_port}/" "$CONF"
    systemctl restart tinyproxy

    # 更新防火墙
    if command -v firewall-cmd &>/dev/null; then
        firewall-cmd --permanent --add-port=${new_port}/tcp
        firewall-cmd --reload
    elif command -v ufw &>/dev/null; then
        ufw allow ${new_port}/tcp
    fi

    echo -e "${GREEN}端口已修改为 ${new_port} 并重启服务${PLAIN}"
}

change_allow_ip() {
    read -rp "请输入新的允许IP (留空允许所有): " new_ip
    # 删除旧的 Allow 行
    sed -i '/^Allow /d' "$CONF"
    if [[ -n "$new_ip" ]]; then
        echo "Allow ${new_ip}" >> "$CONF"
        echo -e "${GREEN}已设置允许IP: ${new_ip}${PLAIN}"
    else
        echo -e "${YELLOW}已取消IP限制，所有IP均可连接${PLAIN}"
    fi
    systemctl restart tinyproxy
}

change_auth() {
    # 删除旧的认证
    sed -i '/^BasicAuth /d' "$CONF"

    read -rp "是否设置认证? (y/n): " set_auth
    if [[ "$set_auth" == "y" || "$set_auth" == "Y" ]]; then
        read -rp "用户名: " auth_user
        read -rp "密码: " auth_pass
        echo "BasicAuth ${auth_user} ${auth_pass}" >> "$CONF"
        echo -e "${GREEN}认证已设置: ${auth_user}:${auth_pass}${PLAIN}"
    else
        echo -e "${YELLOW}认证已关闭${PLAIN}"
    fi
    systemctl restart tinyproxy
}

show_client_commands() {
    echo -e "${CYAN}========== 客户端使用指令 ==========${PLAIN}"
    local port=$(grep -E "^Port " "$CONF" | awk '{print $2}')
    local auth_line=$(grep -E "^BasicAuth " "$CONF")
    local myip=$(get_ip)

    if [[ -n "$auth_line" ]]; then
        local user=$(echo "$auth_line" | awk '{print $2}')
        local pass=$(echo "$auth_line" | awk '{print $3}')
        local proxy_url="http://${user}:${pass}@${myip}:${port}"
    else
        local proxy_url="http://${myip}:${port}"
    fi

    echo ""
    echo -e "${GREEN}【方法一】临时设置环境变量（当前会话生效）${PLAIN}"
    echo -e "  export http_proxy=\"${proxy_url}\""
    echo -e "  export https_proxy=\"${proxy_url}\""
    echo -e "  export no_proxy=\"localhost,127.0.0.1\""
    echo ""
    echo -e "${GREEN}【方法二】永久生效（写入系统配置）${PLAIN}"
    echo -e "  echo 'export http_proxy=\"${proxy_url}\"' >> /etc/profile"
    echo -e "  echo 'export https_proxy=\"${proxy_url}\"' >> /etc/profile"
    echo -e "  echo 'export no_proxy=\"localhost,127.0.0.1\"' >> /etc/profile"
    echo -e "  source /etc/profile"
    echo ""
    echo -e "${GREEN}【方法三】仅对 yum/dnf 生效${PLAIN}"
    echo -e "  echo 'proxy=${proxy_url}' >> /etc/yum.conf"
    echo ""
    echo -e "${GREEN}【方法四】仅对 apt 生效（Debian/Ubuntu）${PLAIN}"
    echo -e "  echo 'Acquire::http::Proxy \"${proxy_url}\";' > /etc/apt/apt.conf.d/proxy.conf"
    echo -e "  echo 'Acquire::https::Proxy \"${proxy_url}\";' >> /etc/apt/apt.conf.d/proxy.conf"
    echo ""
    echo -e "${GREEN}【方法五】仅对 wget 生效${PLAIN}"
    echo -e "  echo 'http_proxy = ${proxy_url}' >> ~/.wgetrc"
    echo -e "  echo 'https_proxy = ${proxy_url}' >> ~/.wgetrc"
    echo ""
    echo -e "${GREEN}【方法六】Docker 使用代理${PLAIN}"
    echo -e "  mkdir -p /etc/systemd/system/docker.service.d"
    echo -e "  cat > /etc/systemd/system/docker.service.d/proxy.conf << EOF"
    echo -e "  [Service]"
    echo -e "  Environment=\"HTTP_PROXY=${proxy_url}\""
    echo -e "  Environment=\"HTTPS_PROXY=${proxy_url}\""
    echo -e "  Environment=\"NO_PROXY=localhost,127.0.0.1\""
    echo -e "  EOF"
    echo -e "  systemctl daemon-reload && systemctl restart docker"
    echo ""
    echo -e "${GREEN}【测试代理】${PLAIN}"
    echo -e "  curl -x ${proxy_url} https://www.google.com"
    echo -e "  curl -x ${proxy_url} https://www.youtube.com"
    echo ""
    echo -e "${GREEN}【取消代理】${PLAIN}"
    echo -e "  unset http_proxy https_proxy no_proxy"
    echo ""
}

view_log() {
    echo -e "${CYAN}========== 最近 30 条日志 ==========${PLAIN}"
    if [[ -f /var/log/tinyproxy/tinyproxy.log ]]; then
        tail -30 /var/log/tinyproxy/tinyproxy.log
    else
        journalctl -u tinyproxy --no-pager -n 30
    fi
}

uninstall_tinyproxy() {
    read -rp "确认卸载 Tinyproxy? (y/n): " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        systemctl stop tinyproxy
        systemctl disable tinyproxy
        if command -v apt &>/dev/null; then
            apt remove -y tinyproxy && apt autoremove -y
        elif command -v yum &>/dev/null; then
            yum remove -y tinyproxy
        elif command -v dnf &>/dev/null; then
            dnf remove -y tinyproxy
        fi
        rm -f "$CONF" "${CONF}.bak.*"
        echo -e "${GREEN}Tinyproxy 已卸载${PLAIN}"
    else
        echo -e "${YELLOW}取消卸载${PLAIN}"
    fi
}

show_menu() {
    echo ""
    echo -e "${GREEN}============================================${PLAIN}"
    echo -e "${GREEN}    Tinyproxy HTTP 代理 管理脚本${PLAIN}"
    echo -e "${GREEN}============================================${PLAIN}"
    echo -e " ${CYAN}1.${PLAIN} 安装 / 重新配置 Tinyproxy"
    echo -e " ${CYAN}2.${PLAIN} 查看运行状态"
    echo -e " ${CYAN}3.${PLAIN} 启动 Tinyproxy"
    echo -e " ${CYAN}4.${PLAIN} 停止 Tinyproxy"
    echo -e " ${CYAN}5.${PLAIN} 重启 Tinyproxy"
    echo -e " ${CYAN}6.${PLAIN} 修改监听端口"
    echo -e " ${CYAN}7.${PLAIN} 修改允许连接的IP"
    echo -e " ${CYAN}8.${PLAIN} 修改认证(用户名/密码)"
    echo -e " ${CYAN}9.${PLAIN} 查看客户端使用指令"
    echo -e " ${CYAN}10.${PLAIN} 查看日志"
    echo -e " ${CYAN}11.${PLAIN} 卸载 Tinyproxy"
    echo -e " ${CYAN}0.${PLAIN} 退出"
    echo -e "${GREEN}============================================${PLAIN}"
    read -rp "请输入选项 [0-11]: " choice

    case "$choice" in
        1) install_tinyproxy ;;
        2) show_status ;;
        3) start_proxy ;;
        4) stop_proxy ;;
        5) restart_proxy ;;
        6) change_port ;;
        7) change_allow_ip ;;
        8) change_auth ;;
        9) show_client_commands ;;
        10) view_log ;;
        11) uninstall_tinyproxy ;;
        0) exit 0 ;;
        *) echo -e "${RED}无效选项${PLAIN}" ;;
    esac
}

# 主程序
check_root
while true; do
    show_menu
done
SCRIPT_EOF

chmod +x /root/tinyproxy_manager.sh