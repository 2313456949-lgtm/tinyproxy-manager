#!/bin/bash

# ==================================================
# Tinyproxy 一键交互式管理脚本
# Author: Gemini
# Description: Install and manage Tinyproxy easily
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

# 配置文件路径
CONF_FILE="/etc/tinyproxy/tinyproxy.conf"
SCRIPT_PATH=$(readlink -f "$0")
RELEASE=""

# 获取外网IPv4地址（只要IPv4，不要IPv6）
get_public_ipv4() {
    local public_ip=""
    
    # 方法1: 使用 curl -4 获取外网IPv4
    public_ip=$(curl -s -4 https://api.ipify.org 2>/dev/null)
    if [[ -n "$public_ip" ]] && [[ $public_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$public_ip"
        return
    fi
    
    # 方法2: 使用 icanhazip
    public_ip=$(curl -s -4 http://icanhazip.com 2>/dev/null)
    if [[ -n "$public_ip" ]] && [[ $public_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$public_ip"
        return
    fi
    
    # 方法3: 使用 ident.me
    public_ip=$(curl -s -4 http://ident.me 2>/dev/null)
    if [[ -n "$public_ip" ]] && [[ $public_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$public_ip"
        return
    fi
    
    # 如果都失败，返回错误提示
    echo "获取失败"
}

# 环境变量初始化（从配置文件读取）
init_proxy_env() {
    if [[ -f $CONF_FILE ]]; then
        PORT=$(grep "^Port " $CONF_FILE | awk '{print $2}')
        CLIENT_IP=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
        
        if [[ -n "$PORT" ]] && [[ -n "$CLIENT_IP" ]]; then
            export HTTP_PROXY="http://$CLIENT_IP:$PORT"
            export HTTPS_PROXY="http://$CLIENT_IP:$PORT"
        fi
    fi
}

# 检查是否为 Root 用户
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    elif cat /etc/issue 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /etc/issue 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    elif cat /proc/version 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /proc/version 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    else
        RELEASE="unknown"
    fi
    
    if [[ "${RELEASE}" == "unknown" ]]; then
        echo -e "${RED}无法识别系统类型！${PLAIN}"
        exit 1
    fi
}

# 显示使用说明
show_usage_guide() {
    local port=$(grep "^Port " $CONF_FILE | awk '{print $2}')
    local client_ip=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
    
    clear
    echo -e "${GREEN}=================================="
    echo -e " Tinyproxy 配置完成！${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo ""
    echo -e "${BLUE}【代理服务器信息】${PLAIN}"
    echo -e "监听端口: ${YELLOW}$port${PLAIN}"
    echo -e "允许客户端IP: ${YELLOW}$client_ip${PLAIN}"
    echo ""
}

# 主菜单
show_menu() {
    clear
    echo -e "${GREEN}=================================="
    echo -e " Tinyproxy 一键管理脚本${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo ""
    echo -e "${BLUE}请选择操作:${PLAIN}"
    echo "1) 安装 Tinyproxy"
    echo "2) 启动 Tinyproxy"
    echo "3) 停止 Tinyproxy"
    echo "4) 重启 Tinyproxy"
    echo "5) 查看状态"
    echo "6) 卸载 Tinyproxy"
    echo "0) 退出"
    echo ""
    echo -e "${BLUE}请输入选择 [0-6]:${PLAIN}"
}

# 安装 Tinyproxy
install_tinyproxy() {
    check_sys
    echo -e "${BLUE}开始安装 Tinyproxy...${PLAIN}"
    
    if [[ "$RELEASE" == "centos" ]]; then
        yum update -y
        yum install -y tinyproxy curl
    elif [[ "$RELEASE" == "debian" ]] || [[ "$RELEASE" == "ubuntu" ]]; then
        apt-get update
        apt-get install -y tinyproxy curl
    fi
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Tinyproxy 安装成功${PLAIN}"
        
        # 配置IPv4绑定
        sed -i 's/^# BindAddress 0.0.0.0/BindAddress 0.0.0.0/' $CONF_FILE
        sed -i '/Listen/d' $CONF_FILE
        
        echo -e "${BLUE}正在启动 Tinyproxy...${PLAIN}"
        systemctl start tinyproxy
        systemctl enable tinyproxy
        
        if systemctl is-active --quiet tinyproxy; then
            echo -e "${GREEN}Tinyproxy 已启动${PLAIN}"
            show_usage_guide
        fi
    else
        echo -e "${RED}Tinyproxy 安装失败${PLAIN}"
    fi
}

# 启动 Tinyproxy
start_tinyproxy() {
    echo -e "${BLUE}正在启动 Tinyproxy...${PLAIN}"
    systemctl start tinyproxy
    
    if systemctl is-active --quiet tinyproxy; then
        echo -e "${GREEN}Tinyproxy 已启动${PLAIN}"
    else
        echo -e "${RED}Tinyproxy 启动失败${PLAIN}"
    fi
}

# 停止 Tinyproxy
stop_tinyproxy() {
    echo -e "${BLUE}正在停止 Tinyproxy...${PLAIN}"
    systemctl stop tinyproxy
    
    if ! systemctl is-active --quiet tinyproxy; then
        echo -e "${GREEN}Tinyproxy 已停止${PLAIN}"
    else
        echo -e "${RED}Tinyproxy 停止失败${PLAIN}"
    fi
}

# 重启 Tinyproxy
restart_tinyproxy() {
    echo -e "${BLUE}正在重启 Tinyproxy...${PLAIN}"
    systemctl restart tinyproxy
    
    if systemctl is-active --quiet tinyproxy; then
        echo -e "${GREEN}Tinyproxy 已重启${PLAIN}"
    else
        echo -e "${RED}Tinyproxy 重启失败${PLAIN}"
    fi
}

# 查看状态
status_tinyproxy() {
    systemctl status tinyproxy
}

# 卸载 Tinyproxy
uninstall_tinyproxy() {
    read -p "确定要卸载 Tinyproxy 吗？(y/n): " confirm
    if [[ "$confirm" == "y" ]]; then
        systemctl stop tinyproxy
        
        if [[ "$RELEASE" == "centos" ]]; then
            yum remove -y tinyproxy
        elif [[ "$RELEASE" == "debian" ]] || [[ "$RELEASE" == "ubuntu" ]]; then
            apt-get remove -y tinyproxy
        fi
        
        echo -e "${GREEN}Tinyproxy 已卸载${PLAIN}"
    fi
}

# 主程序
main() {
    check_root
    init_proxy_env
    
    while true; do
        show_menu
        read -p "" choice
        
        case $choice in
            1)
                install_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            2)
                start_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            3)
                stop_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            4)
                restart_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            5)
                status_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            6)
                uninstall_tinyproxy
                read -p "按 Enter 继续..."
                ;;
            0)
                echo -e "${GREEN}感谢使用，再见！${PLAIN}"
                exit 0
                ;;
            *)
                echo -e "${RED}无效的选择！${PLAIN}"
                read -p "按 Enter 继续..."
                ;;
        esac
    done
}

# 运行主程序
main