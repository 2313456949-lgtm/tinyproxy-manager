#!/bin/bash

# ==================================================
# Tinyproxy 客户端网络测试脚本
# 功能: 在另一台服务器上测试网络通不通
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

# ========== 网络测试函数 ==========

# 1. 测试代理连接
test_proxy_connection() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【1. 测试代理端口连接】${PLAIN}"
    
    if command -v nc &> /dev/null; then
        echo -e "  使用 nc 测试连接..."
        if nc -zv $proxy_ip $proxy_port 2>&1 | grep -q "succeeded\|open"; then
            echo -e "  ${GREEN}✓ 代理端口 $proxy_port 已开放${PLAIN}"
            return 0
        else
            echo -e "  ${RED}✗ 代理端口 $proxy_port 未开放${PLAIN}"
            return 1
        fi
    elif command -v telnet &> /dev/null; then
        echo -e "  使用 telnet 测试连接..."
        (echo > /dev/tcp/$proxy_ip/$proxy_port) 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "  ${GREEN}✓ 代理端口 $proxy_port 已开放${PLAIN}"
            return 0
        else
            echo -e "  ${RED}✗ 代理端口 $proxy_port 未开放${PLAIN}"
            return 1
        fi
    else
        echo -e "  ${YELLOW}! nc 和 telnet 未安装，跳过${PLAIN}"
        return 2
    fi
}

# 2. 测试 curl 代理连接
test_curl_proxy() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【2. 测试 curl 代理连接】${PLAIN}"
    
    if ! command -v curl &> /dev/null; then
        echo -e "  ${YELLOW}! curl 未安装${PLAIN}"
        return 1
    fi
    
    echo -e "  连接到 http://httpbin.org/ip..."
    if curl -x http://$proxy_ip:$proxy_port http://httpbin.org/ip -m 5 -s > /tmp/curl_test.json 2>&1; then
        echo -e "  ${GREEN}✓ curl 代理连接成功${PLAIN}"
        echo -e "  返回信息:"
        cat /tmp/curl_test.json
        echo ""
        return 0
    else
        echo -e "  ${RED}✗ curl 代理连接失败${PLAIN}"
        return 1
    fi
}

# 3. 测试 wget 代理连接
test_wget_proxy() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【3. 测试 wget 代理连接】${PLAIN}"
    
    if ! command -v wget &> /dev/null; then
        echo -e "  ${YELLOW}! wget 未安装${PLAIN}"
        return 1
    fi
    
    echo -e "  使用 wget 下载测试..."
    if wget -e use_proxy=yes -e http_proxy=http://$proxy_ip:$proxy_port http://httpbin.org/status/200 -O /tmp/wget_test.html -q 2>&1; then
        echo -e "  ${GREEN}✓ wget 代理连接成功${PLAIN}"
        return 0
    else
        echo -e "  ${RED}✗ wget 代理连接失败${PLAIN}"
        return 1
    fi
}

# 4. 测试通过代理访问网站
test_website_access() {
    local proxy_ip=$1
    local proxy_port=$2
    local website=$3
    
    echo -e "${YELLOW}【4. 测试通过代理访问网站】${PLAIN}"
    echo -e "  目标网站: $website"
    
    if ! command -v curl &> /dev/null; then
        echo -e "  ${YELLOW}! curl 未安装${PLAIN}"
        return 1
    fi
    
    if curl -x http://$proxy_ip:$proxy_port $website -m 5 -s -o /dev/null; then
        echo -e "  ${GREEN}✓ 成功访问 $website${PLAIN}"
        return 0
    else
        echo -e "  ${RED}✗ 无法访问 $website${PLAIN}"
        return 1
    fi
}

# 5. 测试 DNS 解析
test_dns_resolution() {
    echo -e "${YELLOW}【5. 测试 DNS 解析】${PLAIN}"
    
    if ! command -v nslookup &> /dev/null && ! command -v dig &> /dev/null; then
        echo -e "  ${YELLOW}! nslookup 和 dig 未安装${PLAIN}"
        return 1
    fi
    
    if command -v nslookup &> /dev/null; then
        echo -e "  查询 www.google.com..."
        if nslookup www.google.com 8.8.8.8 2>&1 | grep -q "Name:"; then
            echo -e "  ${GREEN}✓ DNS 解析成功${PLAIN}"
            return 0
        else
            echo -e "  ${RED}✗ DNS 解析失败${PLAIN}"
            return 1
        fi
    fi
}

# 6. 测试 ping 连接 (通过代理)
test_ping_connection() {
    echo -e "${YELLOW}【6. 测试网络延迟】${PLAIN}"
    
    if ! command -v ping &> /dev/null; then
        echo -e "  ${YELLOW}! ping 未安装${PLAIN}"
        return 1
    fi
    
    echo -e "  Ping 8.8.8.8..."
    if ping -c 3 8.8.8.8 -w 5 &> /tmp/ping_result.txt; then
        echo -e "  ${GREEN}✓ 网络连接正常${PLAIN}"
        tail -n 2 /tmp/ping_result.txt | head -n 1
        return 0
    else
        echo -e "  ${RED}✗ 网络连接失败${PLAIN}"
        return 1
    fi
}

# 7. 设置临时代理并测试
test_with_proxy_env() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【7. 设置环境变量代理测试】${PLAIN}"
    
    export http_proxy=http://$proxy_ip:$proxy_port
    export https_proxy=http://$proxy_ip:$proxy_port
    
    if ! command -v curl &> /dev/null; then
        echo -e "  ${YELLOW}! curl 未安装${PLAIN}"
        unset http_proxy https_proxy
        return 1
    fi
    
    echo -e "  使用环境变量 http_proxy 测试..."
    if curl http://httpbin.org/ip -m 5 -s > /tmp/env_proxy_test.json 2>&1; then
        echo -e "  ${GREEN}✓ 环境变量代理测试成功${PLAIN}"
        echo -e "  返回IP信息:"
        cat /tmp/env_proxy_test.json
        echo ""
    else
        echo -e "  ${RED}✗ 环境变量代理测试失败${PLAIN}"
    fi
    
    unset http_proxy https_proxy
}

# 8. 测试 apt-get 代理 (仅 Debian/Ubuntu)
test_apt_proxy() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【8. 测试 apt-get 代理】${PLAIN}"
    
    if ! command -v apt-get &> /dev/null; then
        echo -e "  ${YELLOW}! 这不是 Debian/Ubuntu 系统${PLAIN}"
        return 1
    fi
    
    echo -e "  测试 apt-get 更新..."
    if apt-get -o Acquire::http::Proxy=http://$proxy_ip:$proxy_port update -s > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓ apt-get 代理测试成功${PLAIN}"
        return 0
    else
        echo -e "  ${RED}✗ apt-get 代理测试失败${PLAIN}"
        return 1
    fi
}

# 9. 测试 yum 代理 (仅 CentOS/RHEL)
test_yum_proxy() {
    local proxy_ip=$1
    local proxy_port=$2
    
    echo -e "${YELLOW}【9. 测试 yum 代理】${PLAIN}"
    
    if ! command -v yum &> /dev/null; then
        echo -e "  ${YELLOW}! 这不是 CentOS/RHEL 系统${PLAIN}"
        return 1
    fi
    
    echo -e "  测试 yum 列表..."
    if yum -d 1 -e 0 --proxy=http://$proxy_ip:$proxy_port list available > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓ yum 代理测试成功${PLAIN}"
        return 0
    else
        echo -e "  ${RED}✗ yum 代理测试失败${PLAIN}"
        return 1
    fi
}

# 10. 完整测试报告
test_complete_report() {
    local proxy_ip=$1
    local proxy_port=$2
    
    clear
    echo -e "${BLUE}========================================${PLAIN}"
    echo -e "${GREEN}     Tinyproxy 网络连接完整测试${PLAIN}"
    echo -e "${BLUE}========================================${PLAIN}"
    echo ""
    echo -e "代理服务器: ${YELLOW}$proxy_ip:$proxy_port${PLAIN}"
    echo -e "测试时间: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    local pass_count=0
    local fail_count=0
    
    # 执行所有测试
    test_proxy_connection $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_curl_proxy $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_wget_proxy $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_website_access $proxy_ip $proxy_port "http://www.google.com" && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_dns_resolution && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_ping_connection && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_with_proxy_env $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_apt_proxy $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    test_yum_proxy $proxy_ip $proxy_port && ((pass_count++)) || ((fail_count++))
    echo ""
    
    # 显示测试结果
    echo -e "${BLUE}========================================${PLAIN}"
    echo -e "${GREEN}     测试结果汇总${PLAIN}"
    echo -e "${BLUE}========================================${PLAIN}"
    echo -e "通过测试: ${GREEN}$pass_count${PLAIN}"
    echo -e "失败测试: ${RED}$fail_count${PLAIN}"
    echo ""
    
    if [ $fail_count -eq 0 ]; then
        echo -e "${GREEN}✓ 网络连接正常，可以正常使用代理！${PLAIN}"
    else
        echo -e "${YELLOW}! 部分测试失败，请检查网络配置${PLAIN}"
    fi
    
    echo -e "${BLUE}========================================${PLAIN}"
}

# ========== 菜单 ==========
show_menu() {
    clear
    echo -e "${BLUE}========================================${PLAIN}"
    echo -e "${GREEN}  Tinyproxy 客户端网络测试工具${PLAIN}"
    echo -e "${BLUE}========================================${PLAIN}"
    echo -e "1. 测试代理端口连接"
    echo -e "2. 测试 curl 代理连接"
    echo -e "3. 测试 wget 代理连接"
    echo -e "4. 测试网站访问"
    echo -e "5. 测试 DNS 解析"
    echo -e "6. 测试网络延迟"
    echo -e "7. 测试环境变量代理"
    echo -e "8. 测试 apt-get 代理"
    echo -e "9. 测试 yum 代理"
    echo -e "10. 完整网络测试"
    echo -e "0. 退出"
    echo -e "${BLUE}========================================${PLAIN}"
}

# ========== 主逻辑 ==========
main() {
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 和端口不能为空！${PLAIN}"
        exit 1
    fi
    
    # 验证 IP 格式
    if ! [[ $proxy_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo -e "${RED}错误: IP 格式不正确！${PLAIN}"
        exit 1
    fi
    
    while true; do
        show_menu
        read -p "请输入选项: " choice
        
        case $choice in
            1) echo ""; test_proxy_connection $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            2) echo ""; test_curl_proxy $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            3) echo ""; test_wget_proxy $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            4) echo ""; test_website_access $proxy_ip $proxy_port "http://www.google.com"; read -p "按 Enter 继续..."; ;;
            5) echo ""; test_dns_resolution; read -p "按 Enter 继续..."; ;;
            6) echo ""; test_ping_connection; read -p "按 Enter 继续..."; ;;
            7) echo ""; test_with_proxy_env $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            8) echo ""; test_apt_proxy $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            9) echo ""; test_yum_proxy $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            10) test_complete_report $proxy_ip $proxy_port; read -p "按 Enter 继续..."; ;;
            0) echo -e "${GREEN}退出测试。${PLAIN}"; exit 0; ;;
            *) echo -e "${RED}输入错误！${PLAIN}"; sleep 1; ;;
        esac
    done
}

# 运行主程序
main