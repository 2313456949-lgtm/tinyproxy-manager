#!/bin/bash

# ==================================================
# Tinyproxy 一键交互式管理脚本
# Author: Gemini
# Description: Install and manage Tinyproxy easily
# ==================================================
# 公网IP获取已优化版本
# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

# 配置文件路径
CONF_FILE="/etc/tinyproxy/tinyproxy.conf"
SCRIPT_PATH=$(readlink -f "$0")
RELEASE=""

# 获取本机公网 IPv4 地址（不要内网地址，不要 IPv6）
get_public_ipv4() {
    local ip=""
    # 依次尝试多个服务，确保可靠性
    ip=$(curl -4 -s --max-time 5 https://api.ipify.org 2>/dev/null) \
    || ip=$(curl -4 -s --max-time 5 https://ifconfig.me 2>/dev/null) \
    || ip=$(curl -4 -s --max-time 5 https://icanhazip.com 2>/dev/null) \
    || ip=$(curl -4 -s --max-time 5 https://ip.sb 2>/dev/null)

    # 去除可能的空白字符
    ip=$(echo "$ip" | tr -d '[:space:]')

    # 验证是否为合法 IPv4
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$ip"
    else
        # 兜底：如果全部失败，返回提示
        echo "获取失败"
    fi
}

# ================================================
# 以下内容保持不变，适配全局替换server_ip部分
# 显示使用说明中修改调用 get_public_ipv4

show_usage_guide() {
    local port=$(grep "^Port " $CONF_FILE | awk '{print $2}')
    local client_ip=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
    local server_ip=$(get_public_ipv4)  # 替换为获取公网IPv4

    clear
    echo -e "${GREEN}=================================="
    echo -e " Tinyproxy 配置完成！${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo ""
    echo -e "${BLUE}【服务器信息】${PLAIN}"
    echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
    echo -e "监听端口: ${YELLOW}$port${PLAIN}"
    echo -e "允许客户端IP: ${YELLOW}$client_ip${PLAIN}"
    echo ""
    echo -e "${BLUE}【完整代理地址】${PLAIN}"
    echo -e "${GREEN}http://$server_ip:$port${PLAIN}"
    echo ""
    ...
}  # 略去重复部分

# 其余脚本逻辑保持一致
# ================================================
menu() {
    clear
    echo -e "=================================="
    echo -e " ${GREEN}Tinyproxy 一键管理脚本${PLAIN}"
    echo -e "=================================="
    echo -e "1. 安装 Tinyproxy"
    echo -e "2. 卸载 Tinyproxy"
    echo -e "----------------------------------"
    echo -e "3. 启动服务"
    echo -e "4. 停止服务"
    echo -e "5. 重启服务"
    echo -e "6. 查看状态 & 端口 & 客户端IP"
    ...
}
check_root
check_sys
menu