#!/bin/bash

# ==================================================
# Tinyproxy 一键交互式管理脚本
# Author: Gemini
# Description: Install and manage Tinyproxy easily
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
PLAIN='\033[0m'

# 配置文件路径
CONF_FILE="/etc/tinyproxy/tinyproxy.conf"
SCRIPT_PATH=$(readlink -f "$0")
RELEASE=""

# 检查是否为 Root 用户
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    elif cat /etc/issue 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /etc/issue 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    elif cat /proc/version 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /proc/version 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    else
        RELEASE="unknown"
    fi
    
    if [[ "${RELEASE}" == "unknown" ]]; then
        echo -e "${RED}无法识别系统类型！${PLAIN}"
        exit 1
    fi
}

# 安装 Tinyproxy
install_tinyproxy() {
    echo -e "${GREEN}正在安装 Tinyproxy...${PLAIN}"
    
    if [[ "${RELEASE}" == "centos" ]]; then
        yum install -y epel-release
        yum install -y tinyproxy
    else
        apt-get update
        apt-get install -y tinyproxy
    fi

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Tinyproxy 安装成功！${PLAIN}"
        
        # 创建快捷命令
        cp "$SCRIPT_PATH" /usr/local/bin/tpmenu
        chmod +x /usr/local/bin/tpmenu
        echo -e "${YELLOW}提示: 以后可以直接输入 'tpmenu' 命令来管理。${PLAIN}"
        
        # 初始化配置，备份原配置（加入时间戳避免覆盖）
        if [[ -f $CONF_FILE ]]; then
            cp $CONF_FILE ${CONF_FILE}.bak.$(date +%s)
        fi
        
        # 默认配置优化
        sed -i 's/^Allow /#Allow /g' $CONF_FILE
        
        # 启用服务并启动
        systemctl enable tinyproxy
        systemctl start tinyproxy
        
        configure_proxy
    else
        echo -e "${RED}安装失败，请检查网络或源。${PLAIN}"
        exit 1
    fi
}

# 配置向导
configure_proxy() {
    echo -e "${YELLOW}--- 配置向导 ---${PLAIN}"
    
    # 设置端口
    read -p "请输入代理端口 (默认 8888): " port
    [[ -z "${port}" ]] && port="8888"
    sed -i "s/^Port .*/Port $port/" $CONF_FILE
    
    # 设置允许的IP
    echo -e "请输入允许连接的 IP 地址。"
    echo -e "1. 允许所有 IP (0.0.0.0/0 - 有安全风险)"
    echo -e "2. 手动输入特定 IP (例如: 192.168.1.100)"
    read -p "请选择 (默认 1): " ip_choice
    [[ -z "${ip_choice}" ]] && ip_choice="1"
    
    # 先清除已有的 Allow 规则（除注释外的）
    sed -i '/^Allow /d' $CONF_FILE

    if [[ "${ip_choice}" == "2" ]]; then
        read -p "请输入允许的 IP 地址: " user_ip
        if [[ -z "${user_ip}" ]]; then
            echo -e "${RED}IP 不能为空，已设置为允许所有。${PLAIN}"
            echo "Allow 0.0.0.0/0" >> $CONF_FILE
        else
            echo "Allow $user_ip" >> $CONF_FILE
        fi
    else
        # 允许所有
        echo "Allow 0.0.0.0/0" >> $CONF_FILE
    fi

    echo -e "${GREEN}配置已更新。${PLAIN}"
    restart_tinyproxy
}

# 卸载
uninstall_tinyproxy() {
    echo -e "${YELLOW}正在卸载 Tinyproxy...${PLAIN}"
    systemctl stop tinyproxy 2>/dev/null
    systemctl disable tinyproxy 2>/dev/null
    
    if [[ "${RELEASE}" == "centos" ]]; then
        yum remove -y tinyproxy
    else
        apt-get remove -y tinyproxy --purge
    fi
    
    rm -rf /etc/tinyproxy
    rm -f /usr/local/bin/tpmenu
    echo -e "${GREEN}卸载完成。${PLAIN}"
    sleep 2
    menu
}

# 管理命令
start_tinyproxy() {
    systemctl start tinyproxy
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}服务已启动。${PLAIN}"
    else
        echo -e "${RED}服务启动失败。${PLAIN}"
    fi
    sleep 2
}

stop_tinyproxy() {
    systemctl stop tinyproxy
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}服务已停止。${PLAIN}"
    else
        echo -e "${RED}服务停止失败。${PLAIN}"
    fi
    sleep 2
}

restart_tinyproxy() {
    systemctl restart tinyproxy
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}服务已重启。${PLAIN}"
    else
        echo -e "${RED}服务重启失败。${PLAIN}"
        sleep 2
        return
    fi
    sleep 1
    show_status
}

show_status() {
    if systemctl is-active --quiet tinyproxy; then
        port=$(grep "^Port " $CONF_FILE | awk '{print $2}')
        echo -e "${GREEN}Tinyproxy 状态: [运行中]${PLAIN}"
        echo -e "监听端口: ${YELLOW}$port${PLAIN}"
        echo -e "允许列表: "
        grep "^Allow " $CONF_FILE || echo " (无显式允许，可能仅限本地或允许所有)"
    else
        echo -e "${RED}Tinyproxy 状态: [未运行]${PLAIN}"
    fi
    sleep 2
}

view_logs() {
    if [[ -f /var/log/tinyproxy/tinyproxy.log ]]; then
        tail -n 20 /var/log/tinyproxy/tinyproxy.log
    else
        echo -e "${RED}日志文件不存在，服务可能未启动过。${PLAIN}"
    fi
    sleep 2
}

add_ip() {
    read -p "请输入要添加的白名单 IP: " new_ip
    if [[ -z "${new_ip}" ]]; then
        echo -e "${RED}IP 不能为空。${PLAIN}"
    else
        # 检查是否已存在
        if grep -q "^Allow $new_ip" $CONF_FILE; then
            echo -e "${YELLOW}此 IP 已存在。${PLAIN}"
        else
            echo "Allow $new_ip" >> $CONF_FILE
            echo -e "${GREEN}已添加 $new_ip${PLAIN}"
            restart_tinyproxy
        fi
    fi
    sleep 2
}

modify_port() {
    read -p "请输入新端口: " new_port
    if [[ -z "${new_port}" ]]; then
        echo -e "${RED}端口不能为空。${PLAIN}"
    else
        sed -i "s/^Port .*/Port $new_port/" $CONF_FILE
        restart_tinyproxy
    fi
}

# 菜单
menu() {
    clear
    echo -e "=================================="
    echo -e " ${GREEN}Tinyproxy 一键管理脚本${PLAIN}"
    echo -e "=================================="
    echo -e "1. 安装 Tinyproxy"
    echo -e "2. 卸载 Tinyproxy"
    echo -e "----------------------------------"
    echo -e "3. 启动服务"
    echo -e "4. 停止服务"
    echo -e "5. 重启服务"
    echo -e "6. 查看状态 & 端口"
    echo -e "----------------------------------"
    echo -e "7. 添加允许访问的 IP (白名单)"
    echo -e "8. 修改监听端口"
    echo -e "9. 查看最近日志"
    echo -e "0. 退出脚本"
    echo -e "=================================="
    read -p "请输入选项 [0-9]: " choice

    case $choice in
        1) check_sys; install_tinyproxy ;;
        2) uninstall_tinyproxy ;;
        3) start_tinyproxy ;;
        4) stop_tinyproxy ;;
        5) restart_tinyproxy ;;
        6) show_status ;;
        7) add_ip ;;
        8) modify_port ;;
        9) view_logs ;;
        0) echo -e "${GREEN}退出脚本。${PLAIN}"; exit 0 ;;
        *) echo -e "${RED}输入错误，请重新输入。${PLAIN}"; sleep 1; menu ;;
    esac
    
    menu
}

# 主逻辑
check_root
check_sys

if [ "$1" == "install" ]; then
    install_tinyproxy
else
    menu
fi
