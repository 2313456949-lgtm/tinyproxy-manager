#!/bin/bash

# ==================================================
# Tinyproxy 一键管理脚本 (轻量版)
# ==================================================

RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

CONF_FILE="/etc/tinyproxy/tinyproxy.conf"
SCRIPT_PATH=$(readlink -f "$0")

# 获取服务器公网IP
get_public_ip() {
    curl -s --max-time 3 ifconfig.me 2>/dev/null || \
    curl -s --max-time 3 ip.sb 2>/dev/null || \
    curl -s --max-time 3 ipinfo.io/ip 2>/dev/null || \
    hostname -I | awk '{print $1}'
}

# 检查Root
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 请使用 root 用户运行！${PLAIN}" && exit 1
}

# 安装
install_tinyproxy() {
    echo -e "${GREEN}正在安装 Tinyproxy...${PLAIN}"
    
    if [[ -f /etc/redhat-release ]]; then
        yum install -y epel-release >/dev/null 2>&1
        yum install -y tinyproxy >/dev/null 2>&1
    else
        apt-get update >/dev/null 2>&1
        apt-get install -y tinyproxy >/dev/null 2>&1
    fi

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}安装成功！${PLAIN}"
        cp "$SCRIPT_PATH" /usr/local/bin/tpmenu 2>/dev/null
        chmod +x /usr/local/bin/tpmenu 2>/dev/null
        [[ -f $CONF_FILE ]] && cp $CONF_FILE ${CONF_FILE}.bak
        sed -i 's/^Allow /#Allow /g' $CONF_FILE
        systemctl enable tinyproxy >/dev/null 2>&1
        configure_proxy
    else
        echo -e "${RED}安装失败！${PLAIN}"
        exit 1
    fi
}

# 配置
configure_proxy() {
    echo -e "${YELLOW}--- 配置向导 ---${PLAIN}"
    
    # 端口
    read -p "监听端口 [默认 8888]: " port
    [[ -z "$port" ]] && port="8888"
    sed -i "s/^Port .*/Port $port/" $CONF_FILE
    
    # 服务器IP（自动获取，可修改）
    local server_ip=$(get_public_ip)
    echo -e "检测到服务器IP: ${GREEN}$server_ip${PLAIN}"
    read -p "服务器IP [默认 $server_ip]: " input_server_ip
    [[ -n "$input_server_ip" ]] && server_ip="$input_server_ip"
    
    # 客户端IP（手动输入）
    read -p "允许的客户端IP: " client_ip
    while [[ -z "$client_ip" || ! "$client_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; do
        echo -e "${RED}IP不能为空且格式需正确！${PLAIN}"
        read -p "允许的客户端IP: " client_ip
    done
    
    sed -i '/^Allow /d' $CONF_FILE
    echo "Allow $client_ip" >> $CONF_FILE

    # 重启服务
    systemctl stop tinyproxy >/dev/null 2>&1
    sleep 1
    systemctl start tinyproxy >/dev/null 2>&1
    
    if systemctl is-active --quiet tinyproxy; then
        echo -e "${GREEN}配置完成！${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
        echo -e "客户端IP: ${YELLOW}$client_ip${PLAIN}"
    else
        echo -e "${RED}启动失败，查看错误信息：${PLAIN}"
        journalctl -u tinyproxy -n 10 --no-pager
    fi
}

# 卸载
uninstall_tinyproxy() {
    systemctl stop tinyproxy >/dev/null 2>&1
    systemctl disable tinyproxy >/dev/null 2>&1
    if [[ -f /etc/redhat-release ]]; then
        yum remove -y tinyproxy >/dev/null 2>&1
    else
        apt-get remove -y tinyproxy --purge >/dev/null 2>&1
    fi
    rm -rf /etc/tinyproxy /usr/local/bin/tpmenu
    echo -e "${GREEN}卸载完成${PLAIN}"
}

# 启动
start_service() {
    systemctl start tinyproxy
    systemctl is-active --quiet tinyproxy && echo -e "${GREEN}已启动${PLAIN}" || echo -e "${RED}启动失败${PLAIN}"
}

# 停止
stop_service() {
    systemctl stop tinyproxy
    echo -e "${GREEN}已停止${PLAIN}"
}

# 重启
restart_service() {
    systemctl stop tinyproxy >/dev/null 2>&1
    sleep 1
    systemctl start tinyproxy >/dev/null 2>&1
    systemctl is-active --quiet tinyproxy && echo -e "${GREEN}已重启${PLAIN}" || echo -e "${RED}重启失败${PLAIN}"
}

# 状态
show_status() {
    if systemctl is-active --quiet tinyproxy; then
        local port=$(grep "^Port " $CONF_FILE | awk '{print $2}')
        local client_ip=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
        local server_ip=$(get_public_ip)
        echo -e "${GREEN}状态: 运行中${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
        echo -e "客户端IP: ${YELLOW}$client_ip${PLAIN}"
    else
        echo -e "${RED}状态: 未运行${PLAIN}"
    fi
}

# 添加IP
add_ip() {
    read -p "添加客户端IP: " new_ip
    if [[ "$new_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        if grep -q "^Allow $new_ip" $CONF_FILE; then
            echo -e "${YELLOW}IP已存在${PLAIN}"
        else
            echo "Allow $new_ip" >> $CONF_FILE
            restart_service
            echo -e "${GREEN}已添加: $new_ip${PLAIN}"
        fi
    else
        echo -e "${RED}IP格式错误${PLAIN}"
    fi
}

# 改端口
modify_port() {
    local cur=$(grep "^Port " $CONF_FILE | awk '{print $2}')
    echo -e "当前端口: ${YELLOW}$cur${PLAIN}"
    read -p "新端口: " new_port
    if [[ -n "$new_port" ]]; then
        sed -i "s/^Port .*/Port $new_port/" $CONF_FILE
        restart_service
    fi
}

# 改客户端IP
modify_client_ip() {
    local cur=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
    echo -e "当前客户端IP: ${YELLOW}$cur${PLAIN}"
    read -p "新客户端IP: " new_ip
    if [[ "$new_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        sed -i '/^Allow /d' $CONF_FILE
        echo "Allow $new_ip" >> $CONF_FILE
        restart_service
    else
        echo -e "${RED}IP格式错误${PLAIN}"
    fi
}

# 查看日志
view_logs() {
    journalctl -u tinyproxy -n 20 --no-pager
}

# 使用说明
show_usage() {
    local port=$(grep "^Port " $CONF_FILE 2>/dev/null | awk '{print $2}')
    local server_ip=$(get_public_ip)
    [[ -z "$port" ]] && port="8888"
    
    echo -e "${BLUE}【代理使用方法】${PLAIN}"
    echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
    echo ""
    echo -e "${YELLOW}临时设置:${PLAIN}"
    echo -e "  export http_proxy=http://$server_ip:$port"
    echo -e "  export https_proxy=http://$server_ip:$port"
    echo ""
    echo -e "${YELLOW}测试连接:${PLAIN}"
    echo -e "  curl -x http://$server_ip:$port http://httpbin.org/ip"
    echo ""
    echo -e "${YELLOW}取消代理:${PLAIN}"
    echo -e "  unset http_proxy https_proxy"
}

# 菜单
menu() {
    clear
    echo -e "================================"
    echo -e " ${GREEN}Tinyproxy 管理脚本${PLAIN}"
    echo -e "================================"
    echo -e " 1. 安装"
    echo -e " 2. 卸载"
    echo -e " 3. 启动"
    echo -e " 4. 停止"
    echo -e " 5. 重启"
    echo -e " 6. 状态"
    echo -e " 7. 添加客户端IP"
    echo -e " 8. 修改端口"
    echo -e " 9. 修改客户端IP"
    echo -e "10. 查看日志"
    echo -e "11. 使用说明"
    echo -e " 0. 退出"
    echo -e "================================"
    read -p "选项 [0-11]: " choice

    case $choice in
        1) install_tinyproxy ;;
        2) uninstall_tinyproxy ;;
        3) start_service ;;
        4) stop_service ;;
        5) restart_service ;;
        6) show_status ;;
        7) add_ip ;;
        8) modify_port ;;
        9) modify_client_ip ;;
        10) view_logs ;;
        11) show_usage ;;
        0) exit 0 ;;
        *) echo -e "${RED}输入错误${PLAIN}" ;;
    esac
    
    echo ""
    read -p "按 Enter 继续..."
    menu
}

check_root
[[ "$1" == "install" ]] && install_tinyproxy || menu