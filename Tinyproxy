#!/bin/bash

# ==================================================
# Tinyproxy 一键交互式管理脚本
# Author: Gemini
# Description: Install and manage Tinyproxy easily
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

# 配置文件路径
CONF_FILE="/etc/tinyproxy/tinyproxy.conf"
SCRIPT_PATH=$(readlink -f "$0")
RELEASE=""

# 手动指定服务器 IPv4 地址
DEFAULT_SERVER_IP="填写你自己的服务器公网 IPv4 地址"  # 请替换为你实际的服务器公网 IPv4 地址

# 环境变量初始化（从配置文件读取）
init_proxy_env() {
    if [[ -f $CONF_FILE ]]; then
        PORT=$(grep "^Port " $CONF_FILE | awk '{print $2}')
        CLIENT_IP=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
        
        if [[ -n "$PORT" ]] && [[ -n "$CLIENT_IP" ]]; then
            export HTTP_PROXY="http://$CLIENT_IP:$PORT"
            export HTTPS_PROXY="http://$CLIENT_IP:$PORT"
        fi
    fi
}

# 检查是否为 Root 用户
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    elif cat /etc/issue 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /etc/issue 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    elif cat /proc/version 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    elif cat /proc/version 2>/dev/null | grep -q -i "debian"; then
        RELEASE="debian"
    else
        RELEASE="unknown"
    fi
    
    if [[ "${RELEASE}" == "unknown" ]]; then
        echo -e "${RED}无法识别系统类型！${PLAIN}"
        exit 1
    fi
}

# 显示使用说明
show_usage_guide() {
    local port=$(grep "^Port " $CONF_FILE | awk '{print $2}')
    local client_ip=$(grep "^Allow " $CONF_FILE | awk '{print $2}')
    local server_ip="$DEFAULT_SERVER_IP"  # 使用手动设置的服务器 IP
    
    clear
    echo -e "${GREEN}=================================="
    echo -e " Tinyproxy 配置完成！${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo ""
    echo -e "${BLUE}【服务器信息】${PLAIN}"
    echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
    echo -e "监听端口: ${YELLOW}$port${PLAIN}"
    echo -e "允许客户端IP: ${YELLOW}$client_ip${PLAIN}"
    echo ""
    echo -e "${BLUE}【完整代理地址】${PLAIN}"
    echo -e "${GREEN}http://$server_ip:$port${PLAIN}"
    echo ""
    echo -e "${BLUE}【环境变量配置】${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo ""
    echo -e "${BLUE}【Linux 使用命令】${PLAIN}"
    # 省略其他说明命令...
}

# 菜单
menu() {
    # 改为显示/设置默认 IP 地址
    echo -e "${BLUE}当前默认服务器地址：${YELLOW}$DEFAULT_SERVER_IP${PLAIN}"
    read -p "是否需要修改默认服务器地址? (y/N): " modify_choice
    if [[ "${modify_choice,,}" == "y" ]]; then
        read -p "请输入新的服务器地址（IPv4）: " DEFAULT_SERVER_IP
        echo -e "新的服务器地址设置为：${GREEN}$DEFAULT_SERVER_IP${PLAIN}"
    fi
    # 继续菜单逻辑...
}

check_root
check_sys
init_proxy_env
menu