#!/bin/bash

# ==================================================
# Tinyproxy 客户端配置脚本
# Author: Gemini
# Description: Configure HTTP proxy on client servers
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

# 检查是否为 Root 用户
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    elif cat /etc/issue 2>/dev/null | grep -q -i "ubuntu"; then
        RELEASE="ubuntu"
    else
        RELEASE="unknown"
    fi
    
    if [[ "${RELEASE}" == "unknown" ]]; then
        echo -e "${RED}无法识别系统类型！${PLAIN}"
        exit 1
    fi
}

# 显示菜单
menu() {
    clear
    echo -e "=================================="
    echo -e " ${GREEN}Tinyproxy 客户端配置脚本${PLAIN}"
    echo -e "=================================="
    echo -e "1. 临时设置HTTP代理 (仅当前终端)"
    echo -e "2. 永久设置HTTP代理 (系统级-所有用户)"
    echo -e "3. 永久设置HTTP代理 (用户级)"
    echo -e "4. 配置 apt-get 使用代理"
    echo -e "5. 配置 yum 使用代理"
    echo -e "6. 配置 pip 使用代理"
    echo -e "7. 配置 Git 使用代理"
    echo -e "8. 配置 Docker 使用代理"
    echo -e "9. 配置 systemd 服务使用代理"
    echo -e "10. 测试代理连接"
    echo -e "11. 查看当前代理配置"
    echo -e "12. 取消代理设置"
    echo -e "0. 退出脚本"
    echo -e "=================================="
    read -p "请输入选项 [0-12]: " choice

    case $choice in
        1) set_proxy_temporary ;;
        2) set_proxy_permanent_system ;;
        3) set_proxy_permanent_user ;;
        4) configure_apt ;;
        5) configure_yum ;;
        6) configure_pip ;;
        7) configure_git ;;
        8) configure_docker ;;
        9) configure_systemd ;;
        10) test_proxy ;;
        11) show_proxy_config ;;
        12) unset_proxy ;;
        0) echo -e "${GREEN}退出脚本。${PLAIN}"; exit 0 ;;
        *) echo -e "${RED}输入错误，请重新输入。${PLAIN}"; sleep 1; menu ;;
    esac
    
    menu
}

# 1. 临时设置代理
set_proxy_temporary() {
    echo -e "${YELLOW}--- 临时设置 HTTP 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 验证IP格式
    if ! [[ $proxy_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo -e "${RED}错误: IP 格式不正确！${PLAIN}"
        sleep 2
        return
    fi
    
    export http_proxy=http://$proxy_ip:$proxy_port
    export https_proxy=http://$proxy_ip:$proxy_port
    export ftp_proxy=http://$proxy_ip:$proxy_port
    export HTTP_PROXY=http://$proxy_ip:$proxy_port
    export HTTPS_PROXY=http://$proxy_ip:$proxy_port
    export FTP_PROXY=http://$proxy_ip:$proxy_port
    
    echo -e "${GREEN}✓ 临时代理已设置！${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    echo -e "说明: 仅在当前终端会话有效，重启终端后失效"
    sleep 3
}

# 2. 永久设置代理（系统级）
set_proxy_permanent_system() {
    echo -e "${YELLOW}--- 永久设置 HTTP 代理 (系统级) ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 验证IP格式
    if ! [[ $proxy_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo -e "${RED}错误: IP 格式不正确！${PLAIN}"
        sleep 2
        return
    fi
    
    # 备份原文件
    cp /etc/profile /etc/profile.bak.$(date +%s)
    
    # 检查是否已存在代理设置
    if grep -q "http_proxy" /etc/profile; then
        sed -i '/http_proxy/d' /etc/profile
        sed -i '/https_proxy/d' /etc/profile
        sed -i '/ftp_proxy/d' /etc/profile
        sed -i '/HTTP_PROXY/d' /etc/profile
        sed -i '/HTTPS_PROXY/d' /etc/profile
        sed -i '/FTP_PROXY/d' /etc/profile
    fi
    
    # 添加代理设置
    cat >> /etc/profile << EOF

# HTTP Proxy Settings
export http_proxy=http://$proxy_ip:$proxy_port
export https_proxy=http://$proxy_ip:$proxy_port
export ftp_proxy=http://$proxy_ip:$proxy_port
export HTTP_PROXY=http://$proxy_ip:$proxy_port
export HTTPS_PROXY=http://$proxy_ip:$proxy_port
export FTP_PROXY=http://$proxy_ip:$proxy_port
EOF
    
    echo -e "${GREEN}✓ 系统级代理配置已完成！${PLAIN}"
    echo -e "配置文件: ${YELLOW}/etc/profile${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    echo -e "说明: 请运行 ${BLUE}source /etc/profile${PLAIN} 立即生效"
    echo -e "或重新登录使其永久生效"
    sleep 3
}

# 3. 永久设置代理（用户级）
set_proxy_permanent_user() {
    echo -e "${YELLOW}--- 永久设置 HTTP 代理 (用户级) ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 验证IP格式
    if ! [[ $proxy_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo -e "${RED}错误: IP 格式不正确！${PLAIN}"
        sleep 2
        return
    fi
    
    # 检查 .bashrc 文件
    if [[ ! -f ~/.bashrc ]]; then
        touch ~/.bashrc
    fi
    
    # 备份原文件
    cp ~/.bashrc ~/.bashrc.bak.$(date +%s)
    
    # 检查是否已存在代理设置
    if grep -q "http_proxy" ~/.bashrc; then
        sed -i '/http_proxy/d' ~/.bashrc
        sed -i '/https_proxy/d' ~/.bashrc
        sed -i '/ftp_proxy/d' ~/.bashrc
        sed -i '/HTTP_PROXY/d' ~/.bashrc
        sed -i '/HTTPS_PROXY/d' ~/.bashrc
        sed -i '/FTP_PROXY/d' ~/.bashrc
    fi
    
    # 添加代理设置
    cat >> ~/.bashrc << EOF

# HTTP Proxy Settings
export http_proxy=http://$proxy_ip:$proxy_port
export https_proxy=http://$proxy_ip:$proxy_port
export ftp_proxy=http://$proxy_ip:$proxy_port
export HTTP_PROXY=http://$proxy_ip:$proxy_port
export HTTPS_PROXY=http://$proxy_ip:$proxy_port
export FTP_PROXY=http://$proxy_ip:$proxy_port
EOF
    
    echo -e "${GREEN}✓ 用户级代理配置已完成！${PLAIN}"
    echo -e "配置文件: ${YELLOW}~/.bashrc${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    echo -e "说明: 请运行 ${BLUE}source ~/.bashrc${PLAIN} 立即生效"
    sleep 3
}

# 4. 配置 apt-get
configure_apt() {
    echo -e "${YELLOW}--- 配置 apt-get 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 创建 apt 代理配置
    mkdir -p /etc/apt/apt.conf.d/
    cat > /etc/apt/apt.conf.d/proxy.conf << EOF
Acquire::http::Proxy "http://$proxy_ip:$proxy_port";
Acquire::https::Proxy "http://$proxy_ip:$proxy_port";
Acquire::ftp::Proxy "http://$proxy_ip:$proxy_port";
EOF
    
    echo -e "${GREEN}✓ apt-get 代理已配置！${PLAIN}"
    echo -e "配置文件: ${YELLOW}/etc/apt/apt.conf.d/proxy.conf${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    sleep 3
}

# 5. 配置 yum
configure_yum() {
    echo -e "${YELLOW}--- 配置 yum 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 备份原文件
    cp /etc/yum.conf /etc/yum.conf.bak.$(date +%s)
    
    # 检查是否已存在代理设置
    if grep -q "proxy=" /etc/yum.conf; then
        sed -i '/proxy=/d' /etc/yum.conf
    fi
    
    # 添加代理设置
    sed -i "/\[main\]/a proxy=http://$proxy_ip:$proxy_port" /etc/yum.conf
    
    echo -e "${GREEN}✓ yum 代理已配置！${PLAIN}"
    echo -e "配置文件: ${YELLOW}/etc/yum.conf${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    sleep 3
}

# 6. 配置 pip
configure_pip() {
    echo -e "${YELLOW}--- 配置 pip 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 创建 pip 配置目录
    mkdir -p ~/.pip/
    
    # 创建 pip 配置文件
    cat > ~/.pip/pip.conf << EOF
[global]
proxy = [user:passwd@]proxy.server:port
index-url = https://pypi.org/simple
EOF
    
    # 编辑代理设置
    sed -i "s|proxy = \[user:passwd@\]proxy.server:port|proxy = http://$proxy_ip:$proxy_port|g" ~/.pip/pip.conf
    
    echo -e "${GREEN}✓ pip 代理已配置！${PLAIN}"
    echo -e "配置文件: ${YELLOW}~/.pip/pip.conf${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    sleep 3
}

# 7. 配置 Git
configure_git() {
    echo -e "${YELLOW}--- 配置 Git 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 配置 Git HTTP 代理
    git config --global http.proxy http://$proxy_ip:$proxy_port
    git config --global https.proxy http://$proxy_ip:$proxy_port
    git config --global http.sslVerify false
    
    echo -e "${GREEN}✓ Git 代理已配置！${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    echo -e "配置文件: ${YELLOW}~/.gitconfig${PLAIN}"
    sleep 3
}

# 8. 配置 Docker
configure_docker() {
    echo -e "${YELLOW}--- 配置 Docker 代理 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    # 创建 Docker 配置目录
    mkdir -p /etc/systemd/system/docker.service.d/
    
    # 创建 Docker 代理配置
    cat > /etc/systemd/system/docker.service.d/http-proxy.conf << EOF
[Service]
Environment="HTTP_PROXY=http://$proxy_ip:$proxy_port"
Environment="HTTPS_PROXY=http://$proxy_ip:$proxy_port"
Environment="NO_PROXY=localhost,127.0.0.1"
EOF
    
    # 重新加载 systemd
    systemctl daemon-reload
    systemctl restart docker
    
    echo -e "${GREEN}✓ Docker 代理已配置！${PLAIN}"
    echo -e "配置文件: ${YELLOW}/etc/systemd/system/docker.service.d/http-proxy.conf${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    sleep 3
}

# 9. 配置 systemd 服务
configure_systemd() {
    echo -e "${YELLOW}--- 配置 systemd 服务使用代理 ---${PLAIN}"
    read -p "请输入要配置的服务名 (例如: xxx): " service_name
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$service_name" ]] || [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: 服务名、IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    SERVICE_FILE="/etc/systemd/system/$service_name.service"
    
    if [[ ! -f $SERVICE_FILE ]]; then
        echo -e "${RED}错误: 服务文件不存在！${PLAIN}"
        sleep 2
        return
    fi
    
    # 备份原文件
    cp $SERVICE_FILE $SERVICE_FILE.bak.$(date +%s)
    
    # 检查是否已存在 [Service] 段
    if ! grep -q "^\[Service\]" $SERVICE_FILE; then
        echo "[Service]" >> $SERVICE_FILE
    fi
    
    # 添加代理环境变量
    sed -i "/^\[Service\]/a Environment=\"HTTP_PROXY=http://$proxy_ip:$proxy_port\"\nEnvironment=\"HTTPS_PROXY=http://$proxy_ip:$proxy_port\"" $SERVICE_FILE
    
    # 重新加载 systemd
    systemctl daemon-reload
    
    echo -e "${GREEN}✓ systemd 服务代理已配置！${PLAIN}"
    echo -e "服务文件: ${YELLOW}$SERVICE_FILE${PLAIN}"
    echo -e "代理地址: ${YELLOW}http://$proxy_ip:$proxy_port${PLAIN}"
    echo -e "说明: 请运行 ${BLUE}systemctl restart $service_name${PLAIN} 重启服务"
    sleep 3
}

# 10. 测试代理连接
test_proxy() {
    echo -e "${YELLOW}--- 测试代理连接 ---${PLAIN}"
    read -p "请输入代理服务器 IP: " proxy_ip
    read -p "请输入代理端口: " proxy_port
    
    if [[ -z "$proxy_ip" ]] || [[ -z "$proxy_port" ]]; then
        echo -e "${RED}错误: IP 或端口不能为空！${PLAIN}"
        sleep 2
        return
    fi
    
    echo -e "${YELLOW}1. 测试端口是否开放...${PLAIN}"
    if command -v nc &> /dev/null; then
        if nc -zv $proxy_ip $proxy_port 2>&1 | grep -q "succeeded"; then
            echo -e "${GREEN}✓ 端口 $proxy_port 已开放${PLAIN}"
        else
            echo -e "${RED}✗ 端口 $proxy_port 未开放${PLAIN}"
        fi
    else
        echo -e "${YELLOW}!nc 命令未安装，跳过端口检测${PLAIN}"
    fi
    
    echo -e "${YELLOW}2. 测试 curl 代理连接...${PLAIN}"
    if curl -x http://$proxy_ip:$proxy_port http://httpbin.org/ip -m 5 -s > /dev/null 2>&1; then
        echo -e "${GREEN}✓ curl 代理连接成功${PLAIN}"
    else
        echo -e "${RED}✗ curl 代理连接失败${PLAIN}"
    fi
    
    echo -e "${YELLOW}3. 测试获取真实 IP...${PLAIN}"
    REAL_IP=$(curl -x http://$proxy_ip:$proxy_port http://httpbin.org/ip -m 5 -s 2>/dev/null | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | head -1)
    if [[ -n "$REAL_IP" ]]; then
        echo -e "${GREEN}✓ 代理服务器 IP: ${YELLOW}$REAL_IP${PLAIN}"
    else
        echo -e "${RED}✗ 无法获取代理服务器 IP${PLAIN}"
    fi
    
    sleep 3
}

# 11. 查看当前代理配置
show_proxy_config() {
    clear
    echo -e "=================================="
    echo -e " ${GREEN}当前代理配置${PLAIN}"
    echo -e "=================================="
    echo ""
    
    echo -e "${BLUE}【环境变量】${PLAIN}"
    echo -e "http_proxy: ${YELLOW}${http_proxy:-未设置}${PLAIN}"
    echo -e "https_proxy: ${YELLOW}${https_proxy:-未设置}${PLAIN}"
    echo -e "ftp_proxy: ${YELLOW}${ftp_proxy:-未设置}${PLAIN}"
    echo ""
    
    echo -e "${BLUE}【系统级配置】${PLAIN}"
    if [[ -f /etc/profile ]]; then
        grep "proxy" /etc/profile || echo -e "${YELLOW}未设置${PLAIN}"
    fi
    echo ""
    
    echo -e "${BLUE}【用户级配置】${PLAIN}"
    if [[ -f ~/.bashrc ]]; then
        grep "proxy" ~/.bashrc || echo -e "${YELLOW}未设置${PLAIN}"
    fi
    echo ""
    
    echo -e "${BLUE}【apt-get 配置】${PLAIN}"
    if [[ -f /etc/apt/apt.conf.d/proxy.conf ]]; then
        cat /etc/apt/apt.conf.d/proxy.conf
    else
        echo -e "${YELLOW}未设置${PLAIN}"
    fi
    echo ""
    
    echo -e "${BLUE}【yum 配置】${PLAIN}"
    if [[ -f /etc/yum.conf ]]; then
        grep "proxy=" /etc/yum.conf || echo -e "${YELLOW}未设置${PLAIN}"
    fi
    echo ""
    
    echo -e "${BLUE}【pip 配置】${PLAIN}"
    if [[ -f ~/.pip/pip.conf ]]; then
        cat ~/.pip/pip.conf
    else
        echo -e "${YELLOW}未设置${PLAIN}"
    fi
    echo ""
    
    echo -e "${BLUE}【Git 配置】${PLAIN}"
    git config --global --list | grep proxy || echo -e "${YELLOW}未设置${PLAIN}"
    echo ""
    
    echo -e "=================================="
    read -p "按 Enter 键返回主菜单..."
}

# 12. 取消代理设置
unset_proxy() {
    echo -e "${YELLOW}--- 取消代理设置 ---${PLAIN}"
    
    echo -e "${YELLOW}1. 清除环境变量...${PLAIN}"
    unset http_proxy https_proxy ftp_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY
    echo -e "${GREEN}✓ 环境变量已清除${PLAIN}"
    
    echo -e "${YELLOW}2. 清除系统级代理...${PLAIN}"
    if grep -q "http_proxy" /etc/profile; then
        sed -i '/http_proxy/d' /etc/profile
        sed -i '/https_proxy/d' /etc/profile
        sed -i '/ftp_proxy/d' /etc/profile
        sed -i '/HTTP_PROXY/d' /etc/profile
        sed -i '/HTTPS_PROXY/d' /etc/profile
        sed -i '/FTP_PROXY/d' /etc/profile
        echo -e "${GREEN}✓ 系统级代理已清除${PLAIN}"
    else
        echo -e "${YELLOW}! 系统级代理未设置${PLAIN}"
    fi
    
    echo -e "${YELLOW}3. 清除用户级代理...${PLAIN}"
    if [[ -f ~/.bashrc ]] && grep -q "http_proxy" ~/.bashrc; then
        sed -i '/http_proxy/d' ~/.bashrc
        sed -i '/https_proxy/d' ~/.bashrc
        sed -i '/ftp_proxy/d' ~/.bashrc
        sed -i '/HTTP_PROXY/d' ~/.bashrc
        sed -i '/HTTPS_PROXY/d' ~/.bashrc
        sed -i '/FTP_PROXY/d' ~/.bashrc
        echo -e "${GREEN}✓ 用户级代理已清除${PLAIN}"
    else
        echo -e "${YELLOW}! 用户级代理未设置${PLAIN}"
    fi
    
    echo -e "${YELLOW}4. 清除 Git 代理...${PLAIN}"
    git config --global --unset http.proxy 2>/dev/null
    git config --global --unset https.proxy 2>/dev/null
    echo -e "${GREEN}✓ Git 代理已清除${PLAIN}"
    
    echo -e "${GREEN}✓ 所有代理设置已清除！${PLAIN}"
    sleep 3
}

# 主逻辑
check_root
check_sys

menu