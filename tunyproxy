#!/bin/bash

# ==========================================
# Tinyproxy 一键交互式管理脚本
# 支持系统: CentOS / Debian / Ubuntu
# ==========================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;36m'
PLAIN='\033[0m'

# 配置文件路径
CONF_FILE="/etc/tinyproxy/tinyproxy.conf"

# 检查 Root 权限
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：${PLAIN} 必须使用 root 用户运行此脚本！\n" && exit 1

# 获取本机 IP
get_ip() {
    local ip=$(curl -s ifconfig.me)
    [ -z "$ip" ] && ip=$(curl -s icanhazip.com)
    [ -z "$ip" ] && ip="无法获取"
    echo "$ip"
}

# 安装 Tinyproxy
install_tinyproxy() {
    echo -e "${GREEN}正在检查系统环境...${PLAIN}"
    
    if [ -f /etc/redhat-release ]; then
        # CentOS/RHEL
        yum install -y epel-release
        yum install -y tinyproxy
    elif [ -f /etc/lsb-release ] || [ -f /etc/debian_version ]; then
        # Debian/Ubuntu
        apt-get update
        apt-get install -y tinyproxy
    else
        echo -e "${RED}不支持的操作系统！请使用 CentOS, Debian 或 Ubuntu。${PLAIN}"
        exit 1
    fi

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Tinyproxy 安装成功！${PLAIN}"
        cp $CONF_FILE "${CONF_FILE}.bak_original"
        configure_tinyproxy_interactive
    else
        echo -e "${RED}安装失败，请检查网络连接。${PLAIN}"
    fi
}

# 配置向导
configure_tinyproxy_interactive() {
    echo -e "------------------------------------------------"
    echo -e "${YELLOW}开始配置 Tinyproxy...${PLAIN}"

    # 设置端口
    read -p "请输入代理端口 (默认: 8888): " port
    [[ -z "$port" ]] && port="8888"

    # 设置允许的 IP
    echo -e "------------------------------------------------"
    echo -e "请设置允许连接的 IP 地址："
    echo -e "1. 允许所有 IP (0.0.0.0/0) ${RED}[注意安全]${PLAIN}"
    echo -e "2. 仅允许特定 IP (推荐)"
    read -p "请选择 [1-2] (默认 1): " ip_choice
    [[ -z "$ip_choice" ]] && ip_choice="1"

    # 修改配置文件
    sed -i "s/^Port .*/Port $port/g" $CONF_FILE
    sed -i 's/^Allow /#Allow /g' $CONF_FILE

    if [[ "$ip_choice" == "1" ]]; then
        echo -e "${YELLOW}已设置为：允许所有 IP 访问${PLAIN}"
    else
        read -p "请输入允许的 IP 地址 (例如 1.2.3.4): " user_ip
        if [[ -z "$user_ip" ]]; then
            echo -e "${RED}IP 不能为空！默认切换为允许所有。${PLAIN}"
        else
            echo "Allow $user_ip" >> $CONF_FILE
            echo -e "${YELLOW}已设置为：仅允许 $user_ip 访问${PLAIN}"
        fi
    fi

    open_firewall $port
    systemctl restart tinyproxy
    check_status

    echo -e "------------------------------------------------"
    echo -e "${GREEN}配置完成！${PLAIN}"
    echo -e "公网 IP : ${BLUE}$(get_ip)${PLAIN}"
    echo -e "端口    : ${BLUE}$port${PLAIN}"
    echo -e "------------------------------------------------"
}

# 防火墙放行
open_firewall() {
    local port=$1
    echo -e "${GREEN}正在配置防火墙放行端口 $port ...${PLAIN}"
    if command -v ufw >/dev/null 2>&1; then
        ufw allow $port/tcp
        ufw reload
    elif command -v firewall-cmd >/dev/null 2>&1; then
        firewall-cmd --zone=public --add-port=$port/tcp --permanent
        firewall-cmd --reload
    else
        echo -e "${YELLOW}未检测到 UFW 或 FirewallD，请手动在云服务商安全组放行端口 $port。${PLAIN}"
    fi
}

# 卸载 Tinyproxy
uninstall_tinyproxy() {
    read -p "确定要卸载 Tinyproxy 吗? [y/n]: " confirm
    if [[ "$confirm" == "y" ]]; then
        if [ -f /etc/redhat-release ]; then
            yum remove -y tinyproxy
        else
            apt-get purge -y tinyproxy
        fi
        rm -rf /etc/tinyproxy
        echo -e "${GREEN}Tinyproxy 已卸载。${PLAIN}"
    fi
}

# 检查 Tinyproxy 状态
check_status() {
    if systemctl is-active --quiet tinyproxy; then
        echo -e "运行状态: ${GREEN}正在运行 (Active)${PLAIN}"
    else
        echo -e "运行状态: ${RED}未运行 (Stopped)${PLAIN}"
    fi
}

# 查看日志
view_log() {
    echo -e "${YELLOW}显示最后 20 行日志...${PLAIN}"
    tail -n 20 /var/log/tinyproxy/tinyproxy.log 2>/dev/null || echo -e "${RED}暂无日志或路径不同。${PLAIN}"
}

# 主菜单
show_menu() {
    clear
    echo -e "================================================"
    echo -e "    ${GREEN}Tinyproxy HTTP代理 一键管理脚本${PLAIN}    "
    echo -e "================================================"
    echo -e "  ${GREEN}1.${PLAIN} 安装 Tinyproxy"
    echo -e "  ${GREEN}2.${PLAIN} 修改配置 (端口 / 允许IP)"
    echo -e "  ${GREEN}3.${PLAIN} 启动服务"
    echo -e "  ${GREEN}4.${PLAIN} 停止服务"
    echo -e "  ${GREEN}5.${PLAIN} 重启服务"
    echo -e "  ${GREEN}6.${PLAIN} 查看运行状态"
    echo -e "  ${GREEN}7.${PLAIN} 查看访问日志"
    echo -e "  ${GREEN}8.${PLAIN} 卸载 Tinyproxy"
    echo -e "------------------------------------------------"
    echo -e "  ${GREEN}0.${PLAIN} 退出脚本"
    echo -e "================================================"
    read -p " 请输入数字 [0-8]: " num

    case "$num" in
        1) install_tinyproxy; read -p "按回车继续..." ;;
        2) configure_tinyproxy_interactive; read -p "按回车继续..." ;;
        3) systemctl start tinyproxy && echo -e "${GREEN}已启动${PLAIN}"; read -p "按回车继续..." ;;
        4) systemctl stop tinyproxy && echo -e "${RED}已停止${PLAIN}"; read -p "按回车继续..." ;;
        5) systemctl restart tinyproxy && echo -e "${GREEN}已重启${PLAIN}"; read -p "按回车继续..." ;;
        6) check_status; read -p "按回车继续..." ;;
        7) view_log; read -p "按回车继续..." ;;
        8) uninstall_tinyproxy; read -p "按回车继续..." ;;
        0) exit 0 ;;
        *) echo -e "${RED}请输入正确的数字${PLAIN}"; sleep 1; show_menu ;;
    esac
}

# 循环显示菜单直到退出
while true; do