#!/bin/bash

# 检查是否为 root 用户
if [[ $EUID -ne 0 ]]; then
  echo "请以 root 权限运行此脚本 (sudo 运行即可)。"
  exit 1
fi

echo "====================================="
echo " 🌟 自动检测并翻译语言设置脚本 🌟"
echo "====================================="

# 定义需要遍历的常见路径
SEARCH_PATHS=(
  "/etc"
  "/www"
  "/opt"
)

# 支持的文件类型及对应的处理规则
FILE_EXTENSIONS=("*.json" "*.yaml" "*.yml" "*.conf" "*.ini")

# 遍历并检测需要翻译的文件
for PATH in "${SEARCH_PATHS[@]}"; do
  echo "🔍 正在扫描路径：$PATH"

  for EXT in "${FILE_EXTENSIONS[@]}"; do
    # 查找文件
    FILES=$(find "$PATH" -type f -name "$EXT" 2>/dev/null)

    for FILE in $FILES; do
      echo "⚙️ 检测到文件：$FILE"
      
      if [[ "$FILE" == *.json ]]; then
        # JSON 文件处理
        DETECTION=$(grep '"language": "en"' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/"language": "en"/"language": "zh_CN"/g' "$FILE"
          echo "✅ 翻译完成（JSON）：$FILE"
        fi

      elif [[ "$FILE" == *.yaml || "$FILE" == *.yml ]]; then
        # YAML 文件处理
        DETECTION=$(grep 'language: en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/language: en/language: zh_CN/g' "$FILE"
          echo "✅ 翻译完成（YAML）：$FILE"
        fi

      elif [[ "$FILE" == *.conf || "$FILE" == *.ini ]]; then
        # CONF/INI 文件处理
        DETECTION=$(grep 'lang=en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/lang=en/lang=zh_CN/g' "$FILE"
          echo "✅ 翻译完成（CONF/INI）：$FILE"
        fi

      else
        echo "⚠️ 不支持的文件格式：$FILE"
      fi
    done
  done
done

# 提示用户是否重启服务
read -p "请输入需要重启的服务名（例如 nginx 或 apache2，若不需要重启直接按回车）： " SERVICE_NAME
if [[ -n "$SERVICE_NAME" ]]; then
  systemctl restart "$SERVICE_NAME"
  echo "🎉 服务 $SERVICE_NAME 已重启以应用新配置。"
else
  echo "🎉 翻译完成，未重启服务！"
fi

echo "====================================="
echo "🎉 自动检测与翻译已全部完成！"
echo "====================================="