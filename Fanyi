#!/bin/bash

# 检查是否为 root 用户
if [[ $EUID -ne 0 ]]; then
  echo "请以 root 权限运行此脚本 (sudo 运行即可)。"
  exit 1
fi

echo "====================================="
echo " 🌟 自动安装面板并翻译语言设置 🌟 "
echo "====================================="

# 示例：安装面板的命令（根据具体面板的安装方式替换）
echo "📥 安装面板..."
# 以下命令为示例，替换为您的安装命令
curl -sSO https://example.com/installer.sh && bash installer.sh

# 定义默认扫描路径（根据面板安装路径调整）
PANEL_PATHS=(
  "/www/server/panel"
  "/etc"
  "/opt"
  "/usr/local"
)

# 支持的文件类型
FILE_EXTENSIONS=("*.json" "*.yaml" "*.yml" "*.conf" "*.ini")

echo "🔍 开始自动翻译语言文件..."

# 遍历所有配置路径并处理文件
for SEARCH_PATH in "${PANEL_PATHS[@]}"; do
  echo "🔍 正在扫描路径：$SEARCH_PATH"
  
  for EXT in "${FILE_EXTENSIONS[@]}"; do
    # 查找指定类型的文件
    FILES=$(find "$SEARCH_PATH" -type f -name "$EXT" 2>/dev/null)

    for FILE in $FILES; do
      echo "⚙️ 检测到文件：$FILE"
      
      # 根据文件类型执行翻译
      if [[ "$FILE" == *.json ]]; then
        # JSON 文件处理
        DETECTION=$(grep '"language": "en"' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/"language": "en"/"language": "zh_CN"/g' "$FILE"
          echo "✅ 文件已翻译（JSON）：$FILE"
        fi

      elif [[ "$FILE" == *.yaml || "$FILE" == *.yml ]]; then
        # YAML 文件处理
        DETECTION=$(grep 'language: en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/language: en/language: zh_CN/g' "$FILE"
          echo "✅ 文件已翻译（YAML）：$FILE"
        fi

      elif [[ "$FILE" == *.conf || "$FILE" == *.ini ]]; then
        # CONF/INI 文件处理
        DETECTION=$(grep 'lang=en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/lang=en/lang=zh_CN/g' "$FILE"
          echo "✅ 文件已翻译（CONF/INI）：$FILE"
        fi

      else
        echo "⚠️ 不支持的文件格式：$FILE"
      fi
    done
  done
done

# 是否重启面板服务（假设服务名为 bt）
read -p "是否重启面板服务以应用语言设置？(y/n): " CONFIRM_RESTART
if [[ $CONFIRM_RESTART == "y" ]]; then
  # 示例服务名为 bt，根据实际服务名调整
  systemctl restart bt
  echo "🎉 面板服务已重启！"
else
  echo "🎉 翻译完成，无需重启服务。"
fi

echo "====================================="
echo "🎉 安装与翻译完成！"
echo "====================================="