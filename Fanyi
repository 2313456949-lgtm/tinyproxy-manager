#!/bin/bash

# 检查是否为 root 用户
if [[ $EUID -ne 0 ]]; then
  echo "请以 root 权限运行此脚本 (sudo 运行即可)。"
  exit 1
fi

echo "====================================="
echo " 🌟 自动检测并翻译语言设置脚本 🌟"
echo "====================================="

# 定义默认扫描路径
DEFAULT_PATHS=(
  "/etc"
  "/www"
  "/opt"
  "/usr/local"
  "/home"
)

# 支持的文件类型
FILE_EXTENSIONS=("*.json" "*.yaml" "*.yml" "*.conf" "*.ini")

# 遍历所有路径并处理文件
for SEARCH_PATH in "${DEFAULT_PATHS[@]}"; do
  echo "🔍 正在扫描路径：$SEARCH_PATH"
  
  for EXT in "${FILE_EXTENSIONS[@]}"; do
    # 查找指定类型的文件
    FILES=$(find "$SEARCH_PATH" -type f -name "$EXT" 2>/dev/null)

    for FILE in $FILES; do
      echo "⚙️ 检测到文件：$FILE"
      
      # 根据文件类型执行翻译
      if [[ "$FILE" == *.json ]]; then
        # JSON 文件处理
        DETECTION=$(grep '"language": "en"' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/"language": "en"/"language": "zh_CN"/g' "$FILE"
          echo "✅ 文件已翻译（JSON）：$FILE"
        fi

      elif [[ "$FILE" == *.yaml || "$FILE" == *.yml ]]; then
        # YAML 文件处理
        DETECTION=$(grep 'language: en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/language: en/language: zh_CN/g' "$FILE"
          echo "✅ 文件已翻译（YAML）：$FILE"
        fi

      elif [[ "$FILE" == *.conf || "$FILE" == *.ini ]]; then
        # CONF/INI 文件处理
        DETECTION=$(grep 'lang=en' "$FILE")
        if [[ $DETECTION != "" ]]; then
          sed -i 's/lang=en/lang=zh_CN/g' "$FILE"
          echo "✅ 文件已翻译（CONF/INI）：$FILE"
        fi

      else
        echo "⚠️ 不支持的文件格式：$FILE"
      fi
    done
  done
done

# 是否重启服务
read -p "请输入需要重启的服务名（例如 nginx 或 apache2，若不需要重启直接按回车）： " SERVICE_NAME
if [[ -n "$SERVICE_NAME" ]]; then
  systemctl restart "$SERVICE_NAME"
  echo "🎉 服务 $SERVICE_NAME 已重启以应用新配置。"
else
  echo "🎉 翻译完成，无需重启服务！"
fi

echo "====================================="
echo "🎉 自动检测与翻译操作完成！"
echo "====================================="