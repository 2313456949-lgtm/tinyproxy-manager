#!/bin/bash

# 检查是否为 root 用户
if [[ $EUID -ne 0 ]]; then
  echo "请以 root 权限运行此脚本 (sudo 运行即可)。"
  exit 1
fi

echo "======================================"
echo " 🌟 VPS 面板安装脚本 🌟"
echo "======================================"
echo "支持以下面板安装："
echo "1. Orris 面板 (Orris Panel)"
echo "2. Flux 面板 (Flux Panel)"
echo "======================================"

# 检查是否传入 $do 参数自动选择面板
if [[ -z "$do" ]]; then
  # 无 $do 参数输入则用户手动选择
  read -p "请输入您想安装的面板序号 [1-2]: " PANEL_CHOICE
else
  # 若 $do 参数非空，则按 $do 值自动选择面板
  echo "检测到环境变量 do，值为: $do"
  PANEL_CHOICE="$do"
fi

# 设置面板信息
if [[ "$PANEL_CHOICE" -eq 1 ]]; then
  PANEL_NAME="Orris"
  PANEL_INSTALL_URL="https://orris.example.com/install.sh"    # 替换为真实 Oris 面板安装链接
  LANGUAGE_CONFIG_PATH="/etc/orris/settings.conf"

elif [[ "$PANEL_CHOICE" -eq 2 ]]; then
  PANEL_NAME="Flux"
  PANEL_INSTALL_URL="https://flux.example.com/install.sh"     # 替换为真实 Flux 面板安装链接
  LANGUAGE_CONFIG_PATH="/etc/flux/config.yaml"

else
  echo "无效选择，请重新运行脚本。"
  exit 1
fi

echo "======================================"
echo "即将开始安装 $PANEL_NAME 面板..."
echo "======================================"

# 下载并运行脚本
echo "下载 $PANEL_NAME 安装程序..."
wget -O install.sh "$PANEL_INSTALL_URL" && bash install.sh

if [[ $? -ne 0 ]]; then
  echo "$PANEL_NAME 安装失败，请检查安装链接或网络连接！"
  exit 1
fi

echo "安装成功！即将切换面板语言为简体中文..."
echo "======================================"

# 切换语言到简体中文
if [[ -f "$LANGUAGE_CONFIG_PATH" ]]; then
  if [[ "$PANEL_CHOICE" -eq 1 ]]; then
    sed -i 's/lang=en/lang=zh_CN/g' "$LANGUAGE_CONFIG_PATH"
  elif [[ "$PANEL_CHOICE" -eq 2 ]]; then
    sed -i 's/language: en/language: zh_CN/g' "$LANGUAGE_CONFIG_PATH"
  fi
  echo "面板语言文件已修改为中文！"
else
  echo "语言配置文件未找到，可能需要手动设置。"
fi

# 重启面板以应用设置
if [[ "$PANEL_CHOICE" -eq 1 ]]; then
  systemctl restart orris-panel
elif [[ "$PANEL_CHOICE" -eq 2 ]]; then
  systemctl restart flux-panel
fi

echo "======================================"
echo "🎉 $PANEL_NAME 面板安装完成！"
echo "🎉 并设置为中文！"
echo "======================================"