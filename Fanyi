#!/bin/bash

# æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·
if [[ $EUID -ne 0 ]]; then
  echo "è¯·ä»¥ root æƒé™è¿è¡Œæ­¤è„šæœ¬ (sudo è¿è¡Œå³å¯)ã€‚"
  exit 1
fi

echo "======================================"
echo " ğŸŒŸ VPS é¢æ¿ + Docker è‡ªåŠ¨å®‰è£…è„šæœ¬ ğŸŒŸ"
echo "======================================"
echo "æ”¯æŒä»¥ä¸‹é¢æ¿å®‰è£…ï¼š"
echo "1. Docker è‡ªåŠ¨å®‰è£…"
echo "2. Orris é¢æ¿ (Orris Panel)"
echo "3. Flux é¢æ¿ (Flux Panel)"
echo "======================================"

# æ£€æŸ¥æ˜¯å¦ä¼ å…¥ $do å‚æ•°è‡ªåŠ¨é€‰æ‹©é¢æ¿
if [[ -z "$do" ]]; then
  # æ—  $do å‚æ•°è¾“å…¥åˆ™ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
  read -p "è¯·è¾“å…¥æ‚¨æƒ³å®‰è£…çš„åºå· [1-3]: " PANEL_CHOICE
else
  # è‹¥ $do å‚æ•°éç©ºï¼Œåˆ™æŒ‰ $do å€¼è‡ªåŠ¨é€‰æ‹©é¢æ¿
  echo "æ£€æµ‹åˆ°ç¯å¢ƒå˜é‡ doï¼Œå€¼ä¸º: $do"
  PANEL_CHOICE="$do"
fi

# Docker å®‰è£…å‡½æ•°
install_docker() {
  echo "======================================"
  echo "å¼€å§‹å®‰è£… Docker..."
  echo "======================================"
  # æ›´æ–°åŒ…ç®¡ç†å™¨å¹¶å®‰è£…å¿…éœ€çš„ä¾èµ–
  apt update && apt install -y apt-transport-https ca-certificates curl software-properties-common
  
  # æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  
  # æ·»åŠ  Docker è½¯ä»¶åŒ…ä»“åº“
  echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  
  # å®‰è£… Docker
  apt update && apt install -y docker-ce docker-ce-cli containerd.io
  
  # æ£€æŸ¥ Docker å®‰è£…ç»“æœ
  if [[ $(docker --version) ]]; then
    echo "ğŸ‰ Docker å®‰è£…æˆåŠŸï¼"
  else
    echo "âŒ Docker å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å®‰è£…æ­¥éª¤ï¼"
    exit 1
  fi
}

# é¢æ¿å®‰è£…é€»è¾‘
install_panel() {
  if [[ "$PANEL_CHOICE" -eq 2 ]]; then
    PANEL_NAME="Orris"
    PANEL_INSTALL_URL="https://github.com/OrrisPanel/OrrisInstaller/raw/main/install.sh"
    LANGUAGE_CONFIG_PATH="/etc/orris/settings.conf"
  elif [[ "$PANEL_CHOICE" -eq 3 ]]; then
    PANEL_NAME="Flux"
    PANEL_INSTALL_URL="https://github.com/FluxPanel/FluxInstaller/raw/main/install.sh"
    LANGUAGE_CONFIG_PATH="/etc/flux/config.yaml"
  else
    echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬ã€‚"
    exit 1
  fi
  
  echo "======================================"
  echo "å³å°†å¼€å§‹å®‰è£… $PANEL_NAME é¢æ¿..."
  echo "======================================"

  # ä¸‹è½½å¹¶è¿è¡Œé¢æ¿å®‰è£…è„šæœ¬
  echo "ä¸‹è½½ $PANEL_NAME å®‰è£…ç¨‹åº..."
  wget -O install.sh "$PANEL_INSTALL_URL" && bash install.sh

  if [[ $? -ne 0 ]]; then
    echo "$PANEL_NAME å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®‰è£…é“¾æ¥æˆ–ç½‘ç»œè¿æ¥ï¼"
    exit 1
  fi

  echo "å®‰è£…æˆåŠŸï¼å³å°†åˆ‡æ¢é¢æ¿è¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡..."
  echo "======================================"

  # åˆ‡æ¢è¯­è¨€åˆ°ç®€ä½“ä¸­æ–‡
  if [[ -f "$LANGUAGE_CONFIG_PATH" ]]; then
    if [[ "$PANEL_CHOICE" -eq 2 ]]; then
      sed -i 's/lang=en/lang=zh_CN/g' "$LANGUAGE_CONFIG_PATH"
    elif [[ "$PANEL_CHOICE" -eq 3 ]]; then
      sed -i 's/language: en/language: zh_CN/g' "$LANGUAGE_CONFIG_PATH"
    fi
    echo "é¢æ¿è¯­è¨€æ–‡ä»¶å·²ä¿®æ”¹ä¸ºä¸­æ–‡ï¼"
  else
    echo "è¯­è¨€é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚"
  fi

  # é‡å¯é¢æ¿ä»¥åº”ç”¨è®¾ç½®
  if [[ "$PANEL_CHOICE" -eq 2 ]]; then
    systemctl restart orris-panel
  elif [[ "$PANEL_CHOICE" -eq 3 ]]; then
    systemctl restart flux-panel
  fi

  echo "======================================"
  echo "ğŸ‰ $PANEL_NAME é¢æ¿å®‰è£…å®Œæˆï¼"
  echo "ğŸ‰ å¹¶è®¾ç½®ä¸ºä¸­æ–‡ï¼"
  echo "======================================"
}

# æ ¹æ®ç”¨æˆ·é€‰æ‹©æ‰§è¡Œ
case "$PANEL_CHOICE" in
  1)
    install_docker
    ;;
  2|3)
    install_panel
    ;;
  *)
    echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬ã€‚"
    exit 1
    ;;
esac