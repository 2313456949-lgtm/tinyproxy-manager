#!/bin/bash

# ============================================
# èŠ‚ç‚¹æµé‡ç›‘æ§æ¢é’ˆ - ä¸€é”®å®‰è£…è„šæœ¬
# åŠŸèƒ½ï¼šæœåŠ¡ï¿½ï¿½ï¿½èµ„æºç›‘æ§ + æµé‡ç»Ÿè®¡ + è¿æ¥è¿½è¸ª
# ä½œè€…ï¼šè‡ªåŠ¨ç”Ÿæˆè„šæœ¬
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/node_monitor"
SERVICE_NAME="node_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000

# æ‰“å°æ¨ªå¹…
print_banner() {
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "              èŠ‚ç‚¹æµé‡ç›‘æ§æ¢é’ˆ - è‡ªåŠ¨å®‰è£…ç¨‹åº"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}åŠŸèƒ½ç‰¹æ€§ï¼š${NC}"
    echo "  ğŸ“Š å®æ—¶ CPU/å†…å­˜ç›‘æ§"
    echo "  ğŸ“ˆ æœˆåº¦æµé‡ç»Ÿè®¡ (${MONTHLY_LIMIT_GB}GB é¢åº¦)"
    echo "  ğŸŒ æ´»è·ƒè¿æ¥ IP è¿½è¸ª"
    echo "  ğŸ¨ å“åº”å¼ Web é¢æ¿"
    echo "  ğŸš€ ç³»ç»ŸæœåŠ¡è‡ªå¯åŠ¨"
    echo ""
}

# æ£€æŸ¥æƒé™
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        echo "è¯·ä½¿ç”¨: sudo $0"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿ
detect_system() {
    if [[ -f /etc/debian_version ]]; then
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    elif [[ -f /etc/redhat-release ]]; then
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y"
        INSTALL_CMD="yum install -y"
    else
        echo -e "${YELLOW}è­¦å‘Šï¼šæœªè¯†åˆ«çš„ç³»ç»Ÿï¼Œå°è¯•ä½¿ç”¨ apt${NC}"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    fi
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${YELLOW}[1/5] æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–åŒ…...${NC}"
    
    $UPDATE_CMD
    
    if [[ $PKG_MANAGER == "apt" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl psmisc net-tools
    else
        $INSTALL_CMD python3 python3-pip curl psmisc net-tools
    fi
    
    echo -e "${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºé¡¹ç›®ç»“æ„
create_project() {
    echo -e "${YELLOW}[2/5] åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„...${NC}"
    
    # æ¸…ç†æ—§ç‰ˆæœ¬
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "${YELLOW}å‘ç°æ—§ç‰ˆæœ¬ï¼Œæ­£åœ¨å¤‡ä»½...${NC}"
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    
    mkdir -p "$INSTALL_DIR/templates"
    mkdir -p "$INSTALL_DIR/static"
    cd "$INSTALL_DIR"
    
    echo -e "${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆåç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/5] ç”Ÿæˆåç«¯ç›‘æ§ç¨‹åº...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import subprocess
from datetime import datetime
from flask import Flask, render_template, jsonify
import psutil

app = Flask(__name__)

# å…¨å±€é…ç½®
CONFIG = {
    'MONTHLY_LIMIT_GB': 1000,
    'UPDATE_INTERVAL': 2,
    'MAX_CONNECTIONS': 50
}

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§æ ¸å¿ƒç±»"""
    
    @staticmethod
    def get_cpu_info():
        """è·å– CPU ä¿¡æ¯"""
        return {
            'percent': round(psutil.cpu_percent(interval=1), 1),
            'count': psutil.cpu_count(),
            'freq': round(psutil.cpu_freq().current, 0) if psutil.cpu_freq() else 0
        }
    
    @staticmethod
    def get_memory_info():
        """è·å–å†…å­˜ä¿¡æ¯"""
        memory = psutil.virtual_memory()
        return {
            'percent': round(memory.percent, 1),
            'total': round(memory.total / (1024**3), 2),
            'used': round(memory.used / (1024**3), 2),
            'available': round(memory.available / (1024**3), 2)
        }
    
    @staticmethod
    def get_disk_info():
        """è·å–ç£ç›˜ä¿¡æ¯"""
        try:
            disk = psutil.disk_usage('/')
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2)
            }
        except:
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0}

class NetworkMonitor:
    """ç½‘ç»œç›‘æ§ç±»"""
    
    @staticmethod
    def get_traffic_stats():
        """è·å–ç½‘ç»œæµé‡ç»Ÿè®¡"""
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['MONTHLY_LIMIT_GB']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit
            }
        except Exception as e:
            print(f"æµé‡ç»Ÿè®¡é”™è¯¯: {e}")
            return {'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['MONTHLY_LIMIT_GB']}
    
    @staticmethod
    def get_active_connections():
        """è·å–æ´»è·ƒç½‘ç»œè¿æ¥"""
        connections = {}
        try:
            # ä½¿ç”¨ ss å‘½ä»¤è·å–è¿æ¥ä¿¡æ¯
            cmd = "ss -ntu state established | grep -v '127.0.0.1\\|::1' | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr"
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        count = int(parts[0])
                        ip = parts[1]
                        if ip and ip != '0.0.0.0' and not ip.startswith('127.'):
                            connections[ip] = count
            
            # é™åˆ¶æ˜¾ç¤ºæ•°é‡
            sorted_connections = sorted(connections.items(), key=lambda x: x[1], reverse=True)
            return sorted_connections[:CONFIG['MAX_CONNECTIONS']]
        
        except Exception as e:
            print(f"è¿æ¥ç»Ÿè®¡é”™è¯¯: {e}")
            return []

class SystemInfo:
    """ç³»ç»Ÿä¿¡æ¯ç±»"""
    
    @staticmethod
    def get_system_info():
        """è·å–ç³»ç»ŸåŸºç¡€ä¿¡æ¯"""
        try:
            uptime_cmd = subprocess.run(['uptime', '-p'], capture_output=True, text=True)
            uptime = uptime_cmd.stdout.strip() if uptime_cmd.returncode == 0 else "æœªçŸ¥"
            
            hostname = subprocess.run(['hostname'], capture_output=True, text=True)
            hostname = hostname.stdout.strip() if hostname.returncode == 0 else "æœªçŸ¥"
            
            return {
                'hostname': hostname,
                'uptime': uptime,
                'platform': f"{psutil.platform.system()} {psutil.platform.release()}",
                'boot_time': datetime.fromtimestamp(psutil.boot_time()).strftime('%Y-%m-%d %H:%M:%S'),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
        except Exception as e:
            print(f"ç³»ç»Ÿä¿¡æ¯è·å–é”™è¯¯: {e}")
            return {
                'hostname': 'æœªçŸ¥',
                'uptime': 'æœªçŸ¥',
                'platform': 'æœªçŸ¥',
                'boot_time': 'æœªçŸ¥',
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }

# Flask è·¯ç”±
@app.route('/')
def index():
    """ä¸»é¡µé¢"""
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    """API: è·å–æ‰€æœ‰ç›‘æ§æ•°æ®"""
    try:
        data = {
            'system': SystemInfo.get_system_info(),
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': NetworkMonitor.get_traffic_stats(),
            'connections': NetworkMonitor.get_active_connections(),
            'timestamp': time.time()
        }
        return jsonify(data)
    except Exception as e:
        print(f"API é”™è¯¯: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/config')
def api_config():
    """API: è·å–é…ç½®ä¿¡æ¯"""
    return jsonify(CONFIG)

if __name__ == '__main__':
    print("ğŸš€ èŠ‚ç‚¹ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    print(f"ğŸ“Š Web é¢æ¿åœ°å€: http://0.0.0.0:5000")
    print(f"ğŸ”„ æ•°æ®æ›´æ–°é—´éš”: {CONFIG['UPDATE_INTERVAL']} ç§’")
    print(f"ğŸ“ˆ æœˆæµé‡é™åˆ¶: {CONFIG['MONTHLY_LIMIT_GB']} GB")
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

    chmod +x app.py
    echo -e "${GREEN}âœ“ åç«¯ä»£ç ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆå‰ç«¯ä»£ç 
create_frontend() {
    echo -e "${YELLOW}[4/5] ç”Ÿæˆå‰ç«¯ç›‘æ§é¢æ¿...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚ç‚¹ç›‘æ§æ¢é’ˆ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .status-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 0.9em;
            color: #666;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 1.3em;
        }
        
        .card h3 i {
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .progress-bar {
            background: #ecf0f1;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease, background-color 0.3s ease;
            position: relative;
        }
        
        .progress-fill.low { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .progress-fill.medium { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .progress-fill.high { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        
        .connections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .connections-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
        }
        
        .connections-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-family: 'Courier New', monospace;
        }
        
        .connections-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }
        
        .traffic-warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }
        
        .connections-card {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            body {
                padding: 10px;
            }
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1><i class="fas fa-server"></i> èŠ‚ç‚¹ç›‘æ§æ¢é’ˆ</h1>
            <div class="status-bar">
                <div class="status-item"><i class="fas fa-desktop"></i> <span id="hostname">åŠ è½½ä¸­...</span></div>
                <div class="status-item"><i class="fas fa-clock"></i> <span id="uptime">åŠ è½½ä¸­...</span></div>
                <div class="status-item"><i class="fas fa-calendar"></i> <span id="current-time">åŠ è½½ä¸­...</span></div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- CPU ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-microchip"></i> CPU çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-percent">0%</div>
                        <div class="stat-label">ä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-cores">0</div>
                        <div class="stat-label">æ ¸å¿ƒæ•°</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>CPU è´Ÿè½½</span>
                        <span id="cpu-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cpu-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- å†…å­˜ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-memory"></i> å†…å­˜çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="mem-used">0 GB</div>
                        <div class="stat-label">å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mem-total">0 GB</div>
                        <div class="stat-label">æ€»å®¹é‡</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>å†…å­˜ä½¿ç”¨ç‡</span>
                        <span id="mem-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="mem-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- ç£ç›˜ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-hdd"></i> ç£ç›˜çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="disk-used">0 GB</div>
                        <div class="stat-label">å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="disk-total">0 GB</div>
                        <div class="stat-label">æ€»å®¹é‡</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>ç£ç›˜ä½¿ç”¨ç‡</span>
                        <span id="disk-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="disk-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- æµé‡ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> æµé‡ç»Ÿè®¡</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="traffic-used">0 GB</div>
                        <div class="stat-label">å·²æ¶ˆè€—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="traffic-remaining">0 GB</div>
                        <div class="stat-label">å‰©ä½™é¢åº¦</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>æœˆåº¦æµé‡ (1TB é™é¢)</span>
                        <span id="traffic-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="traffic-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
                <div id="traffic-warning" class="traffic-warning" style="display: none;">
                    <strong>âš ï¸ æµé‡è­¦å‘Šï¼š</strong>æœˆåº¦æµé‡ä½¿ç”¨å·²è¶…è¿‡ 80%ï¼Œè¯·æ³¨æ„æ§åˆ¶ä½¿ç”¨é‡ï¼
                </div>
            </div>
        </div>
        
        <!-- è¿æ¥ç›‘æ§ -->
        <div class="card connections-card">
            <h3><i class="fas fa-network-wired"></i> æ´»è·ƒè¿æ¥ç›‘æ§</h3>
            <table class="connections-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-globe"></i> æ¥æº IP åœ°å€</th>
                        <th><i class="fas fa-link"></i> è¿æ¥æ•°é‡</th>
                        <th><i class="fas fa-chart-bar"></i> è¿æ¥çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="connections-tbody">
                    <tr><td colspan="3" class="loading">æ­£åœ¨åŠ è½½è¿æ¥æ•°æ®...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ç›‘æ§æ•°æ®ç®¡ç†
        const Monitor = {
            config: {
                updateInterval: 2000,
                maxRetries: 3
            },
            
            retryCount: 0,
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress: function(elementId, percent, value) {
                const progressBar = document.getElementById(elementId);
                const label = document.getElementById(elementId.replace('-progress', '-percent-label'));
                
                if (progressBar && label) {
                    progressBar.style.width = percent + '%';
                    label.textContent = percent + '%';
                    
                    // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®é¢œè‰²
                    progressBar.className = 'progress-fill ';
                    if (percent < 60) {
                        progressBar.className += 'low';
                    } else if (percent < 80) {
                        progressBar.className += 'medium';
                    } else {
                        progressBar.className += 'high';
                    }
                }
            },
            
            // æ›´æ–°æ–‡æœ¬å†…å®¹
            updateText: function(elementId, text) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                }
            },
            
            // æ›´æ–°è¿æ¥è¡¨æ ¼
            updateConnections: function(connections) {
                const tbody = document.getElementById('connections-tbody');
                if (!tbody) return;
                
                if (!connections || connections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="no-data"><i class="fas fa-info-circle"></i> å½“å‰æ— å¤–éƒ¨æ´»è·ƒè¿æ¥</td></tr>';
                    return;
                }
                
                let html = '';
                connections.forEach(([ip, count]) => {
                    const statusClass = count > 10 ? 'high' : count > 5 ? 'medium' : 'low';
                    const statusText = count > 10 ? 'é«˜é¢‘' : count > 5 ? 'ä¸­ç­‰' : 'æ­£å¸¸';
                    
                    html += `
                        <tr>
                            <td><i class="fas fa-server"></i> ${ip}</td>
                            <td><span class="badge">${count}</span></td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            },
            
            // è·å–å¹¶æ›´æ–°æ•°æ®
            updateData: function() {
                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    timeout: 10000,
                    success: function(data) {
                        Monitor.retryCount = 0;
                        
                        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                        if (data.system) {
                            Monitor.updateText('hostname', data.system.hostname);
                            Monitor.updateText('uptime', data.system.uptime);
                            Monitor.updateText('current-time', data.system.current_time);
                        }
                        
                        // æ›´æ–° CPU
                        if (data.cpu) {
                            Monitor.updateText('cpu-percent', data.cpu.percent + '%');
                            Monitor.updateText('cpu-cores', data.cpu.count);
                            Monitor.updateProgress('cpu-progress', data.cpu.percent, data.cpu.percent);
                        }
                        
                        // æ›´æ–°å†…å­˜
                        if (data.memory) {
                            Monitor.updateText('mem-used', data.memory.used + ' GB');
                            Monitor.updateText('mem-total', data.memory.total + ' GB');
                            Monitor.updateProgress('mem-progress', data.memory.percent, data.memory.percent);
                        }
                        
                        // æ›´æ–°ç£ç›˜
                        if (data.disk) {
                            Monitor.updateText('disk-used', data.disk.used + ' GB');
                            Monitor.updateText('disk-total', data.disk.total + ' GB');
                            Monitor.updateProgress('disk-progress', data.disk.percent, data.disk.percent);
                        }
                        
                        // æ›´æ–°æµé‡
                        if (data.network) {
                            Monitor.updateText('traffic-used', data.network.total_used + ' GB');
                            Monitor.updateText('traffic-remaining', data.network.remaining + ' GB');
                            Monitor.updateProgress('traffic-progress', data.network.percent, data.network.percent);
                            
                            // æµé‡è­¦å‘Š
                            const warningDiv = document.getElementById('traffic-warning');
                            if (data.network.percent > 80) {
                                warningDiv.style.display = 'block';
                            } else {
                                warningDiv.style.display = 'none';
                            }
                        }
                        
                        // æ›´æ–°è¿æ¥
                        if (data.connections) {
                            Monitor.updateConnections(data.connections);
                        }
                    },
                    
                    error: function(xhr, status, error) {
                        console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                        Monitor.retryCount++;
                        
                        if (Monitor.retryCount >= Monitor.config.maxRetries) {
                            const tbody = document.getElementById('connections-tbody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="3" class="no-data"><i class="fas fa-exclamation-triangle"></i> è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</td></tr>';
                            }
                        }
                    }
                });
            },
            
            // åˆå§‹åŒ–
            init: function() {
                this.updateData();
                setInterval(() => {
                    this.updateData();
                }, this.config.updateInterval);
                
                console.log('ğŸš€ èŠ‚ç‚¹ç›‘æ§æ¢é’ˆå·²å¯åŠ¨');
                console.log('ğŸ“Š æ•°æ®æ›´æ–°é—´éš”:', this.config.updateInterval / 1000, 'ç§’');
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨ç›‘æ§
        $(document).ready(function() {
            Monitor.init();
        });
    </script>
</body>
</html>
EOF

    echo -e "${GREEN}âœ“ å‰ç«¯é¢æ¿ç”Ÿæˆå®Œæˆ${NC}"
}

# å®‰è£… Python ä¾èµ–
install_python_deps() {
    echo -e "${YELLOW}[5/5] å®‰è£… Python ä¾èµ–åº“...${NC}"
    
    # å°è¯•ä¸åŒçš„å®‰è£…æ–¹å¼
    if command -v pip3 &> /dev/null; then
        # å…ˆå°è¯•ç”¨æˆ·å®‰è£…
        pip3 install flask psutil --user 2>/dev/null || \
        # å†å°è¯•ç³»ç»Ÿå®‰è£…
        pip3 install flask psutil --break-system-packages 2>/dev/null || \
        # æœ€åå°è¯•æ™®é€šå®‰è£…
        pip3 install flask psutil
    else
        echo -e "${RED}é”™è¯¯ï¼šæœªæ‰¾åˆ° pip3${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ“ Python ä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºç³»ç»ŸæœåŠ¡
create_service() {
    echo -e "${YELLOW}é…ç½®ç³»ç»ŸæœåŠ¡...${NC}"
    
    cat <<EOF > /etc/systemd/system/${SERVICE_NAME}.service
[Unit]
Description=Node Traffic Monitor Service
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=${INSTALL_DIR}
ExecStart=/usr/bin/python3 ${INSTALL_DIR}/app.py
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=node_monitor

[Install]
WantedBy=multi-user.target
EOF

    # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    systemctl daemon-reload
    systemctl enable ${SERVICE_NAME}
    systemctl stop ${SERVICE_NAME} 2>/dev/null || true
    systemctl start ${SERVICE_NAME}
    
    echo -e "${GREEN}âœ“ ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ${NC}"
}

# è·å–æœåŠ¡å™¨ IP
get_server_ip() {
    # ä¼˜å…ˆè·å–å…¬ç½‘ IP
    PUBLIC_IP=$(curl -s --connect-timeout 5 ifconfig.me 2>/dev/null || curl -s --connect-timeout 5 icanhazip.com 2>/dev/null || echo "")
    
    # è·å–å†…ç½‘ IP
    LOCAL_IP=$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1 || echo "127.0.0.1")
    
    if [[ -n "$PUBLIC_IP" ]]; then
        echo "$PUBLIC_IP"
    else
        echo "$LOCAL_IP"
    fi
}

# æ˜¾ç¤ºå®‰è£…ç»“æœ
show_result() {
    SERVER_IP=$(get_server_ip)
    SERVICE_STATUS=$(systemctl is-active ${SERVICE_NAME})
    
    echo ""
    echo -e "${GREEN}=================================================================="
    echo -e "                    å®‰ è£… å®Œ æˆ ï¼"
    echo -e "==================================================================${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“Š ç›‘æ§é¢æ¿è®¿é—®åœ°å€ï¼š${NC}"
    echo -e "   ğŸŒ å…¬ç½‘è®¿é—®: ${GREEN}http://${SERVER_IP}:${WEB_PORT}${NC}"
    echo -e "   ğŸ  å†…ç½‘è®¿é—®: ${GREEN}http://$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1):${WEB_PORT}${NC}"
    echo ""
    echo -e "${BLUE}ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤ï¼š${NC}"
    echo -e "   å¯åŠ¨æœåŠ¡: ${YELLOW}systemctl start ${SERVICE_NAME}${NC}"
    echo -e "   åœæ­¢æœåŠ¡: ${YELLOW}systemctl stop ${SERVICE_NAME}${NC}"
    echo -e "   é‡å¯æœåŠ¡: ${YELLOW}systemctl restart ${SERVICE_NAME}${NC}"
    echo -e "   æŸ¥çœ‹çŠ¶æ€: ${YELLOW}systemctl status ${SERVICE_NAME}${NC}"
    echo -e "   æŸ¥çœ‹æ—¥å¿—: ${YELLOW}journalctl -u ${SERVICE_NAME} -f${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“ å®‰è£…ç›®å½•ï¼š${NC} ${INSTALL_DIR}"
    echo -e "${BLUE}ğŸš€ æœåŠ¡çŠ¶æ€ï¼š${NC} ${SERVICE_STATUS}"
    echo ""
    
    if [[ "$SERVICE_STATUS" == "active" ]]; then
        echo -e "${GREEN}âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®ç›‘æ§é¢æ¿${NC}"
    else
        echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼šjournalctl -u ${SERVICE_NAME}${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ’¡ æç¤ºï¼š${NC}"
    echo -e "  - å¦‚éœ€ä¿®æ”¹é…ç½®ï¼Œè¯·ç¼–è¾‘ ${INSTALL_DIR}/app.py"
    echo -e "  - å¦‚éœ€å¸è½½ï¼Œè¯·è¿è¡Œ: systemctl stop ${SERVICE_NAME} && rm -rf ${INSTALL_DIR}"
    echo -e "  - é˜²ç«å¢™æ”¾è¡Œç«¯å£: ${WEB_PORT}"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    print_banner
    check_privileges
    detect_system
    install_dependencies
    create_project
    create_backend
    create_frontend
    install_python_deps
    create_service
    show_result
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
