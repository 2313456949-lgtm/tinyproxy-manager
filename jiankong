#!/usr/bin/env bash
# ================================================================
# Komari æœåŠ¡ç«¯ ä¸€é”®å®‰è£…è„šæœ¬
# æ”¯æŒ: Ubuntu / Debian / CentOS / Rocky / Alma / Alpine
# ç”¨æ³•: sudo bash komari-server-install.sh [ç«¯å£]
# ç¤ºä¾‹: sudo bash komari-server-install.sh 25774
# ================================================================
set -e

# â”€â”€ é¢œè‰² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
CYAN='\033[0;36m'; BOLD='\033[1m'; RESET='\033[0m'

info()    { echo -e "${CYAN}[ä¿¡æ¯]${RESET} $*"; }
success() { echo -e "${GREEN}[æˆåŠŸ]${RESET} $*"; }
warn()    { echo -e "${YELLOW}[è­¦å‘Š]${RESET} $*"; }
die()     { echo -e "${RED}[é”™è¯¯]${RESET} $*"; exit 1; }

# â”€â”€ å‚æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PORT="${1:-25774}"
INSTALL_DIR="/opt/komari"
DATA_DIR="$INSTALL_DIR/data"
BIN_PATH="$INSTALL_DIR/komari"
SERVICE="komari"
GITHUB_REPO="komari-monitor/komari"

# â”€â”€ æ£€æŸ¥ root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[[ $EUID -ne 0 ]] && die "è¯·ä»¥ root æˆ– sudo è¿è¡Œæ­¤è„šæœ¬"

# â”€â”€ æ£€æŸ¥ç³»ç»Ÿæ¶æ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ARCH=$(uname -m)
case "$ARCH" in
  x86_64)         ARCH_NAME="amd64"   ;;
  aarch64|arm64)  ARCH_NAME="arm64"   ;;
  armv7l)         ARCH_NAME="armv7"   ;;
  riscv64)        ARCH_NAME="riscv64" ;;
  *)              die "ä¸æ”¯æŒçš„æ¶æ„: $ARCH" ;;
esac
OS="linux"

info "ç³»ç»Ÿæ¶æ„: ${ARCH} â†’ ${ARCH_NAME}"

# â”€â”€ å®‰è£…ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "æ£€æŸ¥å¹¶å®‰è£…ä¾èµ– (curl)..."
if command -v apt-get &>/dev/null; then
    apt-get update -qq && apt-get install -y -qq curl
elif command -v yum &>/dev/null; then
    yum install -y -q curl
elif command -v apk &>/dev/null; then
    apk add --quiet curl
fi

# â”€â”€ è·å–æœ€æ–°ç‰ˆæœ¬å· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "è·å–æœ€æ–°ç‰ˆæœ¬..."
LATEST=$(curl -fsSL "https://api.github.com/repos/${GITHUB_REPO}/releases/latest" \
    | grep '"tag_name"' | head -1 | sed 's/.*"tag_name": *"\(.*\)".*/\1/')
[[ -z "$LATEST" ]] && die "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
success "æœ€æ–°ç‰ˆæœ¬: $LATEST"

# â”€â”€ ä¸‹è½½äºŒè¿›åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mkdir -p "$INSTALL_DIR" "$DATA_DIR"
DOWNLOAD_URL="https://github.com/${GITHUB_REPO}/releases/download/${LATEST}/komari-${OS}-${ARCH_NAME}"
info "ä¸‹è½½ä¸­: $DOWNLOAD_URL"
curl -fsSL "$DOWNLOAD_URL" -o "$BIN_PATH" || die "ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨ä¸‹è½½"
chmod +x "$BIN_PATH"
success "äºŒè¿›åˆ¶å·²ä¸‹è½½è‡³ $BIN_PATH"

# â”€â”€ åˆ›å»º systemd æœåŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "é…ç½® systemd æœåŠ¡..."
cat > "/etc/systemd/system/${SERVICE}.service" << EOF
[Unit]
Description=Komari Server Monitor
Documentation=https://github.com/komari-monitor/komari
After=network.target

[Service]
Type=simple
WorkingDirectory=$INSTALL_DIR
ExecStart=$BIN_PATH server --port $PORT --data-dir $DATA_DIR
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable "$SERVICE" --quiet
systemctl restart "$SERVICE"

# â”€â”€ ç­‰å¾…å¯åŠ¨å¹¶æ•è·åˆå§‹å¯†ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 3

ADMIN_PASS=$(journalctl -u "$SERVICE" --no-pager -n 50 2>/dev/null \
    | grep -oP '(?<=password[: ]+)[A-Za-z0-9@#\$%^&*!_\-]{6,}' \
    | head -1 || true)

# â”€â”€ å†™å…¥å¸è½½è„šæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cat > "$INSTALL_DIR/uninstall.sh" << 'UNEOF'
#!/usr/bin/env bash
echo "[*] æ­£åœ¨å¸è½½ Komari æœåŠ¡ç«¯..."
systemctl stop komari 2>/dev/null || true
systemctl disable komari 2>/dev/null || true
rm -f /etc/systemd/system/komari.service
systemctl daemon-reload
rm -rf /opt/komari
echo "âœ… Komari æœåŠ¡ç«¯å·²å®Œå…¨å¸è½½"
UNEOF
chmod +x "$INSTALL_DIR/uninstall.sh"

# â”€â”€ å®Œæˆæç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${BOLD}${GREEN}â•‘        Komari æœåŠ¡ç«¯å®‰è£…å®Œæˆ ğŸ‰                 â•‘${RESET}"
echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "  ğŸŒ Web é¢æ¿åœ°å€ : ${CYAN}http://$(curl -s ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}'):${PORT}${RESET}"
[[ -n "$ADMIN_PASS" ]] && \
echo -e "  ğŸ”‘ åˆå§‹å¯†ç      : ${YELLOW}${ADMIN_PASS}${RESET}" || \
echo -e "  ğŸ”‘ åˆå§‹å¯†ç      : ${YELLOW}è¯·è¿è¡Œ: journalctl -u komari -n 100 | grep -i pass${RESET}"
echo ""
echo -e "  ğŸ“‹ æŸ¥çœ‹æ—¥å¿—     : ${CYAN}journalctl -u komari -f${RESET}"
echo -e "  ğŸ”„ é‡å¯æœåŠ¡     : ${CYAN}systemctl restart komari${RESET}"
echo -e "  ğŸ—‘ï¸  å¸è½½æœåŠ¡     : ${CYAN}bash /opt/komari/uninstall.sh${RESET}"
echo ""
echo -e "  âš ï¸  ${YELLOW}è¯·ç™»å½•é¢æ¿ â†’ èŠ‚ç‚¹ç®¡ç† â†’ æ·»åŠ èŠ‚ç‚¹ â†’ å¤åˆ¶æ¢é’ˆå®‰è£…å‘½ä»¤${RESET}"
echo ""
