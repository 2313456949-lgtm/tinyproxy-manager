#!/bin/bash

# ============================================
# è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆ - Komari é£æ ¼ç•Œé¢
# åŠŸèƒ½ï¼šå®æ—¶æ˜¾ç¤ºè¿æ¥è®¾å¤‡ + æ–­è¿è‡ªåŠ¨æ¶ˆå¤±
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/device_monitor"
SERVICE_NAME="device_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000

# æ‰“å°æ¨ªå¹…
print_banner() {
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "              è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆ - Komari é£æ ¼"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}åŠŸèƒ½ç‰¹æ€§ï¼š${NC}"
    echo "  ğŸ“± å®æ—¶è¿æ¥è®¾å¤‡æ˜¾ç¤º"
    echo "  ğŸ”Œ æ–­è¿è‡ªåŠ¨ç§»é™¤"
    echo "  ğŸ“Š ç³»ç»Ÿèµ„æºç›‘æ§"
    echo "  ğŸ¨ Komari é£æ ¼ç•Œé¢"
    echo "  ğŸš€ ç³»ç»ŸæœåŠ¡è‡ªå¯åŠ¨"
    echo ""
}

# æ£€æŸ¥æƒé™å’Œç³»ç»Ÿæ£€æµ‹å‡½æ•°ä¿æŒä¸å˜
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        exit 1
    fi
}

detect_system() {
    if [[ -f /etc/debian_version ]]; then
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    elif [[ -f /etc/redhat-release ]]; then
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y"
        INSTALL_CMD="yum install -y"
    else
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    fi
}

install_dependencies() {
    echo -e "${YELLOW}[1/5] å®‰è£…ç³»ç»Ÿä¾èµ–...${NC}"
    $UPDATE_CMD
    if [[ $PKG_MANAGER == "apt" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl psmisc net-tools iproute2 lsof
    else
        $INSTALL_CMD python3 python3-pip curl psmisc net-tools iproute2 lsof
    fi
    echo -e "${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

create_project() {
    echo -e "${YELLOW}[2/5] åˆ›å»ºé¡¹ç›®ç›®å½•...${NC}"
    if [[ -d "$INSTALL_DIR" ]]; then
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    mkdir -p "$INSTALL_DIR/templates"
    cd "$INSTALL_DIR"
    echo -e "${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆ Komari é£æ ¼åç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/5] ç”Ÿæˆè®¾å¤‡ç›‘æ§åç«¯...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import subprocess
import re
from datetime import datetime, timedelta
from flask import Flask, render_template, jsonify
import psutil

app = Flask(__name__)

CONFIG = {
    'MONTHLY_LIMIT_GB': 1000,
    'UPDATE_INTERVAL': 2,
    'CONNECTION_TIMEOUT': 30  # 30ç§’æ— æ´»åŠ¨åˆ™è®¤ä¸ºæ–­è¿
}

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§ç±»"""
    
    @staticmethod
    def get_cpu_info():
        return {
            'percent': round(psutil.cpu_percent(interval=0.1), 1),
            'count': psutil.cpu_count(),
            'freq': round(psutil.cpu_freq().current, 0) if psutil.cpu_freq() else 0
        }
    
    @staticmethod
    def get_memory_info():
        memory = psutil.virtual_memory()
        return {
            'percent': round(memory.percent, 1),
            'total': round(memory.total / (1024**3), 2),
            'used': round(memory.used / (1024**3), 2),
            'available': round(memory.available / (1024**3), 2)
        }
    
    @staticmethod
    def get_disk_info():
        try:
            disk = psutil.disk_usage('/')
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2)
            }
        except:
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0}
    
    @staticmethod
    def get_network_stats():
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['MONTHLY_LIMIT_GB']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit
            }
        except:
            return {'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['MONTHLY_LIMIT_GB']}

class DeviceMonitor:
    """è®¾å¤‡è¿æ¥ç›‘æ§ç±» - ä»¿ x-ui é£æ ¼"""
    
    # å­˜å‚¨è¿æ¥å†å²ï¼Œç”¨äºæ£€æµ‹æ–­è¿
    connection_history = {}
    
    @staticmethod
    def get_device_info_by_ip(ip):
        """é€šè¿‡IPè·å–è®¾å¤‡ä¿¡æ¯"""
        device_info = {
            'ip': ip,
            'hostname': 'Unknown',
            'mac_address': 'Unknown',
            'device_type': 'Unknown',
            'os_type': 'Unknown'
        }
        
        try:
            # å°è¯•åå‘DNSæŸ¥è¯¢è·å–ä¸»æœºå
            try:
                import socket
                hostname = socket.gethostbyaddr(ip)[0]
                device_info['hostname'] = hostname
                
                # æ ¹æ®ä¸»æœºåæ¨æµ‹è®¾å¤‡ç±»å‹
                hostname_lower = hostname.lower()
                if any(x in hostname_lower for x in ['iphone', 'ipad', 'ios']):
                    device_info['device_type'] = 'iOS'
                    device_info['os_type'] = 'iOS'
                elif any(x in hostname_lower for x in ['android', 'xiaomi', 'huawei', 'oppo', 'vivo', 'oneplus']):
                    device_info['device_type'] = 'Android'
                    device_info['os_type'] = 'Android'
                elif any(x in hostname_lower for x in ['windows', 'desktop', 'laptop', 'pc']):
                    device_info['device_type'] = 'Windows'
                    device_info['os_type'] = 'Windows'
                elif any(x in hostname_lower for x in ['mac', 'macbook', 'imac']):
                    device_info['device_type'] = 'macOS'
                    device_info['os_type'] = 'macOS'
                elif any(x in hostname_lower for x in ['linux', 'ubuntu', 'centos']):
                    device_info['device_type'] = 'Linux'
                    device_info['os_type'] = 'Linux'
            except:
                pass
            
            # å°è¯•è·å– MAC åœ°å€
            try:
                arp_cmd = f"arp -n {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $3}}'"
                result = subprocess.run(arp_cmd, shell=True, capture_output=True, text=True, timeout=2)
                if result.returncode == 0 and result.stdout.strip():
                    mac = result.stdout.strip()
                    device_info['mac_address'] = mac
                    
                    # æ ¹æ® MAC åœ°å€å‰ç¼€æ¨æµ‹å‚å•†/è®¾å¤‡ç±»å‹
                    mac_prefixes = {
                        'ac:de:48': 'Apple',
                        '28:cd:c1': 'Apple',
                        'f0:18:98': 'Apple',
                        '3c:28:6d': 'Apple',
                        '40:cb:c0': 'Apple',
                        '28:cf:e9': 'Apple',
                        'dc:37:54': 'Samsung',
                        '28:6a:ba': 'Samsung',
                        '5c:0a:5b': 'Xiaomi',
                        '34:ce:00': 'Xiaomi',
                        '50:8f:4c': 'Huawei',
                        '00:e0:fc': 'Huawei'
                    }
                    
                    mac_prefix = mac[:8].lower()
                    for prefix, vendor in mac_prefixes.items():
                        if mac_prefix.startswith(prefix):
                            if vendor == 'Apple':
                                device_info['device_type'] = 'Apple Device'
                                device_info['os_type'] = 'iOS/macOS'
                            elif vendor in ['Samsung']:
                                device_info['device_type'] = 'Android Phone'
                                device_info['os_type'] = 'Android'
                            elif vendor in ['Xiaomi', 'Huawei']:
                                device_info['device_type'] = 'Android Phone'
                                device_info['os_type'] = 'Android'
                            break
            except:
                pass
                
        except Exception as e:
            print(f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ {ip}: {e}")
        
        return device_info
    
    @staticmethod
    def get_active_connections():
        """è·å–æ´»è·ƒè¿æ¥è®¾å¤‡ - ä»¿ x-ui æ˜¾ç¤ºæ–¹å¼"""
        current_time = time.time()
        active_devices = {}
        
        try:
            # è·å–å½“å‰æ´»è·ƒè¿æ¥
            cmd = """netstat -tn 2>/dev/null | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        count = int(parts[0])
                        ip = parts[1]
                        
                        # è¿‡æ»¤å†…ç½‘å’Œæœ¬åœ°åœ°å€
                        if not (ip.startswith('127.') or ip == '0.0.0.0'):
                            # æ›´æ–°è¿æ¥å†å²
                            DeviceMonitor.connection_history[ip] = {
                                'last_seen': current_time,
                                'connection_count': count,
                                'first_seen': DeviceMonitor.connection_history.get(ip, {}).get('first_seen', current_time)
                            }
            
            # æ¸…ç†è¶…æ—¶çš„è¿æ¥ï¼ˆ30ç§’æ— æ´»åŠ¨ï¼‰
            timeout_threshold = current_time - CONFIG['CONNECTION_TIMEOUT']
            expired_ips = []
            
            for ip, info in DeviceMonitor.connection_history.items():
                if info['last_seen'] < timeout_threshold:
                    expired_ips.append(ip)
            
            for ip in expired_ips:
                del DeviceMonitor.connection_history[ip]
            
            # ç”Ÿæˆå½“å‰æ´»è·ƒè®¾å¤‡åˆ—è¡¨
            for ip, info in DeviceMonitor.connection_history.items():
                device_info = DeviceMonitor.get_device_info_by_ip(ip)
                
                # è®¡ç®—è¿æ¥æ—¶é•¿
                connection_duration = current_time - info['first_seen']
                
                active_devices[ip] = {
                    'ip': ip,
                    'hostname': device_info['hostname'],
                    'device_type': device_info['device_type'],
                    'os_type': device_info['os_type'],
                    'mac_address': device_info['mac_address'],
                    'connection_count': info['connection_count'],
                    'last_seen': info['last_seen'],
                    'connection_duration': int(connection_duration),
                    'status': 'online',
                    'signal_strength': min(100, max(50, 100 - (current_time - info['last_seen']) * 10))  # æ¨¡æ‹Ÿä¿¡å·å¼ºåº¦
                }
            
            return list(active_devices.values())
            
        except Exception as e:
            print(f"è·å–æ´»è·ƒè¿æ¥é”™è¯¯: {e}")
            return []

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    try:
        data = {
            'system': {
                'hostname': subprocess.run(['hostname'], capture_output=True, text=True).stdout.strip(),
                'uptime': subprocess.run(['uptime', '-p'], capture_output=True, text=True).stdout.strip(),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            },
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': SystemMonitor.get_network_stats(),
            'active_devices': DeviceMonitor.get_active_connections(),
            'timestamp': time.time()
        }
        return jsonify(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    print("ğŸš€ è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    print("ğŸ¨ ç•Œé¢é£æ ¼: Komari")
    print("ğŸ“± ç›‘æ§æ¨¡å¼: å®æ—¶è®¾å¤‡è¿æ¥")
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

    chmod +x app.py
    echo -e "${GREEN}âœ“ è®¾å¤‡ç›‘æ§åç«¯ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆ Komari é£æ ¼å‰ç«¯
create_frontend() {
    echo -e "${YELLOW}[4/5] ç”Ÿæˆ Komari é£æ ¼å‰ç«¯...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komari è®¾å¤‡ç›‘æ§</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Komari é£æ ¼æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Komari é£æ ¼å¤´éƒ¨ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .status-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .status-pill {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Komari ç½‘æ ¼å¸ƒå±€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2rem;
            color: white;
        }

        .stat-icon.cpu { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .stat-icon.memory { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .stat-icon.disk { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .stat-icon.network { background: linear-gradient(45deg, #f093fb, #f5576c); }

        .stat-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .stat-subtitle {
            color: #718096;
            font-size: 0.875rem;
        }

        /* Komari é£æ ¼è¿›åº¦æ¡ */
        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f093fb, #f5576c);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
        }

        /* è®¾å¤‡åˆ—è¡¨ - ä»¿ x-ui é£æ ¼ */
        .devices-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .devices-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .devices-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .devices-header i {
            margin-right: 12px;
            color: #667eea;
        }

        .device-count {
            margin-left: auto;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .device-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.5rem;
            color: white;
        }

        .device-avatar.ios { background: linear-gradient(45deg, #007AFF, #5856D6); }
        .device-avatar.android { background: linear-gradient(45deg, #3DDC84, #4285F4); }
        .device-avatar.windows { background: linear-gradient(45deg, #0078D4, #106EBE); }
        .device-avatar.macos { background: linear-gradient(45deg, #007AFF, #A77BF3); }
        .device-avatar.linux { background: linear-gradient(45deg, #FCC624, #E95420); }
        .device-avatar.unknown { background: linear-gradient(45deg, #6C757D, #495057); }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .device-ip {
            color: #718096;
            font-size: 0.875rem;
            font-family: monospace;
        }

        .device-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48BB78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
            animation: pulse 2s infinite;
        }

        .device-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-detail {
            text-align: center;
        }

        .detail-value {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.875rem;
        }

        .detail-label {
            color: #718096;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .no-devices {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .no-devices i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .devices-grid {
                grid-template-columns: 1fr;
            }
            .status-pills {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Komari é£æ ¼å¤´éƒ¨ -->
        <div class="header">
            <h1>Komari Monitor</h1>
            <p style="color: #718096; margin-top: 8px;">å®æ—¶è®¾å¤‡è¿æ¥ç›‘æ§ - æ–­è¿è‡ªåŠ¨æ¶ˆå¤±</p>
            <div class="status-pills">
                <div class="status-pill">
                    <i class="fas fa-server"></i> <span id="hostname">åŠ è½½ä¸­...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-clock"></i> <span id="uptime">åŠ è½½ä¸­...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-calendar"></i> <span id="current-time">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon cpu">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stat-title">CPU ä½¿ç”¨ç‡</div>
                </div>
                <div class="stat-value" id="cpu-percent">0%</div>
                <div class="stat-subtitle"><span id="cpu-cores">0</span> æ ¸å¿ƒ</div>
                <div class="progress-bar">
                    <div id="cpu-progress" class="progress-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon memory">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="stat-title">å†…å­˜ä½¿ç”¨</div>
                </div>
                <div class="stat-value" id="memory-percent">0%</div>
                <div class="stat-subtitle"><span id="memory-used">0</span>GB / <span id="memory-total">0</span>GB</div>
                <div class="progress-bar">
                    <div id="memory-progress" class="progress-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon disk">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="stat-title">ç£ç›˜ä½¿ç”¨</div>
                </div>
                <div class="stat-value" id="disk-percent">0%</div>
                <div class="stat-subtitle"><span id="disk-used">0</span>GB / <span id="disk-total">0</span>GB</div>
                <div class="progress-bar">
                    <div id="disk-progress" class="progress-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon network">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="stat-title">ç½‘ç»œæµé‡</div>
                </div>
                <div class="stat-value" id="network-total">0 GB</div>
                <div class="stat-subtitle">â†‘<span id="network-sent">0</span>GB â†“<span id="network-received">0</span>GB</div>
                <div class="progress-bar">
                    <div id="network-progress" class="progress-fill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡è¿æ¥åˆ—è¡¨ -->
        <div class="devices-section">
            <div class="devices-header">
                <h2><i class="fas fa-mobile-alt"></i> è¿æ¥è®¾å¤‡</h2>
                <div class="device-count" id="device-count">0 å°è®¾å¤‡</div>
            </div>
            <div class="devices-grid" id="devices-grid">
                <div class="no-devices">
                    <i class="fas fa-wifi"></i>
                    <div>æš‚æ— è®¾å¤‡è¿æ¥</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const KomariMonitor = {
            updateInterval: 2000,
            
            updateText(id, text) {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            },
            
            updateProgress(id, percent) {
                const element = document.getElementById(id);
                if (element) {
                    element.style.width = percent + '%';
                    element.className = 'progress-fill';
                    if (percent > 80) element.classList.add('danger');
                    else if (percent > 60) element.classList.add('warning');
                }
            },
            
            getDeviceIcon(osType) {
                const icons = {
                    'iOS': 'fab fa-apple',
                    'macOS': 'fab fa-apple',
                    'Android': 'fab fa-android',
                    'Windows': 'fab fa-windows',
                    'Linux': 'fab fa-linux'
                };
                return icons[osType] || 'fas fa-desktop';
            },
            
            getDeviceClass(osType) {
                const classes = {
                    'iOS': 'ios',
                    'macOS': 'macos', 
                    'Android': 'android',
                    'Windows': 'windows',
                    'Linux': 'linux'
                };
                return classes[osType] || 'unknown';
            },
            
            formatDuration(seconds) {
                if (seconds < 60) return `${seconds}ç§’`;
                if (seconds < 3600) return `${Math.floor(seconds/60)}åˆ†é’Ÿ`;
                return `${Math.floor(seconds/3600)}å°æ—¶`;
            },
            
            updateDevices(devices) {
                const grid = document.getElementById('devices-grid');
                const count = document.getElementById('device-count');
                
                count.textContent = `${devices.length} å°è®¾å¤‡`;
                
                if (devices.length === 0) {
                    grid.innerHTML = `
                        <div class="no-devices">
                            <i class="fas fa-wifi"></i>
                            <div>æš‚æ— è®¾å¤‡è¿æ¥</div>
                        </div>
                    `;
                    return;
                }
                
                const html = devices.map(device => `
                    <div class="device-card">
                        <div class="device-status"></div>
                        <div class="device-header">
                            <div class="device-avatar ${this.getDeviceClass(device.os_type)}">
                                <i class="${this.getDeviceIcon(device.os_type)}"></i>
                            </div>
                            <div class="device-info">
                                <div class="device-name">${device.hostname !== 'Unknown' ? device.hostname : device.device_type}</div>
                                <div class="device-ip">${device.ip}</div>
                            </div>
                        </div>
                        <div class="device-details">
                            <div class="device-detail">
                                <div class="detail-value">${device.connection_count}</div>
                                <div class="detail-label">è¿æ¥æ•°</div>
                            </div>
                            <div class="device-detail">
                                <div class="detail-value">${this.formatDuration(device.connection_duration)}</div>
                                <div class="detail-label">è¿æ¥æ—¶é•¿</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                grid.innerHTML = html;
            },
            
            updateData() {
                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    timeout: 10000,
                    success: (data) => {
                        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                        if (data.system) {
                            this.updateText('hostname', data.system.hostname);
                            this.updateText('uptime', data.system.uptime);
                            this.updateText('current-time', data.system.current_time);
                        }
                        
                        // æ›´æ–° CPU
                        if (data.cpu) {
                            this.updateText('cpu-percent', data.cpu.percent + '%');
                            this.updateText('cpu-cores', data.cpu.count);
                            this.updateProgress('cpu-progress', data.cpu.percent);
                        }
                        
                        // æ›´æ–°å†…å­˜
                        if (data.memory) {
                            this.updateText('memory-percent', data.memory.percent + '%');
                            this.updateText('memory-used', data.memory.used);
                            this.updateText('memory-total', data.memory.total);
                            this.updateProgress('memory-progress', data.memory.percent);
                        }
                        
                        // æ›´æ–°ç£ç›˜
                        if (data.disk) {
                            this.updateText('disk-percent', data.disk.percent + '%');
                            this.updateText('disk-used', data.disk.used);
                            this.updateText('disk-total', data.disk.total);
                            this.updateProgress('disk-progress', data.disk.percent);
                        }
                        
                        // æ›´æ–°ç½‘ç»œ
                        if (data.network) {
                            this.updateText('network-total', data.network.total_used + ' GB');
                            this.updateText('network-sent', data.network.sent);
                            this.updateText('network-received', data.network.received);
                            this.updateProgress('network-progress', data.network.percent);
                        }
                        
                        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
                        if (data.active_devices) {
                            this.updateDevices(data.active_devices);
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                    }
                });
            },
            
            init() {
                this.updateData();
                setInterval(() => this.updateData(), this.updateInterval);
                console.log('ğŸ¨ Komari ç›‘æ§é¢æ¿å·²å¯åŠ¨');
            }
        };
        
        $(document).ready(() => KomariMonitor.init());
    </script>
</body>
</html>
EOF

    echo -e "${GREEN}âœ“ Komari é£æ ¼å‰ç«¯ç”Ÿæˆå®Œæˆ${NC}"
}

install_python_deps() {
    echo -e "${YELLOW}[5/5] å®‰è£… Python ä¾èµ–...${NC}"
    pip3 install flask psutil --user 2>/dev/null || \
    pip3 install flask psutil --break-system-packages 2>/dev/null || \
    pip3 install flask psutil
    echo -e "${GREEN}âœ“ Python ä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

create_service() {
    echo -e "${YELLOW}é…ç½®ç³»ç»ŸæœåŠ¡...${NC}"
    
    cat <<EOF > /etc/systemd/system/${SERVICE_NAME}.service
[Unit]
Description=Komari Device Monitor Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=${INSTALL_DIR}
ExecStart=/usr/bin/python3 ${INSTALL_DIR}/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable ${SERVICE_NAME}
    systemctl restart ${SERVICE_NAME}
    echo -e "${GREEN}âœ“ ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ${NC}"
}

get_server_ip() {
    PUBLIC_IP=$(curl -s --connect-timeout 5 ifconfig.me 2>/dev/null || echo "")
    LOCAL_IP=$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1 || echo "127.0.0.1")
    echo "${PUBLIC_IP:-$LOCAL_IP}"
}

show_result() {
    SERVER_IP=$(get_server_ip)
    SERVICE_STATUS=$(systemctl is-active ${SERVICE_NAME})
    
    echo ""
    echo -e "${GREEN}=================================================================="
    echo -e "                 Komari è®¾å¤‡ç›‘æ§æ¢é’ˆå®‰è£…å®Œæˆï¼"
    echo -e "==================================================================${NC}"
    echo ""
    echo -e "${BLUE}ğŸ¨ ç›‘æ§é¢æ¿è®¿é—®åœ°å€ï¼š${NC}"
    echo -e "   ğŸŒ ${GREEN}http://${SERVER_IP}:${WEB_PORT}${NC}"
    echo ""
    echo -e "${YELLOW}âœ¨ Komari é£æ ¼ç‰¹æ€§ï¼š${NC}"
    echo -e "   ğŸ“± å®æ—¶æ˜¾ç¤ºè¿æ¥è®¾å¤‡"
    echo -e "   ğŸ”„ æ–­è¿è‡ªåŠ¨æ¶ˆå¤± (30ç§’è¶…æ—¶)"
    echo -e "   ğŸ¯ è®¾å¤‡ç±»å‹è¯†åˆ« (iOS/Android/Windows/macOS)"
    echo -e "   ğŸ’« æµç•…åŠ¨ç”»æ•ˆæœ"
    echo ""
    echo -e "${BLUE}ğŸš€ æœåŠ¡çŠ¶æ€ï¼š${NC} ${SERVICE_STATUS}"
    echo ""
}

main() {
    print_banner
    check_privileges
    detect_system
    install_dependencies
    create_project
    create_backend
    create_frontend
    install_python_deps
    create_service
    show_result
}

main "$@"
