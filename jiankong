#!/bin/bash

# ============================================
# å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆ - ç›‘æ§æœ¬æœåŠ¡å™¨å¯¹å¤–è¿æ¥
# åŠŸèƒ½ï¼šæœåŠ¡å™¨èµ„æºç›‘æ§ + å‡ºç«™è¿æ¥è¿½è¸ª + æµé‡ç»Ÿè®¡
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/outbound_monitor"
SERVICE_NAME="outbound_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000

# æ‰“å°æ¨ªå¹…
print_banner() {
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "              å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆ - è‡ªåŠ¨å®‰è£…ç¨‹åº"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}åŠŸèƒ½ç‰¹æ€§ï¼š${NC}"
    echo "  ğŸ“Š å®æ—¶ CPU/å†…å­˜ç›‘æ§"
    echo "  ğŸ“ˆ æœˆåº¦æµé‡ç»Ÿè®¡ (${MONTHLY_LIMIT_GB}GB é¢åº¦)"
    echo "  ğŸŒ å‡ºç«™è¿æ¥ç›®æ ‡ IP è¿½è¸ª"
    echo "  ğŸ”— ä»£ç†/éš§é“è¿æ¥ç›‘æ§"
    echo "  ğŸ¨ å“åº”å¼ Web é¢æ¿"
    echo "  ğŸš€ ç³»ç»ŸæœåŠ¡è‡ªå¯åŠ¨"
    echo ""
}

# æ£€æŸ¥æƒé™
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        echo "è¯·ä½¿ç”¨: sudo $0"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿ
detect_system() {
    if [[ -f /etc/debian_version ]]; then
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    elif [[ -f /etc/redhat-release ]]; then
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y"
        INSTALL_CMD="yum install -y"
    else
        echo -e "${YELLOW}è­¦å‘Šï¼šæœªè¯†åˆ«çš„ç³»ç»Ÿï¼Œå°è¯•ä½¿ç”¨ apt${NC}"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    fi
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${YELLOW}[1/5] æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–åŒ…...${NC}"
    
    $UPDATE_CMD
    
    if [[ $PKG_MANAGER == "apt" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl psmisc net-tools iproute2 lsof
    else
        $INSTALL_CMD python3 python3-pip curl psmisc net-tools iproute2 lsof
    fi
    
    echo -e "${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºé¡¹ç›®ç»“æ„
create_project() {
    echo -e "${YELLOW}[2/5] åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„...${NC}"
    
    # æ¸…ç†æ—§ç‰ˆæœ¬
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "${YELLOW}å‘ç°æ—§ç‰ˆæœ¬ï¼Œæ­£åœ¨å¤‡ä»½...${NC}"
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    
    mkdir -p "$INSTALL_DIR/templates"
    mkdir -p "$INSTALL_DIR/static"
    cd "$INSTALL_DIR"
    
    echo -e "${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆåç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/5] ç”Ÿæˆå‡ºç«™è¿æ¥ç›‘æ§ç¨‹åº...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import subprocess
import re
from datetime import datetime
from flask import Flask, render_template, jsonify
import psutil

app = Flask(__name__)

# å…¨å±€é…ç½®
CONFIG = {
    'MONTHLY_LIMIT_GB': 1000,
    'UPDATE_INTERVAL': 2,
    'MAX_CONNECTIONS': 50
}

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§æ ¸å¿ƒç±»"""
    
    @staticmethod
    def get_cpu_info():
        """è·å– CPU ä¿¡æ¯"""
        return {
            'percent': round(psutil.cpu_percent(interval=1), 1),
            'count': psutil.cpu_count(),
            'freq': round(psutil.cpu_freq().current, 0) if psutil.cpu_freq() else 0
        }
    
    @staticmethod
    def get_memory_info():
        """è·å–å†…å­˜ä¿¡æ¯"""
        memory = psutil.virtual_memory()
        return {
            'percent': round(memory.percent, 1),
            'total': round(memory.total / (1024**3), 2),
            'used': round(memory.used / (1024**3), 2),
            'available': round(memory.available / (1024**3), 2)
        }
    
    @staticmethod
    def get_disk_info():
        """è·å–ç£ç›˜ä¿¡æ¯"""
        try:
            disk = psutil.disk_usage('/')
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2)
            }
        except:
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0}

class OutboundMonitor:
    """å‡ºç«™è¿æ¥ç›‘æ§ç±» - é‡ç‚¹åŠŸèƒ½"""
    
    @staticmethod
    def get_traffic_stats():
        """è·å–ç½‘ç»œæµé‡ç»Ÿè®¡"""
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['MONTHLY_LIMIT_GB']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit
            }
        except Exception as e:
            print(f"æµé‡ç»Ÿè®¡é”™è¯¯: {e}")
            return {'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['MONTHLY_LIMIT_GB']}
    
    @staticmethod
    def get_outbound_connections():
        """è·å–å‡ºç«™è¿æ¥ - æ ¸å¿ƒåŠŸèƒ½"""
        connections = {}
        connection_details = []
        
        try:
            # æ–¹æ³•1: ä½¿ç”¨ ss å‘½ä»¤è·å–å‡ºç«™è¿æ¥
            cmd = """ss -tuln state established | grep -E ':[0-9]+.*[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:' | awk '{
                split($5, local, ":");
                split($6, remote, ":");
                if (local[1] != "127.0.0.1" && local[1] != "::1" && remote[1] != "127.0.0.1" && remote[1] != "::1") {
                    print $1, local[1] ":" local[2], remote[1] ":" remote[2]
                }
            }'"""
            
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 3:
                        protocol = parts[0]
                        local_addr = parts[1]
                        remote_addr = parts[2]
                        
                        # æå–è¿œç¨‹IP
                        remote_ip = remote_addr.split(':')[0] if ':' in remote_addr else remote_addr
                        remote_port = remote_addr.split(':')[1] if ':' in remote_addr else 'unknown'
                        
                        # è¿‡æ»¤æœ¬åœ°åœ°å€
                        if not (remote_ip.startswith('127.') or remote_ip.startswith('192.168.') or 
                               remote_ip.startswith('10.') or remote_ip.startswith('172.16.') or
                               remote_ip == '::1' or remote_ip == '0.0.0.0'):
                            
                            if remote_ip in connections:
                                connections[remote_ip] += 1
                            else:
                                connections[remote_ip] = 1
                            
                            # æ·»åŠ è¯¦ç»†ä¿¡æ¯
                            connection_details.append({
                                'protocol': protocol,
                                'local': local_addr,
                                'remote': remote_addr,
                                'remote_ip': remote_ip,
                                'remote_port': remote_port
                            })
            
            # æ–¹æ³•2: ä½¿ç”¨ netstat ä½œä¸ºå¤‡é€‰ (å¦‚æœ ss æ²¡æœ‰ç»“æœ)
            if not connections:
                cmd2 = "netstat -tn | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | sort | uniq -c"
                try:
                    result2 = subprocess.run(cmd2, shell=True, capture_output=True, text=True, timeout=5)
                    for line in result2.stdout.strip().split('\n'):
                        if line.strip():
                            parts = line.strip().split()
                            if len(parts) >= 2:
                                count = int(parts[0])
                                ip = parts[1]
                                if not (ip.startswith('192.168.') or ip.startswith('10.') or 
                                       ip.startswith('172.16.') or ip.startswith('127.')):
                                    connections[ip] = count
                except:
                    pass
            
            # é™åˆ¶æ˜¾ç¤ºæ•°é‡å¹¶æ’åº
            sorted_connections = sorted(connections.items(), key=lambda x: x[1], reverse=True)
            return sorted_connections[:CONFIG['MAX_CONNECTIONS']], connection_details[:CONFIG['MAX_CONNECTIONS']]
        
        except Exception as e:
            print(f"å‡ºç«™è¿æ¥ç»Ÿè®¡é”™è¯¯: {e}")
            return [], []
    
    @staticmethod
    def get_proxy_connections():
        """æ£€æµ‹ä»£ç†/éš§é“è¿æ¥"""
        proxy_info = {
            'shadowsocks': [],
            'v2ray': [],
            'trojan': [],
            'wireguard': [],
            'openvpn': [],
            'other_proxy': []
        }
        
        try:
            # æ£€æµ‹å¸¸è§ä»£ç†ç«¯å£çš„è¿æ¥
            proxy_ports = {
                'shadowsocks': [1080, 1081, 8080, 8081, 8388, 8389],
                'v2ray': [10086, 8080, 443, 80, 10001, 10002],
                'trojan': [443, 8443, 10443],
                'wireguard': [51820, 51821],
                'openvpn': [1194, 1195, 443]
            }
            
            # ä½¿ç”¨ lsof æ£€æµ‹ç«¯å£ä½¿ç”¨æƒ…å†µ
            for proxy_type, ports in proxy_ports.items():
                for port in ports:
                    try:
                        cmd = f"lsof -i :{port} -t 2>/dev/null"
                        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
                        if result.returncode == 0 and result.stdout.strip():
                            proxy_info[proxy_type].append({
                                'port': port,
                                'pid': result.stdout.strip().split('\n')[0],
                                'status': 'active'
                            })
                    except:
                        continue
            
            return proxy_info
        
        except Exception as e:
            print(f"ä»£ç†è¿æ¥æ£€æµ‹é”™è¯¯: {e}")
            return proxy_info
    
    @staticmethod
    def get_network_interfaces():
        """è·å–ç½‘ç»œæ¥å£ä¿¡æ¯"""
        interfaces = []
        try:
            for interface, addrs in psutil.net_if_addrs().items():
                if interface != 'lo':  # æ’é™¤å›ç¯æ¥å£
                    interface_info = {'name': interface, 'addresses': []}
                    for addr in addrs:
                        if addr.family == 2:  # IPv4
                            interface_info['addresses'].append({
                                'type': 'IPv4',
                                'address': addr.address,
                                'netmask': addr.netmask
                            })
                        elif addr.family == 10:  # IPv6
                            interface_info['addresses'].append({
                                'type': 'IPv6', 
                                'address': addr.address
                            })
                    if interface_info['addresses']:
                        interfaces.append(interface_info)
            return interfaces
        except Exception as e:
            print(f"ç½‘ç»œæ¥å£è·å–é”™è¯¯: {e}")
            return []

class SystemInfo:
    """ç³»ç»Ÿä¿¡æ¯ç±»"""
    
    @staticmethod
    def get_system_info():
        """è·å–ç³»ç»ŸåŸºç¡€ä¿¡æ¯"""
        try:
            uptime_cmd = subprocess.run(['uptime', '-p'], capture_output=True, text=True)
            uptime = uptime_cmd.stdout.strip() if uptime_cmd.returncode == 0 else "æœªçŸ¥"
            
            hostname = subprocess.run(['hostname'], capture_output=True, text=True)
            hostname = hostname.stdout.strip() if hostname.returncode == 0 else "æœªçŸ¥"
            
            return {
                'hostname': hostname,
                'uptime': uptime,
                'platform': f"{psutil.platform.system()} {psutil.platform.release()}",
                'boot_time': datetime.fromtimestamp(psutil.boot_time()).strftime('%Y-%m-%d %H:%M:%S'),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
        except Exception as e:
            print(f"ç³»ç»Ÿä¿¡æ¯è·å–é”™è¯¯: {e}")
            return {
                'hostname': 'æœªçŸ¥',
                'uptime': 'æœªçŸ¥', 
                'platform': 'æœªçŸ¥',
                'boot_time': 'æœªçŸ¥',
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }

# Flask è·¯ç”±
@app.route('/')
def index():
    """ä¸»é¡µé¢"""
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    """API: è·å–æ‰€æœ‰ç›‘æ§æ•°æ®"""
    try:
        outbound_connections, connection_details = OutboundMonitor.get_outbound_connections()
        
        data = {
            'system': SystemInfo.get_system_info(),
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': OutboundMonitor.get_traffic_stats(),
            'outbound_connections': outbound_connections,
            'connection_details': connection_details,
            'proxy_info': OutboundMonitor.get_proxy_connections(),
            'interfaces': OutboundMonitor.get_network_interfaces(),
            'timestamp': time.time()
        }
        return jsonify(data)
    except Exception as e:
        print(f"API é”™è¯¯: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/config')
def api_config():
    """API: è·å–é…ç½®ä¿¡æ¯"""
    return jsonify(CONFIG)

if __name__ == '__main__':
    print("ğŸš€ å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    print(f"ğŸ“Š Web é¢æ¿åœ°å€: http://0.0.0.0:5000")
    print(f"ğŸ”„ æ•°æ®æ›´æ–°é—´éš”: {CONFIG['UPDATE_INTERVAL']} ç§’")
    print(f"ğŸ“ˆ æœˆæµé‡é™åˆ¶: {CONFIG['MONTHLY_LIMIT_GB']} GB")
    print(f"ğŸŒ ç›‘æ§æ¨¡å¼: å‡ºç«™è¿æ¥è¿½è¸ª")
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

    chmod +x app.py
    echo -e "${GREEN}âœ“ å‡ºç«™è¿æ¥ç›‘æ§åç«¯ä»£ç ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆå‰ç«¯ä»£ç 
create_frontend() {
    echo -e "${YELLOW}[4/5] ç”Ÿæˆå‡ºç«™è¿æ¥ç›‘æ§é¢æ¿...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .header .subtitle {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .status-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 0.9em;
            color: #666;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 1.3em;
        }
        
        .card h3 i {
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .progress-bar {
            background: #ecf0f1;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease, background-color 0.3s ease;
        }
        
        .progress-fill.low { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .progress-fill.medium { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .progress-fill.high { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        
        .connections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .connections-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }
        
        .connections-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-family: 'Courier New', monospace;
        }
        
        .connections-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .badge.proxy {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }
        
        .badge.normal {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .no-data {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }
        
        .outbound-card {
            grid-column: 1 / -1;
        }
        
        .proxy-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .proxy-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .proxy-item.active {
            border-left-color: #e74c3c;
            background: #fff3cd;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            body {
                padding: 10px;
            }
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .outbound-highlight {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
            color: white !important;
        }

        .connection-detail {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1><i class="fas fa-satellite-dish"></i> å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆ</h1>
            <div class="subtitle">ğŸ¯ ç›‘æ§æœ¬æœåŠ¡å™¨å¯¹å¤–å‘èµ·çš„æ‰€æœ‰è¿æ¥</div>
            <div class="status-bar">
                <div class="status-item"><i class="fas fa-desktop"></i> <span id="hostname">åŠ è½½ä¸­...</span></div>
                <div class="status-item"><i class="fas fa-clock"></i> <span id="uptime">åŠ è½½ä¸­...</span></div>
                <div class="status-item"><i class="fas fa-calendar"></i> <span id="current-time">åŠ è½½ä¸­...</span></div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- CPU ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-microchip"></i> CPU çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-percent">0%</div>
                        <div class="stat-label">ä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-cores">0</div>
                        <div class="stat-label">æ ¸å¿ƒæ•°</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>CPU è´Ÿè½½</span>
                        <span id="cpu-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cpu-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- å†…å­˜ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-memory"></i> å†…å­˜çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="mem-used">0 GB</div>
                        <div class="stat-label">å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mem-total">0 GB</div>
                        <div class="stat-label">æ€»å®¹é‡</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>å†…å­˜ä½¿ç”¨ç‡</span>
                        <span id="mem-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="mem-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- ç£ç›˜ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-hdd"></i> ç£ç›˜çŠ¶æ€</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="disk-used">0 GB</div>
                        <div class="stat-label">å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="disk-total">0 GB</div>
                        <div class="stat-label">æ€»å®¹é‡</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>ç£ç›˜ä½¿ç”¨ç‡</span>
                        <span id="disk-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="disk-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- æµé‡ç›‘æ§ -->
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> æµé‡ç»Ÿè®¡</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="traffic-sent">0 GB</div>
                        <div class="stat-label">ä¸Šä¼ æµé‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="traffic-received">0 GB</div>
                        <div class="stat-label">ä¸‹è½½æµé‡</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>æœˆåº¦æµé‡ (1TB é™é¢)</span>
                        <span id="traffic-percent-label">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="traffic-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä»£ç†çŠ¶æ€ç›‘æ§ -->
        <div class="card">
            <h3><i class="fas fa-shield-alt"></i> ä»£ç†/éš§ï¿½ï¿½ï¿½çŠ¶æ€ç›‘æ§</h3>
            <div class="proxy-info" id="proxy-info">
                <div class="loading">æ­£åœ¨æ£€æµ‹ä»£ç†æœåŠ¡...</div>
            </div>
        </div>
        
        <!-- å‡ºç«™è¿æ¥ç›‘æ§ -->
        <div class="card outbound-card">
            <h3><i class="fas fa-globe-americas outbound-highlight"></i> å‡ºç«™è¿æ¥ç›‘æ§ (æœ¬æœåŠ¡å™¨â†’å¤–éƒ¨)</h3>
            <p style="color: #e74c3c; font-weight: bold; margin-bottom: 15px;">
                <i class="fas fa-info-circle"></i> æ˜¾ç¤ºæœ¬æœåŠ¡å™¨ä¸»åŠ¨è¿æ¥åˆ°çš„å¤–éƒ¨IPåœ°å€
            </p>
            <table class="connections-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-globe"></i> ç›®æ ‡ IP åœ°å€</th>
                        <th><i class="fas fa-link"></i> è¿æ¥æ•°é‡</th>
                        <th><i class="fas fa-chart-bar"></i> è¿æ¥ç±»å‹</th>
                        <th><i class="fas fa-info-circle"></i> è¯¦ç»†ä¿¡æ¯</th>
                    </tr>
                </thead>
                <tbody id="outbound-tbody">
                    <tr><td colspan="4" class="loading">æ­£åœ¨æ‰«æå‡ºç«™è¿æ¥...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // å‡ºç«™è¿æ¥ç›‘æ§ç®¡ç†
        const OutboundMonitor = {
            config: {
                updateInterval: 2000,
                maxRetries: 3
            },
            
            retryCount: 0,
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress: function(elementId, percent, value) {
                const progressBar = document.getElementById(elementId);
                const label = document.getElementById(elementId.replace('-progress', '-percent-label'));
                
                if (progressBar && label) {
                    progressBar.style.width = percent + '%';
                    label.textContent = percent + '%';
                    
                    // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®é¢œè‰²
                    progressBar.className = 'progress-fill ';
                    if (percent < 60) {
                        progressBar.className += 'low';
                    } else if (percent < 80) {
                        progressBar.className += 'medium';
                    } else {
                        progressBar.className += 'high';
                    }
                }
            },
            
            // æ›´æ–°æ–‡æœ¬å†…å®¹
            updateText: function(elementId, text) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                }
            },
            
            // æ›´æ–°ä»£ç†ä¿¡æ¯
            updateProxyInfo: function(proxyInfo) {
                const container = document.getElementById('proxy-info');
                if (!container) return;
                
                let html = '';
                let hasActive = false;
                
                for (const [proxyType, instances] of Object.entries(proxyInfo)) {
                    if (instances && instances.length > 0) {
                        hasActive = true;
                        html += `
                            <div class="proxy-item active">
                                <strong><i class="fas fa-shield-alt"></i> ${proxyType.toUpperCase()}</strong><br>
                                ç«¯å£: ${instances.map(i => i.port).join(', ')}<br>
                                <span class="badge proxy">è¿è¡Œä¸­</span>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="proxy-item">
                                <strong><i class="fas fa-times-circle"></i> ${proxyType.toUpperCase()}</strong><br>
                                <span class="badge">æœªæ£€æµ‹åˆ°</span>
                            </div>
                        `;
                    }
                }
                
                if (!hasActive) {
                    html = '<div class="no-data"><i class="fas fa-info-circle"></i> æœªæ£€æµ‹åˆ°è¿è¡Œä¸­çš„ä»£ç†æœåŠ¡</div>';
                }
                
                container.innerHTML = html;
            },
            
            // æ›´æ–°å‡ºç«™è¿æ¥è¡¨æ ¼
            updateOutboundConnections: function(connections, details) {
                const tbody = document.getElementById('outbound-tbody');
                if (!tbody) return;
                
                if (!connections || connections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-data"><i class="fas fa-info-circle"></i> å½“å‰æ— å‡ºç«™è¿æ¥</td></tr>';
                    return;
                }
                
                let html = '';
                connections.forEach(([ip, count], index) => {
                    const isHighTraffic = count > 10;
                    const badgeClass = isHighTraffic ? 'badge' : 'badge normal';
                    const connectionType = isHighTraffic ? 'é«˜é¢‘è¿æ¥' : 'æ­£å¸¸è¿æ¥';
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯
                    const detail = details.find(d => d.remote_ip === ip);
                    const detailInfo = detail ? 
                        `${detail.protocol} â†’ ${detail.remote}` : 
                        'è¿æ¥è¯¦æƒ…è·å–ä¸­...';
                    
                    html += `
                        <tr ${isHighTraffic ? 'style="background-color: #fff3cd;"' : ''}>
                            <td><i class="fas fa-server"></i> <strong>${ip}</strong></td>
                            <td><span class="${badgeClass}">${count}</span></td>
                            <td><span class="${badgeClass}">${connectionType}</span></td>
                            <td>
                                <div class="connection-detail">${detailInfo}</div>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            },
            
            // è·å–å¹¶æ›´æ–°æ•°æ®
            updateData: function() {
                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    timeout: 10000,
                    success: function(data) {
                        OutboundMonitor.retryCount = 0;
                        
                        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                        if (data.system) {
                            OutboundMonitor.updateText('hostname', data.system.hostname);
                            OutboundMonitor.updateText('uptime', data.system.uptime);
                            OutboundMonitor.updateText('current-time', data.system.current_time);
                        }
                        
                        // æ›´æ–° CPU
                        if (data.cpu) {
                            OutboundMonitor.updateText('cpu-percent', data.cpu.percent + '%');
                            OutboundMonitor.updateText('cpu-cores', data.cpu.count);
                            OutboundMonitor.updateProgress('cpu-progress', data.cpu.percent);
                        }
                        
                        // æ›´æ–°å†…å­˜
                        if (data.memory) {
                            OutboundMonitor.updateText('mem-used', data.memory.used + ' GB');
                            OutboundMonitor.updateText('mem-total', data.memory.total + ' GB');
                            OutboundMonitor.updateProgress('mem-progress', data.memory.percent);
                        }
                        
                        // æ›´æ–°ç£ç›˜
                        if (data.disk) {
                            OutboundMonitor.updateText('disk-used', data.disk.used + ' GB');
                            OutboundMonitor.updateText('disk-total', data.disk.total + ' GB');
                            OutboundMonitor.updateProgress('disk-progress', data.disk.percent);
                        }
                        
                        // æ›´æ–°æµé‡
                        if (data.network) {
                            OutboundMonitor.updateText('traffic-sent', data.network.sent + ' GB');
                            OutboundMonitor.updateText('traffic-received', data.network.received + ' GB');
                            OutboundMonitor.updateProgress('traffic-progress', data.network.percent);
                        }
                        
                        // æ›´æ–°ä»£ç†ä¿¡æ¯
                        if (data.proxy_info) {
                            OutboundMonitor.updateProxyInfo(data.proxy_info);
                        }
                        
                        // æ›´æ–°å‡ºç«™è¿æ¥ - é‡ç‚¹åŠŸèƒ½
                        if (data.outbound_connections && data.connection_details) {
                            OutboundMonitor.updateOutboundConnections(data.outbound_connections, data.connection_details);
                        }
                    },
                    
                    error: function(xhr, status, error) {
                        console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                        OutboundMonitor.retryCount++;
                        
                        if (OutboundMonitor.retryCount >= OutboundMonitor.config.maxRetries) {
                            const tbody = document.getElementById('outbound-tbody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="4" class="no-data"><i class="fas fa-exclamation-triangle"></i> è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</td></tr>';
                            }
                        }
                    }
                });
            },
            
            // åˆå§‹åŒ–
            init: function() {
                this.updateData();
                setInterval(() => {
                    this.updateData();
                }, this.config.updateInterval);
                
                console.log('ğŸš€ å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆå·²å¯åŠ¨');
                console.log('ğŸ¯ ç›‘æ§æ¨¡å¼: å‡ºç«™è¿æ¥è¿½è¸ª');
                console.log('ğŸ“Š æ•°æ®æ›´æ–°é—´éš”:', this.config.updateInterval / 1000, 'ç§’');
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨ç›‘æ§
        $(document).ready(function() {
            OutboundMonitor.init();
        });
    </script>
</body>
</html>
EOF

    echo -e "${GREEN}âœ“ å‡ºç«™è¿æ¥ç›‘æ§å‰ç«¯é¢æ¿ç”Ÿæˆå®Œæˆ${NC}"
}

# å®‰è£… Python ä¾èµ–
install_python_deps() {
    echo -e "${YELLOW}[5/5] å®‰è£… Python ä¾èµ–åº“...${NC}"
    
    # å°è¯•ä¸åŒçš„å®‰è£…æ–¹å¼
    if command -v pip3 &> /dev/null; then
        # å…ˆå°è¯•ç”¨æˆ·å®‰è£…
        pip3 install flask psutil --user 2>/dev/null || \
        # å†å°è¯•ç³»ç»Ÿå®‰è£…
        pip3 install flask psutil --break-system-packages 2>/dev/null || \
        # æœ€åå°è¯•æ™®é€šå®‰è£…
        pip3 install flask psutil
    else
        echo -e "${RED}é”™è¯¯ï¼šæœªæ‰¾åˆ° pip3${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ“ Python ä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºç³»ç»ŸæœåŠ¡
create_service() {
    echo -e "${YELLOW}é…ç½®ç³»ç»ŸæœåŠ¡...${NC}"
    
    cat <<EOF > /etc/systemd/system/${SERVICE_NAME}.service
[Unit]
Description=Outbound Connection Monitor Service
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=${INSTALL_DIR}
ExecStart=/usr/bin/python3 ${INSTALL_DIR}/app.py
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=outbound_monitor

[Install]
WantedBy=multi-user.target
EOF

    # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    systemctl daemon-reload
    systemctl enable ${SERVICE_NAME}
    systemctl stop ${SERVICE_NAME} 2>/dev/null || true
    systemctl start ${SERVICE_NAME}
    
    echo -e "${GREEN}âœ“ ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ${NC}"
}

# è·å–æœåŠ¡å™¨ IP
get_server_ip() {
    # ä¼˜å…ˆè·å–å…¬ç½‘ IP
    PUBLIC_IP=$(curl -s --connect-timeout 5 ifconfig.me 2>/dev/null || curl -s --connect-timeout 5 icanhazip.com 2>/dev/null || echo "")
    
    # è·å–å†…ç½‘ IP
    LOCAL_IP=$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1 || echo "127.0.0.1")
    
    if [[ -n "$PUBLIC_IP" ]]; then
        echo "$PUBLIC_IP"
    else
        echo "$LOCAL_IP"
    fi
}

# æ˜¾ç¤ºå®‰è£…ç»“æœ
show_result() {
    SERVER_IP=$(get_server_ip)
    SERVICE_STATUS=$(systemctl is-active ${SERVICE_NAME})
    
    echo ""
    echo -e "${GREEN}=================================================================="
    echo -e "                   å‡ºç«™è¿æ¥ç›‘æ§æ¢é’ˆå®‰è£…å®Œæˆï¼"
    echo -e "==================================================================${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“Š ç›‘æ§é¢æ¿è®¿é—®åœ°å€ï¼š${NC}"
    echo -e "   ğŸŒ å…¬ç½‘è®¿é—®: ${GREEN}http://${SERVER_IP}:${WEB_PORT}${NC}"
    echo -e "   ğŸ  å†…ç½‘è®¿é—®: ${GREEN}http://$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1):${WEB_PORT}${NC}"
    echo ""
    echo -e "${RED}ğŸ¯ ç›‘æ§é‡ç‚¹ï¼šæœ¬æœåŠ¡å™¨å¯¹å¤–å‘èµ·çš„è¿æ¥${NC}"
    echo -e "   âœ… å‡ºç«™è¿æ¥ IP è¿½è¸ª"
    echo -e "   âœ… ä»£ç†/éš§é“çŠ¶æ€ç›‘æ§"
    echo -e "   âœ… æµé‡æ–¹å‘åˆ†æ"
    echo ""
    echo -e "${BLUE}ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤ï¼š${NC}"
    echo -e "   å¯åŠ¨æœåŠ¡: ${YELLOW}systemctl start ${SERVICE_NAME}${NC}"
    echo -e "   åœæ­¢æœåŠ¡: ${YELLOW}systemctl stop ${SERVICE_NAME}${NC}"
    echo -e "   é‡å¯æœåŠ¡: ${YELLOW}systemctl restart ${SERVICE_NAME}${NC}"
    echo -e "   æŸ¥çœ‹çŠ¶æ€: ${YELLOW}systemctl status ${SERVICE_NAME}${NC}"
    echo -e "   æŸ¥çœ‹æ—¥å¿—: ${YELLOW}journalctl -u ${SERVICE_NAME} -f${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“ å®‰è£…ç›®å½•ï¼š${NC} ${INSTALL_DIR}"
    echo -e "${BLUE}ğŸš€ æœåŠ¡çŠ¶æ€ï¼š${NC} ${SERVICE_STATUS}"
    echo ""
    
    if [[ "$SERVICE_STATUS" == "active" ]]; then
        echo -e "${GREEN}âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®å‡ºç«™è¿æ¥ç›‘æ§é¢æ¿${NC}"
    else
        echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼šjournalctl -u ${SERVICE_NAME}${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š${NC}"
    echo -e "  - ğŸ¯ å‡ºç«™è¿æ¥ç›‘æ§ï¼šæ˜¾ç¤ºæœ¬æœåŠ¡å™¨ä¸»åŠ¨è¿æ¥çš„å¤–éƒ¨IP"
    echo -e "  - ğŸ” ä»£ç†æ£€æµ‹ï¼šè‡ªåŠ¨è¯†åˆ« SS/V2ray/Trojan ç­‰ä»£ç†"
    echo -e "  - ğŸ“Š æµé‡ç»Ÿè®¡ï¼šåŒºåˆ†ä¸Šä¼ /ä¸‹è½½æµé‡"
    echo -e "  - ğŸ”„ å®æ—¶æ›´æ–°ï¼šæ¯2ç§’åˆ·æ–°è¿æ¥çŠ¶æ€"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    print_banner
    check_privileges
    detect_system
    install_dependencies
    create_project
    create_backend
    create_frontend
    install_python_deps
    create_service
    show_result
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
