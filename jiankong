#!/bin/bash

# ============================================
# è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆ - Komari é£æ ¼ç•Œé¢
# åŠŸèƒ½ï¼šå®æ—¶æ˜¾ç¤ºè¿æ¥è®¾å¤‡ + æ–­è¿è‡ªåŠ¨æ¶ˆå¤±
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/device_monitor"
SERVICE_NAME="device_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000

# æ‰“å°æ¨ªå¹…
print_banner() {
    echo -e "${BLUE}"
    echo "=================================================================="
    echo "              è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆ - Komari é£æ ¼"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}åŠŸèƒ½ç‰¹æ€§ï¼š${NC}"
    echo "  ğŸ“± å®æ—¶è¿æ¥è®¾å¤‡æ˜¾ç¤º"
    echo "  ğŸ”Œ æ–­è¿è‡ªåŠ¨ç§»é™¤"
    echo "  ğŸ“Š ç³»ç»Ÿèµ„æºç›‘æ§"
    echo "  ğŸ¨ Komari é£æ ¼ç•Œé¢"
    echo "  ğŸš€ ç³»ç»ŸæœåŠ¡è‡ªå¯åŠ¨"
    echo ""
}

# æ£€æŸ¥æƒé™å’Œç³»ç»Ÿæ£€æµ‹å‡½æ•°ä¿æŒä¸å˜
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        exit 1
    fi
}

detect_system() {
    if [[ -f /etc/debian_version ]]; then
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    elif [[ -f /etc/redhat-release ]]; then
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y"
        INSTALL_CMD="yum install -y"
    else
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update"
        INSTALL_CMD="apt install -y"
    fi
}

install_dependencies() {
    echo -e "${YELLOW}[1/5] å®‰è£…ç³»ç»Ÿä¾èµ–...${NC}"
    $UPDATE_CMD
    if [[ $PKG_MANAGER == "apt" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl psmisc net-tools iproute2 lsof
    else
        $INSTALL_CMD python3 python3-pip curl psmisc net-tools iproute2 lsof
    fi
    echo -e "${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

create_project() {
    echo -e "${YELLOW}[2/5] åˆ›å»ºé¡¹ç›®ç›®å½•...${NC}"
    if [[ -d "$INSTALL_DIR" ]]; then
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    mkdir -p "$INSTALL_DIR/templates"
    cd "$INSTALL_DIR"
    echo -e "${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆ Komari é£æ ¼åç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/5] ç”Ÿæˆè®¾å¤‡ç›‘æ§åç«¯...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import subprocess
import re
from datetime import datetime, timedelta
from flask import Flask, render_template, jsonify
import psutil

app = Flask(__name__)

CONFIG = {
    'MONTHLY_LIMIT_GB': 1000,
    'UPDATE_INTERVAL': 2,
    'CONNECTION_TIMEOUT': 30  # 30ç§’æ— æ´»åŠ¨åˆ™è®¤ä¸ºæ–­è¿
}

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§ç±»"""
    
    @staticmethod
    def get_cpu_info():
        return {
            'percent': round(psutil.cpu_percent(interval=0.1), 1),
            'count': psutil.cpu_count(),
            'freq': round(psutil.cpu_freq().current, 0) if psutil.cpu_freq() else 0
        }
    
    @staticmethod
    def get_memory_info():
        memory = psutil.virtual_memory()
        return {
            'percent': round(memory.percent, 1),
            'total': round(memory.total / (1024**3), 2),
            'used': round(memory.used / (1024**3), 2),
            'available': round(memory.available / (1024**3), 2)
        }
    
    @staticmethod
    def get_disk_info():
        try:
            disk = psutil.disk_usage('/')
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2)
            }
        except:
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0}
    
    @staticmethod
    def get_network_stats():
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['MONTHLY_LIMIT_GB']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit
            }
        except:
            return {'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['MONTHLY_LIMIT_GB']}

class DeviceMonitor:
    """è®¾å¤‡è¿æ¥ç›‘æ§ç±» - ä»¿ x-ui é£æ ¼"""
    
    # å­˜å‚¨è¿æ¥å†å²ï¼Œç”¨äºæ£€æµ‹æ–­è¿
    connection_history = {}
    
    @staticmethod
    def get_device_info_by_ip(ip):
        """é€šè¿‡IPè·å–è®¾å¤‡ä¿¡æ¯"""
        device_info = {
            'ip': ip,
            'hostname': 'Unknown',
            'mac_address': 'Unknown',
            'device_type': 'Unknown',
            'os_type': 'Unknown'
        }
        
        try:
            # å°è¯•åå‘DNSæŸ¥è¯¢è·å–ä¸»æœºå
            try:
                import socket
                hostname = socket.gethostbyaddr(ip)[0]
                device_info['hostname'] = hostname
                
                # æ ¹æ®ä¸»æœºåæ¨æµ‹è®¾å¤‡ç±»å‹
                hostname_lower = hostname.lower()
                if any(x in hostname_lower for x in ['iphone', 'ipad', 'ios']):
                    device_info['device_type'] = 'iOS'
                    device_info['os_type'] = 'iOS'
                elif any(x in hostname_lower for x in ['android', 'xiaomi', 'huawei', 'oppo', 'vivo', 'oneplus']):
                    device_info['device_type'] = 'Android'
                    device_info['os_type'] = 'Android'
                elif any(x in hostname_lower for x in ['windows', 'desktop', 'laptop', 'pc']):
                    device_info['device_type'] = 'Windows'
                    device_info['os_type'] = 'Windows'
                elif any(x in hostname_lower for x in ['mac', 'macbook', 'imac']):
                    device_info['device_type'] = 'macOS'
                    device_info['os_type'] = 'macOS'
                elif any(x in hostname_lower for x in ['linux', 'ubuntu', 'centos']):
                    device_info['device_type'] = 'Linux'
                    device_info['os_type'] = 'Linux'
            except:
                pass
            
            # å°è¯•è·å– MAC åœ°å€
            try:
                arp_cmd = f"arp -n {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $3}}'"
                result = subprocess.run(arp_cmd, shell=True, capture_output=True, text=True, timeout=2)
                if result.returncode == 0 and result.stdout.strip():
                    mac = result.stdout.strip()
                    device_info['mac_address'] = mac
                    
                    # æ ¹æ® MAC åœ°å€å‰ç¼€æ¨æµ‹å‚å•†/è®¾å¤‡ç±»å‹
                    mac_prefixes = {
                        'ac:de:48': 'Apple',
                        '28:cd:c1': 'Apple',
                        'f0:18:98': 'Apple',
                        '3c:28:6d': 'Apple',
                        '40:cb:c0': 'Apple',
                        '28:cf:e9': 'Apple',
                        'dc:37:54': 'Samsung',
                        '28:6a:ba': 'Samsung',
                        '5c:0a:5b': 'Xiaomi',
                        '34:ce:00': 'Xiaomi',
                        '50:8f:4c': 'Huawei',
                        '00:e0:fc': 'Huawei'
                    }
                    
                    mac_prefix = mac[:8].lower()
                    for prefix, vendor in mac_prefixes.items():
                        if mac_prefix.startswith(prefix):
                            if vendor == 'Apple':
                                device_info['device_type'] = 'Apple Device'
                                device_info['os_type'] = 'iOS/macOS'
                            elif vendor in ['Samsung']:
                                device_info['device_type'] = 'Android Phone'
                                device_info['os_type'] = 'Android'
                            elif vendor in ['Xiaomi', 'Huawei']:
                                device_info['device_type'] = 'Android Phone'
                                device_info['os_type'] = 'Android'
                            break
            except:
                pass
                
        except Exception as e:
            print(f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ {ip}: {e}")
        
        return device_info
    
    @staticmethod
    def get_active_connections():
        """è·å–æ´»è·ƒè¿æ¥è®¾å¤‡ - ä»¿ x-ui æ˜¾ç¤ºæ–¹å¼"""
        current_time = time.time()
        active_devices = {}
        
        try:
            # è·å–å½“å‰æ´»è·ƒè¿æ¥
            cmd = """netstat -tn 2>/dev/null | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        count = int(parts[0])
                        ip = parts[1]
                        
                        # è¿‡æ»¤å†…ç½‘å’Œæœ¬åœ°åœ°å€
                        if not (ip.startswith('127.') or ip == '0.0.0.0'):
                            # æ›´æ–°è¿æ¥å†å²
                            DeviceMonitor.connection_history[ip] = {
                                'last_seen': current_time,
                                'connection_count': count,
                                'first_seen': DeviceMonitor.connection_history.get(ip, {}).get('first_seen', current_time)
                            }
            
            # æ¸…ç†è¶…æ—¶çš„è¿æ¥ï¼ˆ30ç§’æ— æ´»åŠ¨ï¼‰
            timeout_threshold = current_time - CONFIG['CONNECTION_TIMEOUT']
            expired_ips = []
            
            for ip, info in DeviceMonitor.connection_history.items():
                if info['last_seen'] < timeout_threshold:
                    expired_ips.append(ip)
            
            for ip in expired_ips:
                del DeviceMonitor.connection_history[ip]
            
            # ç”Ÿæˆå½“å‰æ´»è·ƒè®¾å¤‡åˆ—è¡¨
            for ip, info in DeviceMonitor.connection_history.items():
                device_info = DeviceMonitor.get_device_info_by_ip(ip)
                
                # è®¡ç®—è¿æ¥æ—¶é•¿
                connection_duration = current_time - info['first_seen']
                
                active_devices[ip] = {
                    'ip': ip,
                    'hostname': device_info['hostname'],
                    'device_type': device_info['device_type'],
                    'os_type': device_info['os_type'],
                    'mac_address': device_info['mac_address'],
                    'connection_count': info['connection_count'],
                    'last_seen': info['last_seen'],
                    'connection_duration': int(connection_duration),
                    'status': 'online',
                    'signal_strength': min(100, max(50, 100 - (current_time - info['last_seen']) * 10))  # æ¨¡æ‹Ÿä¿¡å·å¼ºåº¦
                }
            
            return list(active_devices.values())
            
        except Exception as e:
            print(f"è·å–æ´»è·ƒè¿æ¥é”™è¯¯: {e}")
            return []

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    try:
        data = {
            'system': {
                'hostname': subprocess.run(['hostname'], capture_output=True, text=True).stdout.strip(),
                'uptime': subprocess.run(['uptime', '-p'], capture_output=True, text=True).stdout.strip(),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            },
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': SystemMonitor.get_network_stats(),
            'active_devices': DeviceMonitor.get_active_connections(),
            'timestamp': time.time()
        }
        return jsonify(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    print("ğŸš€ è®¾å¤‡è¿æ¥ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    print("ğŸ¨ ç•Œé¢é£æ ¼: Komari")
    print("ğŸ“± ç›‘æ§æ¨¡å¼: å®æ—¶è®¾å¤‡è¿æ¥")
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

    chmod +x app.py
    echo -e "${GREEN}âœ“ è®¾å¤‡ç›‘æ§åç«¯ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆ Komari é£æ ¼å‰ç«¯
create_frontend() {
    echo -e "${YELLOW}[4/5] ç”Ÿæˆ Komari é£æ ¼å‰ç«¯...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komari è®¾å¤‡ç›‘æ§</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Komari é£æ ¼æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Komari é£æ ¼å¤´éƒ¨ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .status-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .status-pill {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Komari ç½‘æ ¼å¸ƒå±€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2rem;
            color: white;
        }

        .stat-icon.cpu { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .stat-icon.memory { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .stat-icon.disk { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .stat-icon.network { background: linear-gradient(45deg, #f093fb, #f5576c); }

        .stat-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .stat-subtitle {
            color: #718096;
            font-size: 0.875rem;
        }

        /* Komari é£æ ¼è¿›åº¦æ¡ */
        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f093fb, #f5576c);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
        }

        /* è®¾å¤‡åˆ—è¡¨ - ä»¿ x-ui é£æ ¼ */
        .devices-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .devices-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .devices-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .devices-header i {
            margin-right: 12px;
            color: #667eea;
        }

        .device-count {
            margin-left: auto;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .device-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.5rem;
            color: white;
        }

        .device-avatar.ios { background: linear-gradient(45deg, #007AFF, #5856D6); }
        .device-avatar.android { background: linear-gradient(45deg, #3DDC84, #4285F4); }
        .device-avatar.windows { background: linear-gradient(45deg, #0078D4, #106EBE); }
        .device-avatar.macos { background: linear-gradient(45deg, #007AFF, #A77BF3); }
        .device-avatar.linux { background: linear-gradient(45deg, #FCC624, #E95420); }
        .device-avatar.unknown { background: linear-gradient(45deg, #6C757D, #495057); }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .device-ip {
            color: #718096;
            font-size: 0.875rem;
            font-family: monospace;
        }

        .device-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48BB78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
            animation: pulse 2s infinite;
        }

        .device-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-detail {
            text-align: center;
        }

        .detail-value {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.875rem;
        }

        .detail-label {
            color: #718096;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .no-devices {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .no-devices i {#!/bin/bash

# ============================================
# Komari è®¾å¤‡ç›‘æ§æ¢é’ˆ - å®Œæ•´ä¼˜åŒ–ç‰ˆ
# åŠŸèƒ½ï¼šå®æ—¶è®¾å¤‡æ˜¾ç¤º + æ–­è¿è‡ªåŠ¨æ¶ˆå¤± + æœ¬æœºæµé‡ç›‘æ§
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/komari_monitor"
SERVICE_NAME="komari_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000

# æ‰“å°æ¨ªå¹…
print_banner() {
    echo -e "${PURPLE}"
    echo "=================================================================="
    echo "          Komari è®¾å¤‡ç›‘æ§æ¢é’ˆ - å®Œæ•´ä¼˜åŒ–ç‰ˆ v2.0"
    echo "=================================================================="
    echo -e "${NC}"
    echo -e "${GREEN}âœ¨ æ ¸å¿ƒåŠŸèƒ½ï¼š${NC}"
    echo "  ğŸ“± å®æ—¶è¿æ¥è®¾å¤‡æ˜¾ç¤º (ä»¿x-uié£æ ¼)"
    echo "  ğŸ”Œ æ–­è¿è‡ªåŠ¨æ¶ˆå¤± (30ç§’è¶…æ—¶)"
    echo "  ğŸ“Š æœ¬æœºæµé‡ç›‘æ§ + ç³»ç»Ÿèµ„æº"
    echo "  ğŸ¯ æ™ºèƒ½è®¾å¤‡è¯†åˆ« (iOS/Android/Windows/macOS)"
    echo "  ğŸ·ï¸ å‚å•†æ£€æµ‹ (Apple/Samsung/Xiaomi/Huawei)"
    echo "  ğŸ¨ Komari ç°ä»£ç•Œé¢é£æ ¼"
    echo "  ğŸ”„ å®æ—¶æ›´æ–° (2ç§’é—´éš”)"
    echo ""
}

# æ£€æŸ¥æƒé™
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        echo "è¯·ä½¿ç”¨: sudo $0"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿ
detect_system() {
    echo -e "${YELLOW}ğŸ” æ£€æµ‹ç³»ç»Ÿç¯å¢ƒ...${NC}"
    
    if [[ -f /etc/debian_version ]]; then
        OS="debian"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
        echo -e "  ç³»ç»Ÿç±»å‹: Debian/Ubuntu"
    elif [[ -f /etc/redhat-release ]]; then
        OS="redhat"
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y -q"
        INSTALL_CMD="yum install -y"
        echo -e "  ç³»ç»Ÿç±»å‹: RedHat/CentOS"
    else
        echo -e "${YELLOW}  æœªè¯†åˆ«çš„ç³»ç»Ÿï¼Œå°è¯•ä½¿ç”¨ apt${NC}"
        OS="unknown"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
    fi
    
    echo -e "${GREEN}âœ“ ç³»ç»Ÿæ£€æµ‹å®Œæˆ${NC}"
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${YELLOW}[1/6] å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…...${NC}"
    
    $UPDATE_CMD > /dev/null 2>&1
    
    if [[ $OS == "debian" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl wget psmisc net-tools iproute2 lsof arp-scan dnsutils > /dev/null 2>&1
    else
        $INSTALL_CMD python3 python3-pip curl wget psmisc net-tools iproute2 lsof bind-utils > /dev/null 2>&1
    fi
    
    # éªŒè¯å…³é”®å·¥å…·
    echo -e "  ğŸ“¦ æ£€æŸ¥å…³é”®å·¥å…·..."
    for tool in python3 pip3 netstat ss arp; do
        if command -v $tool >/dev/null 2>&1; then
            echo -e "    âœ“ $tool"
        else
            echo -e "    âŒ $tool æœªæ‰¾åˆ°"
        fi
    done
    
    echo -e "${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºé¡¹ç›®ç»“æ„
create_project() {
    echo -e "${YELLOW}[2/6] åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„...${NC}"
    
    # å¤‡ä»½æ—§ç‰ˆæœ¬
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "  å‘ç°æ—§ç‰ˆæœ¬ï¼Œåˆ›å»ºå¤‡ä»½..."
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    
    # åˆ›å»ºç›®å½•ç»“æ„
    mkdir -p "$INSTALL_DIR"/{templates,static/{css,js,img},logs,config}
    cd "$INSTALL_DIR"
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    cat <<EOF > config/settings.json
{
    "monthly_limit_gb": ${MONTHLY_LIMIT_GB},
    "update_interval": 2,
    "connection_timeout": 30,
    "web_port": ${WEB_PORT},
    "max_devices": 100,
    "log_level": "INFO"
}
EOF
    
    echo -e "${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆå®Œæ•´ä¼˜åŒ–ç‰ˆåç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/6] ç”Ÿæˆ Komari ç›‘æ§åç«¯ (å®Œæ•´ç‰ˆ)...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Komari è®¾å¤‡ç›‘æ§æ¢é’ˆ - å®Œæ•´ä¼˜åŒ–ç‰ˆ v2.0
åŠŸèƒ½ï¼šå®æ—¶è®¾å¤‡æ˜¾ç¤º + æ–­è¿è‡ªåŠ¨æ¶ˆå¤± + æœ¬æœºæµé‡ç›‘æ§
ä½œè€…ï¼šAI Assistant
"""

import json
import time
import subprocess
import re
import os
import logging
from datetime import datetime, timedelta
from flask import Flask, render_template, jsonify
import psutil
import socket
from collections import defaultdict

app = Flask(__name__)

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/monitor.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# åŠ è½½é…ç½®
try:
    with open('config/settings.json', 'r') as f:
        CONFIG = json.load(f)
except:
    CONFIG = {
        'monthly_limit_gb': 1000,
        'update_interval': 2,
        'connection_timeout': 30,
        'web_port': 5000,
        'max_devices': 100,
        'log_level': 'INFO'
    }

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§æ ¸å¿ƒç±»"""
    
    @staticmethod
    def get_cpu_info():
        """è·å– CPU è¯¦ç»†ä¿¡æ¯"""
        try:
            cpu_percent = psutil.cpu_percent(interval=0.1)
            cpu_count = psutil.cpu_count()
            cpu_freq = psutil.cpu_freq()
            
            return {
                'percent': round(cpu_percent, 1),
                'count': cpu_count,
                'freq': round(cpu_freq.current, 0) if cpu_freq else 0,
                'usage_per_cpu': psutil.cpu_percent(interval=0.1, percpu=True)
            }
        except Exception as e:
            logger.error(f"è·å–CPUä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'count': 0, 'freq': 0, 'usage_per_cpu': []}
    
    @staticmethod
    def get_memory_info():
        """è·å–å†…å­˜è¯¦ç»†ä¿¡æ¯"""
        try:
            memory = psutil.virtual_memory()
            swap = psutil.swap_memory()
            
            return {
                'percent': round(memory.percent, 1),
                'total': round(memory.total / (1024**3), 2),
                'used': round(memory.used / (1024**3), 2),
                'available': round(memory.available / (1024**3), 2),
                'swap_percent': round(swap.percent, 1),
                'swap_total': round(swap.total / (1024**3), 2),
                'swap_used': round(swap.used / (1024**3), 2)
            }
        except Exception as e:
            logger.error(f"è·å–å†…å­˜ä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'available': 0, 'swap_percent': 0, 'swap_total': 0, 'swap_used': 0}
    
    @staticmethod
    def get_disk_info():
        """è·å–ç£ç›˜è¯¦ç»†ä¿¡æ¯"""
        try:
            disk = psutil.disk_usage('/')
            disk_io = psutil.disk_io_counters()
            
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2),
                'read_mb': round(disk_io.read_bytes / (1024**2), 2) if disk_io else 0,
                'write_mb': round(disk_io.write_bytes / (1024**2), 2) if disk_io else 0
            }
        except Exception as e:
            logger.error(f"è·å–ç£ç›˜ä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0, 'read_mb': 0, 'write_mb': 0}
    
    @staticmethod
    def get_network_stats():
        """è·å–ç½‘ç»œæµé‡ç»Ÿè®¡"""
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['monthly_limit_gb']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit,
                'packets_sent': net_io.packets_sent,
                'packets_recv': net_io.packets_recv,
                'speed_sent_mb': round((net_io.bytes_sent - getattr(SystemMonitor, '_last_sent', 0)) / (1024**2), 2),
                'speed_recv_mb': round((net_io.bytes_recv - getattr(SystemMonitor, '_last_recv', 0)) / (1024**2), 2)
            }
        except Exception as e:
            logger.error(f"è·å–ç½‘ç»œç»Ÿè®¡å¤±è´¥: {e}")
            return {'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['monthly_limit_gb'], 'packets_sent': 0, 'packets_recv': 0, 'speed_sent_mb': 0, 'speed_recv_mb': 0}

class DeviceMonitor:
    """è®¾å¤‡è¿æ¥ç›‘æ§ç±» - å®Œæ•´ä¼˜åŒ–ç‰ˆ"""
    
    # å­˜å‚¨è¿æ¥å†å²
    connection_history = {}
    device_cache = {}
    
    # OUI æ•°æ®åº“ - æ›´å®Œæ•´çš„å‚å•†æ˜ å°„
    OUI_DATABASE = {
        # Apple è®¾å¤‡
        'AC:DE:48': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        '28:CD:C1': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        'F0:18:98': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        '3C:28:6D': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        '40:CB:C0': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        '28:CF:E9': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple'},
        '24:DA:9B': {'vendor': 'Apple', 'type': 'MacBook', 'os': 'macOS', 'icon': 'fab fa-apple'},
        '88:E9:FE': {'vendor': 'Apple', 'type': 'MacBook', 'os': 'macOS', 'icon': 'fab fa-apple'},
        
        # Samsung è®¾å¤‡
        'DC:37:54': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        '28:6A:BA': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        'C4:57:6E': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        
        # å°ç±³è®¾å¤‡
        '5C:0A:5B': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        '34:CE:00': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        '50:E6:66': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        
        # åä¸ºè®¾å¤‡
        '50:8F:4C': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        '00:E0:FC': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        '34:6B:D3': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt'},
        
        # OPPO/OnePlus
        '40:4E:36': {'vendor': 'OPPO', 'type': 'OPPOæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        'AC:E2:D3': {'vendor': 'OnePlus', 'type': 'OnePlusæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        
        # VIVO
        '14:AB:C5': {'vendor': 'VIVO', 'type': 'VIVOæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android'},
        
        # å…¶ä»–å¸¸è§è®¾å¤‡
        '00:50:56': {'vendor': 'VMware', 'type': 'è™šæ‹Ÿæœº', 'os': 'Virtual', 'icon': 'fas fa-server'},
        '08:00:27': {'vendor': 'VirtualBox', 'type': 'è™šæ‹Ÿæœº', 'os': 'Virtual', 'icon': 'fas fa-server'},
    }
    
    @staticmethod
    def get_device_info_by_ip(ip):
        """é€šè¿‡IPè·å–è®¾å¤‡è¯¦ç»†ä¿¡æ¯ - å¢å¼ºç‰ˆ"""
        
        # æ£€æŸ¥ç¼“å­˜
        if ip in DeviceMonitor.device_cache:
            cache_time = DeviceMonitor.device_cache[ip].get('cache_time', 0)
            if time.time() - cache_time < 300:  # 5åˆ†é’Ÿç¼“å­˜
                return DeviceMonitor.device_cache[ip]['data']
        
        device_info = {
            'ip': ip,
            'hostname': 'æœªçŸ¥è®¾å¤‡',
            'mac_address': 'æœªè·å–',
            'device_type': 'æœªçŸ¥è®¾å¤‡',
            'os_type': 'Unknown',
            'vendor': 'æœªçŸ¥å‚å•†',
            'icon': 'fas fa-question-circle',
            'device_class': 'unknown'
        }
        
        try:
            # 1. åå‘DNSæŸ¥è¯¢è·å–ä¸»æœºå
            try:
                hostname, _, _ = socket.gethostbyaddr(ip)
                device_info['hostname'] = hostname
                logger.info(f"è·å–åˆ°ä¸»æœºå: {ip} -> {hostname}")
                
                # æ ¹æ®ä¸»æœºåæ™ºèƒ½æ¨æµ‹è®¾å¤‡ç±»å‹
                hostname_lower = hostname.lower()
                if any(x in hostname_lower for x in ['iphone', 'ipad', 'ios', 'apple-', 'apples-']):
                    device_info.update({
                        'device_type': 'iPhone/iPad',
                        'os_type': 'iOS',
                        'vendor': 'Apple',
                        'icon': 'fab fa-apple',
                        'device_class': 'ios'
                    })
                elif any(x in hostname_lower for x in ['android', 'phone', 'mobile']):
                    device_info.update({
                        'device_type': 'Androidæ‰‹æœº',
                        'os_type': 'Android',
                        'icon': 'fab fa-android',
                        'device_class': 'android'
                    })
                elif any(x in hostname_lower for x in ['xiaomi', 'mi-', 'redmi', 'miui']):
                    device_info.update({
                        'device_type': 'å°ç±³æ‰‹æœº',
                        'os_type': 'Android',
                        'vendor': 'Xiaomi',
                        'icon': 'fas fa-mobile-alt',
                        'device_class': 'android'
                    })
                elif any(x in hostname_lower for x in ['huawei', 'honor', 'mate', 'p30', 'p40']):
                    device_info.update({
                        'device_type': 'åä¸ºæ‰‹æœº',
                        'os_type': 'Android',
                        'vendor': 'Huawei',
                        'icon': 'fas fa-mobile-alt',
                        'device_class': 'android'
                    })
                elif any(x in hostname_lower for x in ['windows', 'desktop', 'laptop', 'pc', 'win10', 'win11']):
                    device_info.update({
                        'device_type': 'Windowsç”µè„‘',
                        'os_type': 'Windows',
                        'icon': 'fab fa-windows',
                        'device_class': 'windows'
                    })
                elif any(x in hostname_lower for x in ['mac', 'macbook', 'imac', 'mbp']):
                    device_info.update({
                        'device_type': 'Macç”µè„‘',
                        'os_type': 'macOS',
                        'vendor': 'Apple',
                        'icon': 'fab fa-apple',
                        'device_class': 'macos'
                    })
                elif any(x in hostname_lower for x in ['linux', 'ubuntu', 'centos', 'debian']):
                    device_info.update({
                        'device_type': 'LinuxæœåŠ¡å™¨',
                        'os_type': 'Linux',
                        'icon': 'fab fa-linux',
                        'device_class': 'linux'
                    })
                    
            except socket.herror:
                logger.debug(f"æ— æ³•è§£æä¸»æœºå: {ip}")
            except Exception as e:
                logger.error(f"DNSæŸ¥è¯¢å¤±è´¥: {e}")
            
            # 2. è·å– MAC åœ°å€ - å¤šç§æ–¹æ³•
            mac_found = False
            mac_commands = [
                f"arp -n {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $3}}'",
                f"ip neigh show {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $5}}'",
                f"cat /proc/net/arp 2>/dev/null | grep {ip} | awk '{{print $4}}'",
                f"nmap -sn {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}'"
            ]
            
            for cmd in mac_commands:
                try:
                    result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=3)
                    if result.returncode == 0 and result.stdout.strip():
                        mac_raw = result.stdout.strip()
                        # æ ‡å‡†åŒ– MAC åœ°å€æ ¼å¼
                        mac_clean = re.sub(r'[^0-9A-Fa-f]', '', mac_raw)
                        if len(mac_clean) == 12:
                            mac = ':'.join([mac_clean[i:i+2] for i in range(0, 12, 2)]).upper()
                            device_info['mac_address'] = mac
                            mac_found = True
                            logger.info(f"è·å–åˆ°MACåœ°å€: {ip} -> {mac}")
                            
                            # æ ¹æ® MAC åœ°å€ OUI æ¨æµ‹å‚å•†å’Œè®¾å¤‡ç±»å‹
                            oui = mac[:8]  # å‰3ä¸ªå­—èŠ‚
                            if oui in DeviceMonitor.OUI_DATABASE:
                                oui_info = DeviceMonitor.OUI_DATABASE[oui]
                                device_info.update({
                                    'vendor': oui_info['vendor'],
                                    'device_type': oui_info['type'],
                                    'os_type': oui_info['os'],
                                    'icon': oui_info['icon'],
                                    'device_class': oui_info['os'].lower()
                                })
                                logger.info(f"é€šè¿‡OUIè¯†åˆ«è®¾å¤‡: {ip} -> {oui_info}")
                            break
                            
                except subprocess.TimeoutExpired:
                    logger.warning(f"MACæŸ¥è¯¢è¶…æ—¶: {cmd}")
                except Exception as e:
                    logger.error(f"MACæŸ¥è¯¢å¤±è´¥: {e}")
            
            # 3. å°è¯•ç«¯å£æ‰«ææ¨æµ‹è®¾å¤‡ç±»å‹ (è½»é‡çº§)
            if not mac_found:
                try:
                    # æ£€æŸ¥å¸¸è§ç§»åŠ¨è®¾å¤‡ç«¯å£
                    common_ports = [22, 80, 443, 5555]  # SSH, HTTP, HTTPS, Android ADB
                    open_ports = []
                    
                    for port in common_ports:
                        try:
                            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                            sock.settimeout(1)
                            result = sock.connect_ex((ip, port))
                            if result == 0:
                                open_ports.append(port)
                            sock.close()
                        except:
                            pass
                    
                    if 5555 in open_ports:  # Android ADB
                        device_info.update({
                            'device_type': 'Androidè®¾å¤‡ (ADB)',
                            'os_type': 'Android',
                            'icon': 'fab fa-android',
                            'device_class': 'android'
                        })
                    elif 22 in open_ports:  # SSH
                        device_info.update({
                            'device_type': 'Linux/Unixè®¾å¤‡',
                            'os_type': 'Linux',
                            'icon': 'fab fa-linux',
                            'device_class': 'linux'
                        })
                        
                except Exception as e:
                    logger.error(f"ç«¯å£æ‰«æå¤±è´¥: {e}")
            
        except Exception as e:
            logger.error(f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ {ip}: {e}")
        
        # ç¼“å­˜ç»“æœ
        DeviceMonitor.device_cache[ip] = {
            'data': device_info.copy(),
            'cache_time': time.time()
        }
        
        return device_info
    
    @staticmethod
    def get_active_connections():
        """è·å–æ´»è·ƒè¿æ¥è®¾å¤‡ - å®Œæ•´ä¼˜åŒ–ç‰ˆ"""
        current_time = time.time()
        active_devices = {}
        
        try:
            # æ–¹æ³•1: ä½¿ç”¨ netstat è·å–å…¥ç«™è¿æ¥
            cmd1 = """netstat -tn 2>/dev/null | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            try:
                result = subprocess.run(cmd1, shell=True, capture_output=True, text=True, timeout=5)
                for line in result.stdout.strip().split('\n'):
                    if line.strip():
                        parts = line.strip().split()
                        if len(parts) >= 2:
                            count = int(parts[0])
                            ip = parts[1]
                            
                            # è¿‡æ»¤å†…ç½‘å’Œæœ¬åœ°åœ°å€ï¼Œåªæ˜¾ç¤ºè¿æ¥åˆ°æœ¬æœåŠ¡å™¨çš„å¤–éƒ¨è®¾å¤‡
                            if not (ip.startswith('127.') or ip == '0.0.0.0' or ip.startswith('169.254.')):
                                DeviceMonitor._update_connection_history(ip, count, current_time)
                                
            except Exception as e:
                logger.error(f"netstat å‘½ä»¤æ‰§è¡Œå¤±è´¥: {e}")
            
            # æ–¹æ³•2: ä½¿ç”¨ ss å‘½ä»¤è·å–æ›´è¯¦ç»†çš„è¿æ¥ä¿¡æ¯
            cmd2 = """ss -tn state established 2>/dev/null | awk 'NR>1 {print $4}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            try:
                result = subprocess.run(cmd2, shell=True, capture_output=True, text=True, timeout=5)
                for line in result.stdout.strip().split('\n'):
                    if line.strip():
                        parts = line.strip().split()
                        if len(parts) >= 2:
                            count = int(parts[0])
                            ip = parts[1]
                            
                            if not (ip.startswith('127.') or ip.startswith('192.168.') or 
                                   ip.startswith('10.') or ip.startswith('172.') or ip == '0.0.0.0'):
                                DeviceMonitor._update_connection_history(ip, count, current_time)
                                
            except Exception as e:
                logger.error(f"ss å‘½ä»¤æ‰§è¡Œå¤±è´¥: {e}")
            
            # æ¸…ç†è¶…æ—¶çš„è¿æ¥ - æ–­è¿è‡ªåŠ¨æ¶ˆå¤±
            timeout_threshold = current_time - CONFIG['connection_timeout']
            expired_ips = []
            
            for ip, info in DeviceMonitor.connection_history.items():
                if info['last_seen'] < timeout_threshold:
                    expired_ips.append(ip)
                    logger.info(f"è®¾å¤‡æ–­è¿: {ip} (è¶…æ—¶ {CONFIG['connection_timeout']} ç§’)")
            
            # åˆ é™¤è¶…æ—¶è®¾å¤‡
            for ip in expired_ips:
                del DeviceMonitor.connection_history[ip]
                # åŒæ—¶æ¸…ç†è®¾å¤‡ç¼“å­˜
                if ip in DeviceMonitor.device_cache:
                    del DeviceMonitor.device_cache[ip]
            
            # ç”Ÿæˆå½“å‰æ´»è·ƒè®¾å¤‡åˆ—è¡¨
            device_list = []
            for ip, info in DeviceMonitor.connection_history.items():
                try:
                    device_info = DeviceMonitor.get_device_info_by_ip(ip)
                    
                    # è®¡ç®—è¿æ¥æ—¶é•¿
                    connection_duration = current_time - info['first_seen']
                    
                    # è®¡ç®—ä¿¡å·å¼ºåº¦ï¼ˆåŸºäºæœ€åæ´»åŠ¨æ—¶é—´ï¼‰
                    time_since_last = current_time - info['last_seen']
                    signal_strength = max(10, 100 - int(time_since_last * 5))
                    
                    # ç¡®å®šè¿æ¥çŠ¶æ€
                    if time_since_last < 5:
                        status = 'active'
                        status_text = 'æ´»è·ƒ'
                    elif time_since_last < 15:
                        status = 'idle'
                        status_text = 'ç©ºé—²'
                    else:
                        status = 'inactive'
                        status_text = 'å³å°†æ–­å¼€'
                    
                    device = {
                        'ip': ip,
                        'hostname': device_info['hostname'],
                        'device_type': device_info['device_type'],
                        'os_type': device_info['os_type'],
                        'vendor': device_info['vendor'],
                        'mac_address': device_info['mac_address'],
                        'icon': device_info['icon'],
                        'device_class': device_info['device_class'],
                        'connection_count': info['connection_count'],
                        'total_connections': info.get('total_connections', info['connection_count']),
                        'last_seen': info['last_seen'],
                        'connection_duration': int(connection_duration),
                        'status': status,
                        'status_text': status_text,
                        'signal_strength': signal_strength,
                        'first_seen_time': datetime.fromtimestamp(info['first_seen']).strftime('%H:%M:%S'),
                        'last_seen_time': datetime.fromtimestamp(info['last_seen']).strftime('%H:%M:%S')
                    }
                    
                    device_list.append(device)
                    
                except Exception as e:
                    logger.error(f"å¤„ç†è®¾å¤‡ä¿¡æ¯å¤±è´¥ {ip}: {e}")
                    continue
            
            # æŒ‰è¿æ¥æ•°é‡æ’åº
            device_list.sort(key=lambda x: x['connection_count'], reverse=True)
            
            # é™åˆ¶è®¾å¤‡æ•°é‡
            if len(device_list) > CONFIG['max_devices']:
                device_list = device_list[:CONFIG['max_devices']]
                logger.warning(f"è®¾å¤‡æ•°é‡è¶…é™ï¼Œåªæ˜¾ç¤ºå‰ {CONFIG['max_devices']} ä¸ª")
            
            return device_list
            
        except Exception as e:
            logger.error(f"è·å–æ´»è·ƒè¿æ¥é”™è¯¯: {e}")
            return []
    
    @staticmethod
    def _update_connection_history(ip, count, current_time):
        """æ›´æ–°è¿æ¥å†å²è®°å½•"""
        if ip not in DeviceMonitor.connection_history:
            DeviceMonitor.connection_history[ip] = {
                'first_seen': current_time,
                'last_seen': current_time,
                'connection_count': count,
                'total_connections': count
            }
            logger.info(f"æ–°è®¾å¤‡è¿æ¥: {ip}")
        else:
            history = DeviceMonitor.connection_history[ip]
            history['last_seen'] = current_time
            history['connection_count'] = max(history['connection_count'], count)
            history['total_connections'] = history.get('total_connections', 0) + count

class SystemInfo:
    """ç³»ç»Ÿä¿¡æ¯ç±»"""
    
    @staticmethod
    def get_system_info():
        """è·å–ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯"""
        try:
            # è·å–ç³»ç»Ÿè¿è¡Œæ—¶é—´
            uptime_cmd = subprocess.run(['uptime', '-p'], capture_output=True, text=True)
            uptime = uptime_cmd.stdout.strip() if uptime_cmd.returncode == 0 else "æœªçŸ¥"
            
            # è·å–ä¸»æœºå
            hostname = socket.gethostname()
            
            # è·å–ç³»ç»Ÿè´Ÿè½½
            load_avg = os.getloadavg() if hasattr(os, 'getloadavg') else (0, 0, 0)
            
            # è·å–å¯åŠ¨æ—¶é—´
            boot_time = datetime.fromtimestamp(psutil.boot_time())
            
            return {
                'hostname': hostname,
                'uptime': uptime,
                'platform': f"{psutil.platform.system()} {psutil.platform.release()}",
                'boot_time': boot_time.strftime('%Y-%m-%d %H:%M:%S'),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [round(x, 2) for x in load_avg],
                'python_version': f"{psutil.sys.version_info.major}.{psutil.sys.version_info.minor}",
                'total_processes': len(psutil.pids())
            }
        except Exception as e:
            logger.error(f"è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥: {e}")
            return {
                'hostname': 'æœªçŸ¥',
                'uptime': 'æœªçŸ¥',
                'platform': 'æœªçŸ¥',
                'boot_time': 'æœªçŸ¥',
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [0, 0, 0],
                'python_version': 'æœªçŸ¥',
                'total_processes': 0
            }

# Flask è·¯ç”±
@app.route('/')
def index():
    """ä¸»é¡µé¢"""
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    """API: è·å–æ‰€æœ‰ç›‘æ§æ•°æ®"""
    try:
        start_time = time.time()
        
        data = {
            'system': SystemInfo.get_system_info(),
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': SystemMonitor.get_network_stats(),
            'active_devices': DeviceMonitor.get_active_connections(),
            'config': CONFIG,
            'timestamp': time.time(),
            'api_response_time': round((time.time() - start_time) * 1000, 2)  # æ¯«ç§’
        }
        
        # è®°å½•ç»Ÿè®¡
        device_count = len(data['active_devices'])
        logger.debug(f"APIè°ƒç”¨å®Œæˆ - è®¾å¤‡æ•°: {device_count}, å“åº”æ—¶é—´: {data['api_response_time']}ms")
        
        return jsonify(data)
        
    except Exception as e:
        logger.error(f"API é”™è¯¯: {e}")
        return jsonify({'error': str(e), 'timestamp': time.time()}), 500

@app.route('/api/config')
def api_config():
    """API: è·å–é…ç½®ä¿¡æ¯"""
    return jsonify(CONFIG)

@app.route('/api/devices/<ip>')
def api_device_detail(ip):
    """API: è·å–æŒ‡å®šè®¾å¤‡è¯¦ç»†ä¿¡æ¯"""
    try:
        device_info = DeviceMonitor.get_device_info_by_ip(ip)
        return jsonify(device_info)
    except Exception as e:
        logger.error(f"è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥ {ip}: {e}")
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    # å¯åŠ¨æ—¥å¿—
    logger.info("ğŸš€ Komari è®¾å¤‡ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    logger.info(f"ğŸ“Š Web é¢æ¿åœ°å€: http://0.0.0.0:{CONFIG['web_port']}")
    logger.info(f"ğŸ”„ æ•°æ®æ›´æ–°é—´éš”: {CONFIG['update_interval']} ç§’")
    logger.info(f"ğŸ“ˆ æœˆæµé‡é™åˆ¶: {CONFIG['monthly_limit_gb']} GB")
    logger.info(f"â° è¿æ¥è¶…æ—¶: {CONFIG['connection_timeout']} ç§’")
    logger.info(f"ğŸ¨ ç•Œé¢é£æ ¼: Komari å®Œæ•´ç‰ˆ")
    
    # å¯åŠ¨ Flask åº”ç”¨
    app.run(host='0.0.0.0', port=CONFIG['web_port'], debug=False, threaded=True)
EOF

    chmod +x app.py
    echo -e "${GREEN}âœ“ Komari ç›‘æ§åç«¯ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆå®Œæ•´ä¼˜åŒ–ç‰ˆå‰ç«¯
create_frontend() {
    echo -e "${YELLOW}[4/6] ç”Ÿæˆ Komari å®Œæ•´å‰ç«¯ç•Œé¢...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komari Monitor - è®¾å¤‡ç›‘æ§æ¢é’ˆ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Komari å®Œæ•´ç‰ˆæ ·å¼ */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --success-gradient: linear-gradient(45deg, #48bb78, #38a169);
            --warning-gradient: linear-gradient(45deg, #ed8936, #dd6b20);
            --danger-gradient: linear-gradient(45deg, #f56565, #e53e3e);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 16px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Komari é£æ ¼å¤´éƒ¨ */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .status-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .status-pill {
            background: var(--glass-bg);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .status-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .status-pill i {
            margin-right: 6px;
            color: #667eea;
        }

        /* ç³»ç»ŸçŠ¶æ€ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--secondary-gradient);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.4);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.4rem;
            color: white;
            position: relative;
        }

        .stat-icon::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background: inherit;
            filter: blur(8px);
            opacity: 0.3;
            z-index: -1;
        }

        .stat-icon.cpu { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .stat-icon.memory { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .stat-icon.disk { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .stat-icon.network { background: linear-gradient(45deg, #f093fb, #f5576c); }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            margin-top: 16px;
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-fill.low { background: var(--success-gradient); }
        .progress-fill.medium { background: var(--warning-gradient); }
        .progress-fill.high { background: var(--danger-gradient); }

        /* è®¾å¤‡ç›‘æ§åŒºåŸŸ */
        .devices-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
        }

        .devices-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .devices-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .devices-header i {
            margin-right: 12px;
            color: #667eea;
            animation: devicePulse 2s infinite;
        }

        @keyframes devicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .device-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .device-count {
            background: var(--secondary-gradient);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .refresh-indicator {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .refresh-indicator i {
            margin-right: 4px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* è®¾å¤‡å¡ç‰‡ç½‘æ ¼ */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            min-height: 200px;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--success-gradient);
        }

        .device-card.warning::before {
            background: var(--warning-gradient);
        }

        .device-card.danger::before {
            background: var(--danger-gradient);
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .device-avatar {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .device-avatar::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 12px;
            background: inherit;
            filter: blur(8px);
            opacity: 0.3;
            z-index: -1;
        }

        .device-avatar.ios { background: linear-gradient(45deg, #007AFF, #5856D6); }
        .device-avatar.android { background: linear-gradient(45deg, #3DDC84, #4285F4); }
        .device-avatar.windows { background: linear-gradient(45deg, #0078D4, #106EBE); }
        .device-avatar.macos { background: linear-gradient(45deg, #007AFF, #A77BF3); }
        .device-avatar.linux { background: linear-gradient(45deg, #FCC624, #E95420); }
        .device-avatar.unknown { background: linear-gradient(45deg, #6C757D, #495057); }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .device-ip {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .device-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
        }

        .device-status.active {
            background: #48bb78;
            animation: statusPulse 2s infinite;
        }

        .device-status.idle {
            background: #ed8936;
            animation: statusPulse 3s infinite;
        }

        .device-status.inactive {
            background: #f56565;
            animation: statusBlink 1s infinite;
        }

        @keyframes statusPulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        @keyframes statusBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .device-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-detail {
            text-align: center;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .device-vendor {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* ç©ºçŠ¶æ€ */
        .no-devices {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            grid-column: 1 / -1;
        }

        .no-devices i {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
            color: #667eea;
        }

        .no-devices h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .no-devices p {
            font-size: 0.9rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .status-pills {
                justify-content: center;
            }
            
            .devices-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .device-stats {
                align-self: stretch;
                justify-content: space-between;
            }
            
            body {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .device-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .device-avatar {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 20px;
        }

        .loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error-message {
            background: rgba(245, 101, 101, 0.1);
            color: #f56565;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #f56565;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Komari é£æ ¼å¤´éƒ¨ -->
        <div class="header">
            <h1>Komari Monitor</h1>
            <div class="subtitle">å®æ—¶è®¾å¤‡è¿æ¥ç›‘æ§ - æ–­è¿è‡ªåŠ¨æ¶ˆï¿½ï¿½ - å®Œæ•´ä¼˜åŒ–ç‰ˆ</div>
            <div class="status-pills">
                <div class="status-pill">
                    <i class="fas fa-server"></i>
                    <span id="hostname">åŠ è½½ä¸­...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-clock"></i>
                    <span id="uptime">åŠ è½½ä¸­...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-time">åŠ è½½ä¸­...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="load-avg">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ç›‘æ§å¡ç‰‡ -->
        <div class="stats-grid">
            <!-- CPU ç›‘æ§ -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon cpu">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">CPU ä½¿ç”¨ç‡</div>
                        <div class="stat-value" id="cpu-percent">0%</div>
                        <div class="stat-subtitle">
                            <span id="cpu-cores">0</span> æ ¸å¿ƒ | 
                            <span id="cpu-freq">0</span> MHz
                        </div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="cpu-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- å†…å­˜ç›‘æ§ -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon memory">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">å†…å­˜ä½¿ç”¨</div>
                        <div class="stat-value" id="memory-percent">0%</div>
                        <div class="stat-subtitle">
                            <span id="memory-used">0</span>GB / 
                            <span id="memory-total">0</span>GB
                        </div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="memory-progress" class="progress-fill low" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- ç£ç›˜ç›‘æ§ -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon disk">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title">ç£ç›˜ä½¿ç”¨</div>
                        <div class="stat-value" id="disk-percent">0%</div>
                        <div class="stat-subtitle">
                            <span id="disk-used">0</span>GB / 
                            <span id="disk-total">0</span>GB
                        </div>
                    </div>
                </div>
                <div class="progress-container">
