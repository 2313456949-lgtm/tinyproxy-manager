#!/bin/bash

# ============================================
# Komari ËÆæÂ§áÁõëÊéßÊé¢Èíà - ÂÆåÊï¥ÂÆâË£ÖËÑöÊú¨ v3.0
# ÂäüËÉΩÔºö‰∏Ä‰ΩìÂåñÊµÅÈáèÁõëÊéß + ËÆæÂ§áÁõëÊéß + ‰∏ÄÈîÆÂç∏ËΩΩ
# ============================================

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ÈÖçÁΩÆÂèÇÊï∞
INSTALL_DIR="/opt/komari_monitor"
SERVICE_NAME="komari_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000
SCRIPT_VERSION="3.0"

# ÊâìÂç∞ÁæéÂåñÊ®™ÂπÖ
print_banner() {
    clear
    echo -e "${PURPLE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                                                                  ‚ïë"
    echo "‚ïë         üå∏ Komari Monitor v${SCRIPT_VERSION} - ‰∏Ä‰ΩìÂåñÁõëÊéßÊé¢Èíà üå∏         ‚ïë"
    echo "‚ïë                                                                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    echo -e "${CYAN}‚ú® Ê†∏ÂøÉÂäüËÉΩÔºö${NC}"
    echo "  üì± ÂÆûÊó∂ËøûÊé•ËÆæÂ§áÊòæÁ§∫ (‰ªøx-uiÈ£éÊ†º)"
    echo "  üîå Êñ≠ËøûËá™Âä®Ê∂àÂ§± (30ÁßíË∂ÖÊó∂)"
    echo "  üìä ‰∏Ä‰ΩìÂåñÊµÅÈáèÁõëÊéß (ÂÆûÊó∂ÈÄüÂ∫¶ + ÊúàÂ∫¶ÁªüËÆ°)"
    echo "  üéØ Êô∫ËÉΩËÆæÂ§áËØÜÂà´ (iOS/Android/Windows/macOS)"
    echo "  üè∑Ô∏è ÂéÇÂïÜÊ£ÄÊµã (Apple/Samsung/Xiaomi/Huawei)"
    echo "  üé® Komari Áé∞‰ª£ÁïåÈù¢È£éÊ†º (ÊØõÁéªÁíÉÊïàÊûú)"
    echo "  üîÑ ÂÆûÊó∂Êõ¥Êñ∞ (2ÁßíÈó¥Èöî)"
    echo "  üóëÔ∏è ‰∏ÄÈîÆÂç∏ËΩΩÂäüËÉΩ"
    echo ""
}

# ÊòæÁ§∫ËèúÂçï
show_menu() {
    echo -e "${WHITE}ËØ∑ÈÄâÊã©Êìç‰ΩúÔºö${NC}"
    echo -e "  ${GREEN}[1]${NC} ÂÆâË£Ö Komari ÁõëÊéßÊé¢Èíà"
    echo -e "  ${RED}[2]${NC} Âç∏ËΩΩ Komari ÁõëÊéßÊé¢Èíà"
    echo -e "  ${BLUE}[3]${NC} Êü•ÁúãËøêË°åÁä∂ÊÄÅ"
    echo -e "  ${YELLOW}[4]${NC} ÈáçÂêØÊúçÂä°"
    echo -e "  ${CYAN}[5]${NC} Êü•ÁúãÊó•Âøó"
    echo -e "  ${PURPLE}[0]${NC} ÈÄÄÂá∫"
    echo ""
    read -p "$(echo -e ${WHITE}ËØ∑ËæìÂÖ•ÈÄâÊã© [0-5]: ${NC})" choice
}

# Ê£ÄÊü•ÊùÉÈôê
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}‚ùå ÈîôËØØÔºöÊ≠§ËÑöÊú¨ÈúÄË¶Å root ÊùÉÈôêËøêË°å${NC}"
        echo -e "${YELLOW}ËØ∑‰ΩøÁî®: sudo $0${NC}"
        exit 1
    fi
}

# Ê£ÄÊµãÁ≥ªÁªü
detect_system() {
    echo -e "${YELLOW}üîç Ê£ÄÊµãÁ≥ªÁªüÁéØÂ¢É...${NC}"
    
    if [[ -f /etc/debian_version ]]; then
        OS="debian"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
        echo -e "  ${GREEN}‚úì${NC} Á≥ªÁªüÁ±ªÂûã: Debian/Ubuntu"
    elif [[ -f /etc/redhat-release ]]; then
        OS="redhat"
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y -q"
        INSTALL_CMD="yum install -y"
        echo -e "  ${GREEN}‚úì${NC} Á≥ªÁªüÁ±ªÂûã: RedHat/CentOS"
    else
        echo -e "${YELLOW}‚ö†Ô∏è Êú™ËØÜÂà´ÁöÑÁ≥ªÁªüÔºåÂ∞ùËØï‰ΩøÁî® apt${NC}"
        OS="unknown"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
    fi
}

# ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
install_dependencies() {
    echo -e "${YELLOW}[1/6] ÂÆâË£ÖÁ≥ªÁªü‰æùËµñÂåÖ...${NC}"
    
    $UPDATE_CMD > /dev/null 2>&1
    
    if [[ $OS == "debian" ]]; then
        $INSTALL_CMD python3 python3-pip curl wget psmisc net-tools iproute2 lsof > /dev/null 2>&1
    else
        $INSTALL_CMD python3 python3-pip curl wget psmisc net-tools iproute2 lsof > /dev/null 2>&1
    fi
    
    # È™åËØÅÂÖ≥ÈîÆÂ∑•ÂÖ∑
    echo -e "  ${CYAN}üì¶ Ê£ÄÊü•ÂÖ≥ÈîÆÂ∑•ÂÖ∑...${NC}"
    local tools=("python3" "pip3" "netstat" "ss" "arp")
    for tool in "${tools[@]}"; do
        if command -v $tool >/dev/null 2>&1; then
            echo -e "    ${GREEN}‚úì${NC} $tool"
        else
            echo -e "    ${RED}‚úó${NC} $tool Êú™ÊâæÂà∞"
        fi
    done
    
    echo -e "  ${GREEN}‚úì Á≥ªÁªü‰æùËµñÂÆâË£ÖÂÆåÊàê${NC}"
}

# ÂàõÂª∫È°πÁõÆÁªìÊûÑ
create_project() {
    echo -e "${YELLOW}[2/6] ÂàõÂª∫È°πÁõÆÁõÆÂΩïÁªìÊûÑ...${NC}"
    
    # Â§á‰ªΩÊóßÁâàÊú¨
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "  ${YELLOW}ÂèëÁé∞ÊóßÁâàÊú¨ÔºåÂàõÂª∫Â§á‰ªΩ...${NC}"
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    
    # ÂàõÂª∫ÁõÆÂΩïÁªìÊûÑ
    mkdir -p "$INSTALL_DIR"/{templates,logs,config}
    cd "$INSTALL_DIR"
    
    # ÂàõÂª∫ÈÖçÁΩÆÊñá‰ª∂
    cat <<EOF > config/settings.json
{
    "monthly_limit_gb": ${MONTHLY_LIMIT_GB},
    "update_interval": 2,
    "connection_timeout": 30,
    "web_port": ${WEB_PORT},
    "max_devices": 100,
    "log_level": "INFO",
    "version": "${SCRIPT_VERSION}",
    "theme": "komari"
}
EOF
    
    echo -e "  ${GREEN}‚úì È°πÁõÆÁõÆÂΩïÂàõÂª∫ÂÆåÊàê${NC}"
}

# ÁîüÊàêÂêéÁ´Ø‰ª£Á†Å
create_backend() {
    echo -e "${YELLOW}[3/6] ÁîüÊàê Komari ÁõëÊéßÂêéÁ´Ø...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import subprocess
import re
import os
import logging
from datetime import datetime
from flask import Flask, render_template, jsonify
import psutil
import socket

app = Flask(__name__)

# ÈÖçÁΩÆÊó•Âøó
os.makedirs('logs', exist_ok=True)
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/monitor.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Âä†ËΩΩÈÖçÁΩÆ
try:
    with open('config/settings.json', 'r') as f:
        CONFIG = json.load(f)
except:
    CONFIG = {
        'monthly_limit_gb': 1000,
        'update_interval': 2,
        'connection_timeout': 30,
        'web_port': 5000,
        'max_devices': 100,
        'version': '3.0'
    }

# ÂÖ®Â±ÄÂèòÈáè
last_network_io = None
network_history = []

class SystemMonitor:
    @staticmethod
    def get_cpu_info():
        try:
            cpu_percent = psutil.cpu_percent(interval=0.1)
            cpu_count = psutil.cpu_count()
            cpu_freq = psutil.cpu_freq()
            load_avg = os.getloadavg() if hasattr(os, 'getloadavg') else (0, 0, 0)
            
            return {
                'percent': round(cpu_percent, 1),
                'count': cpu_count,
                'freq': round(cpu_freq.current, 0) if cpu_freq else 0,
                'load_avg': [round(x, 2) for x in load_avg]
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñCPU‰ø°ÊÅØÂ§±Ë¥•: {e}")
            return {'percent': 0, 'count': 0, 'freq': 0, 'load_avg': [0, 0, 0]}
    
    @staticmethod
    def get_memory_info():
        try:
            memory = psutil.virtual_memory()
            return {
                'percent': round(memory.percent, 1),
                'total': round(memory.total / (1024**3), 2),
                'used': round(memory.used / (1024**3), 2),
                'available': round(memory.available / (1024**3), 2)
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÂÜÖÂ≠ò‰ø°ÊÅØÂ§±Ë¥•: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'available': 0}
    
    @staticmethod
    def get_disk_info():
        try:
            disk = psutil.disk_usage('/')
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2)
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÁ£ÅÁõò‰ø°ÊÅØÂ§±Ë¥•: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0}
    
    @staticmethod
    def get_network_stats():
        global last_network_io, network_history
        
        try:
            current_time = time.time()
            net_io = psutil.net_io_counters()
            
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            limit = CONFIG['monthly_limit_gb']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            # ËÆ°ÁÆóÂÆûÊó∂ÈÄüÂ∫¶
            speed_sent_mbps = 0
            speed_recv_mbps = 0
            
            if last_network_io is not None:
                time_diff = current_time - last_network_io['time']
                if time_diff > 0:
                    speed_sent_mbps = ((net_io.bytes_sent - last_network_io['bytes_sent']) * 8) / (time_diff * 1024 * 1024)
                    speed_recv_mbps = ((net_io.bytes_recv - last_network_io['bytes_recv']) * 8) / (time_diff * 1024 * 1024)
            
            last_network_io = {
                'time': current_time,
                'bytes_sent': net_io.bytes_sent,
                'bytes_recv': net_io.bytes_recv
            }
            
            # Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
            network_history.append({
                'time': current_time,
                'sent_speed': speed_sent_mbps,
                'recv_speed': speed_recv_mbps
            })
            
            # ‰øùÁïôÊúÄËøë10ÂàÜÈíüÊï∞ÊçÆ
            cutoff_time = current_time - 600
            network_history = [h for h in network_history if h['time'] > cutoff_time]
            
            return {
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit,
                'speed_sent_mbps': round(speed_sent_mbps, 2),
                'speed_recv_mbps': round(speed_recv_mbps, 2),
                'speed_total_mbps': round(speed_sent_mbps + speed_recv_mbps, 2),
                'packets_sent': net_io.packets_sent,
                'packets_recv': net_io.packets_recv,
                'speed_history': network_history[-30:] if len(network_history) > 30 else network_history
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÁΩëÁªúÁªüËÆ°Â§±Ë¥•: {e}")
            return {
                'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['monthly_limit_gb'],
                'speed_sent_mbps': 0, 'speed_recv_mbps': 0, 'speed_total_mbps': 0,
                'packets_sent': 0, 'packets_recv': 0, 'speed_history': []
            }

class DeviceMonitor:
    connection_history = {}
    device_cache = {}
    
    OUI_DATABASE = {
        'AC:DE:48': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '28:CD:C1': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        'F0:18:98': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '24:DA:9B': {'vendor': 'Apple', 'type': 'MacBook', 'os': 'macOS', 'icon': 'fas fa-laptop', 'color': '#A77BF3'},
        'DC:37:54': {'vendor': 'Samsung', 'type': 'GalaxyÊâãÊú∫', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#3DDC84'},
        '5C:0A:5B': {'vendor': 'Xiaomi', 'type': 'Â∞èÁ±≥ÊâãÊú∫', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF6900'},
        '50:8F:4C': {'vendor': 'Huawei', 'type': 'Âçé‰∏∫ÊâãÊú∫', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF0000'},
    }
    
    @staticmethod
    def get_device_info_by_ip(ip):
        if ip in DeviceMonitor.device_cache:
            cache_time = DeviceMonitor.device_cache[ip].get('cache_time', 0)
            if time.time() - cache_time < 300:
                return DeviceMonitor.device_cache[ip]['data']
        
        device_info = {
            'ip': ip,
            'hostname': 'Êú™Áü•ËÆæÂ§á',
            'mac_address': 'Êú™Ëé∑Âèñ',
            'device_type': 'Êú™Áü•ËÆæÂ§á',
            'os_type': 'Unknown',
            'vendor': 'Êú™Áü•ÂéÇÂïÜ',
            'icon': 'fas fa-question-circle',
            'device_class': 'unknown',
            'color': '#6C757D'
        }
        
        try:
            # DNS Êü•ËØ¢
            try:
                hostname, _, _ = socket.gethostbyaddr(ip)
                device_info['hostname'] = hostname
                
                hostname_lower = hostname.lower()
                if any(x in hostname_lower for x in ['iphone', 'ipad', 'ios']):
                    device_info.update({
                        'device_type': 'iPhone/iPad',
                        'os_type': 'iOS',
                        'vendor': 'Apple',
                        'icon': 'fab fa-apple',
                        'device_class': 'ios',
                        'color': '#007AFF'
                    })
                elif any(x in hostname_lower for x in ['xiaomi', 'mi-', 'redmi']):
                    device_info.update({
                        'device_type': 'Â∞èÁ±≥ÊâãÊú∫',
                        'os_type': 'Android',
                        'vendor': 'Xiaomi',
                        'icon': 'fas fa-mobile-alt',
                        'device_class': 'android',
                        'color': '#FF6900'
                    })
                elif any(x in hostname_lower for x in ['android', 'phone']):
                    device_info.update({
                        'device_type': 'AndroidÊâãÊú∫',
                        'os_type': 'Android',
                        'icon': 'fab fa-android',
                        'device_class': 'android',
                        'color': '#3DDC84'
                    })
                elif any(x in hostname_lower for x in ['windows', 'pc']):
                    device_info.update({
                        'device_type': 'WindowsÁîµËÑë',
                        'os_type': 'Windows',
                        'icon': 'fab fa-windows',
                        'device_class': 'windows',
                        'color': '#0078D4'
                    })
            except:
                pass
            
            # MAC Âú∞ÂùÄËé∑Âèñ
            mac_commands = [
                f"arp -n {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $3}}'",
                f"ip neigh show {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $5}}'"
            ]
            
            for cmd in mac_commands:
                try:
                    result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=2)
                    if result.returncode == 0 and result.stdout.strip():
                        mac_raw = result.stdout.strip()
                        mac_clean = re.sub(r'[^0-9A-Fa-f]', '', mac_raw)
                        if len(mac_clean) == 12:
                            mac = ':'.join([mac_clean[i:i+2] for i in range(0, 12, 2)]).upper()
                            device_info['mac_address'] = mac
                            
                            oui = mac[:8]
                            if oui in DeviceMonitor.OUI_DATABASE:
                                oui_info = DeviceMonitor.OUI_DATABASE[oui]
                                device_info.update({
                                    'vendor': oui_info['vendor'],
                                    'device_type': oui_info['type'],
                                    'os_type': oui_info['os'],
                                    'icon': oui_info['icon'],
                                    'device_class': oui_info['os'].lower(),
                                    'color': oui_info['color']
                                })
                            break
                except:
                    continue
                    
        except Exception as e:
            logger.error(f"Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØÂ§±Ë¥• {ip}: {e}")
        
        DeviceMonitor.device_cache[ip] = {
            'data': device_info.copy(),
            'cache_time': time.time()
        }
        
        return device_info
    
    @staticmethod
    def get_active_connections():
        current_time = time.time()
        
        try:
            cmd = """netstat -tn 2>/dev/null | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        count = int(parts[0])
                        ip = parts[1]
                        
                        if not (ip.startswith('127.') or ip == '0.0.0.0'):
                            DeviceMonitor._update_connection_history(ip, count, current_time)
            
            # Ê∏ÖÁêÜË∂ÖÊó∂ËøûÊé•
            timeout_threshold = current_time - CONFIG['connection_timeout']
            expired_ips = [ip for ip, info in DeviceMonitor.connection_history.items() 
                          if info['last_seen'] < timeout_threshold]
            
            for ip in expired_ips:
                del DeviceMonitor.connection_history[ip]
                if ip in DeviceMonitor.device_cache:
                    del DeviceMonitor.device_cache[ip]
            
            # ÁîüÊàêËÆæÂ§áÂàóË°®
            device_list = []
            for ip, info in DeviceMonitor.connection_history.items():
                device_info = DeviceMonitor.get_device_info_by_ip(ip)
                
                connection_duration = current_time - info['first_seen']
                time_since_last = current_time - info['last_seen']
                signal_strength = max(10, 100 - int(time_since_last * 5))
                
                if time_since_last < 5:
                    status, status_text = 'active', 'Ê¥ªË∑É'
                elif time_since_last < 15:
                    status, status_text = 'idle', 'Á©∫Èó≤'
                else:
                    status, status_text = 'inactive', 'Âç≥Â∞ÜÊñ≠ÂºÄ'
                
                device = {
                    'ip': ip,
                    'hostname': device_info['hostname'],
                    'device_type': device_info['device_type'],
                    'os_type': device_info['os_type'],
                    'vendor': device_info['vendor'],
                    'mac_address': device_info['mac_address'],
                    'icon': device_info['icon'],
                    'device_class': device_info['device_class'],
                    'color': device_info['color'],
                    'connection_count': info['connection_count'],
                    'connection_duration': int(connection_duration),
                    'status': status,
                    'status_text': status_text,
                    'signal_strength': signal_strength,
                    'first_seen_time': datetime.fromtimestamp(info['first_seen']).strftime('%H:%M:%S'),
                    'last_seen_time': datetime.fromtimestamp(info['last_seen']).strftime('%H:%M:%S')
                }
                
                device_list.append(device)
            
            return sorted(device_list, key=lambda x: x['connection_count'], reverse=True)[:CONFIG['max_devices']]
            
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÊ¥ªË∑ÉËøûÊé•ÈîôËØØ: {e}")
            return []
    
    @staticmethod
    def _update_connection_history(ip, count, current_time):
        if ip not in DeviceMonitor.connection_history:
            DeviceMonitor.connection_history[ip] = {
                'first_seen': current_time,
                'last_seen': current_time,
                'connection_count': count
            }
        else:
            history = DeviceMonitor.connection_history[ip]
            history['last_seen'] = current_time
            history['connection_count'] = max(history['connection_count'], count)

class SystemInfo:
    @staticmethod
    def get_system_info():
        try:
            uptime_cmd = subprocess.run(['uptime', '-p'], capture_output=True, text=True)
            uptime = uptime_cmd.stdout.strip() if uptime_cmd.returncode == 0 else "Êú™Áü•"
            
            hostname = socket.gethostname()
            load_avg = os.getloadavg() if hasattr(os, 'getloadavg') else (0, 0, 0)
            boot_time = datetime.fromtimestamp(psutil.boot_time())
            
            return {
                'hostname': hostname,
                'uptime': uptime,
                'platform': f"{psutil.platform.system()} {psutil.platform.release()}",
                'boot_time': boot_time.strftime('%Y-%m-%d %H:%M:%S'),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [round(x, 2) for x in load_avg],
                'total_processes': len(psutil.pids())
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØÂ§±Ë¥•: {e}")
            return {
                'hostname': 'Êú™Áü•', 'uptime': 'Êú™Áü•', 'platform': 'Êú™Áü•',
                'boot_time': 'Êú™Áü•', 'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [0, 0, 0], 'total_processes': 0
            }

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    try:
        start_time = time.time()
        
        data = {
            'system': SystemInfo.get_system_info(),
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': SystemMonitor.get_network_stats(),
            'active_devices': DeviceMonitor.get_active_connections(),
            'config': CONFIG,
            'timestamp': time.time(),
            'api_response_time': round((time.time() - start_time) * 1000, 2)
        }
        
        return jsonify(data)
        
    except Exception as e:
        logger.error(f"API ÈîôËØØ: {e}")
        return jsonify({'error': str(e), 'timestamp': time.time()}), 500

if __name__ == '__main__':
    logger.info("üå∏ Komari ËÆæÂ§áÁõëÊéßÊé¢ÈíàÂêØÂä®‰∏≠...")
    logger.info(f"üìä Web Èù¢Êùø: http://0.0.0.0:{CONFIG['web_port']}")
    logger.info(f"üå∏ Komari È£éÊ†º‰∏Ä‰ΩìÂåñÁõëÊéß")
    
    app.run(host='0.0.0.0', port=CONFIG['web_port'], debug=False, threaded=True)
EOF

    chmod +x app.py
    echo -e "  ${GREEN}‚úì Komari ÁõëÊéßÂêéÁ´ØÁîüÊàêÂÆåÊàê${NC}"
}

# ÁîüÊàêÂâçÁ´Ø‰ª£Á†Å
create_frontend() {
    echo -e "${YELLOW}[4/6] ÁîüÊàê Komari ‰∏Ä‰ΩìÂåñÂâçÁ´Ø...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Komari Monitor</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --komari-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --komari-secondary: linear-gradient(45deg, #667eea, #764ba2);
            --komari-success: linear-gradient(45deg, #48bb78, #38a169);
            --komari-warning: linear-gradient(45deg, #ed8936, #dd6b20);
            --komari-danger: linear-gradient(45deg, #f56565, #e53e3e);
            --komari-glass: rgba(255, 255, 255, 0.95);
            --komari-border: rgba(255, 255, 255, 0.18);
            --komari-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --komari-text: #2d3748;
            --komari-text-light: #718096;
            --komari-radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--komari-primary);
            min-height: 100vh;
            padding: 16px;
            color: var(--komari-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--komari-secondary);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--komari-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            animation: headerGlow 4s ease-in-out infinite alternate;
        }

        @keyframes headerGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .header .subtitle {
            color: var(--komari-text-light);
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-pills {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .status-pill {
            background: var(--komari-glass);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--komari-text);
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
        }

        .status-pill:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .status-pill i {
            margin-right: 8px;
            color: #667eea;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .system-monitor, .network-monitor {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--komari-radius);
            padding: 24px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
        }

        .monitor-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .monitor-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--komari-text);
        }

        .monitor-header i {
            margin-right: 12px;
            color: #667eea;
            font-size: 1.4rem;
        }

        .system-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card-small {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .stat-card-small::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .stat-card-small.cpu::before { background: var(--komari-danger); }
        .stat-card-small.memory::before { background: var(--komari-success); }
        .stat-card-small.disk::before { background: var(--komari-warning); }
        .stat-card-small.network-basic::before { background: var(--komari-secondary); }

        .stat-card-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-header-small {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-icon-small {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            color: white;
        }

        .stat-icon-small.cpu { background: var(--komari-danger); }
        .stat-icon-small.memory { background: var(--komari-success); }
        .stat-icon-small.disk { background: var(--komari-warning); }
        .stat-icon-small.network-basic { background: var(--komari-secondary); }

        .stat-info-small { flex: 1; }

        .stat-title-small {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--komari-text);
            margin-bottom: 4px;
        }

        .stat-value-small {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--komari-text);
        }

        .progress-container-small { margin-top: 8px; }

        .progress-bar-small {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            height: 6px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease;
        }

        .progress-fill-small.low { background: var(--komari-success); }
        .progress-fill-small.medium { background: var(--komari-warning); }
        .progress-fill-small.high { background: var(--komari-danger); }

        .traffic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .traffic-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .traffic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .traffic-icon {
            width: 50px; height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 1.5rem;
            color: white;
        }

        .traffic-icon.upload { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .traffic-icon.download { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .traffic-icon.total { background: linear-gradient(45deg, #667eea, #764ba2); }

        .traffic-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--komari-text);
            margin-bottom: 4px;
        }

        .traffic-label {
            color: var(--komari-text-light);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .traffic-speed {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
        }

        .monthly-usage {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--komari-border);
            backdrop-filter: blur(10px);
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .usage-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--komari-text);
        }

        .usage-percent {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar-large {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
        }

        .progress-fill-large {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            background: var(--komari-secondary);
        }

        .usage-details {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .usage-used {
            color: var(--komari-text);
            font-weight: 600;
        }

        .usage-remaining {
            color: var(--komari-text-light);
        }

        .devices-section {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--komari-radius);
            padding: 24px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
            grid-column: 1 / -1;
        }

        .devices-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .devices-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--komari-text);
            display: flex;
            align-items: center;
        }

        .devices-header i {
            margin-right: 12px;
            color: #667eea;
            animation: devicePulse 2s infinite;
        }

        @keyframes devicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .device-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .device-count {
            background: var(--komari-secondary);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .refresh-indicator {
            display: flex;
            align-items: center;
            color: var(--komari-text-light);
            font-size: 0.8rem;
        }

        .refresh-indicator i {
            margin-right: 6px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            min-height: 200px;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 14px;
            padding: 18px;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--komari-success);
        }

        .device-card.warning::before { background: var(--komari-warning); }
        .device-card.danger::before { background: var(--komari-danger); }

        .device-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 14px;
        }

        .device-avatar {
            width: 56px; height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .device-info { flex: 1; }

        .device-name {
            font-weight: 700;
            color: var(--komari-text);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .device-ip {
            color: var(--komari-text-light);
            font-size: 0.875rem;
            font-family: 'SF Mono', Monaco, monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .device-status {
            position: absolute;
            top: 14px; right: 14px;
            width: 14px; height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
        }

        .device-status.active {
            background: #48bb78;
            animation: statusPulse 2s infinite;
        }

        .device-status.idle {
            background: #ed8936;
            animation: statusPulse 3s infinite;
        }

        .device-status.inactive {
            background: #f56565;
            animation: statusBlink 1s infinite;
        }

        @keyframes statusPulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        @keyframes statusBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .device-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-detail { text-align: center; }

        .detail-value {
            font-weight: 700;
            color: var(--komari-text);
            font-size: 0.9rem;
        }

        .detail-label {
            color: var(--komari-text-light);
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .no-devices {
            text-align: center;
            padding: 60px 20px;
            color: var(--komari-text-light);
            grid-column: 1 / -1;
        }

        .no-devices i {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
            color: #667eea;
        }

        .no-devices h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--komari-text);
        }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .system-stats-grid { grid-template-columns: 1fr; }
            .traffic-grid { grid-template-columns: 1fr; }
            .devices-grid { grid-template-columns: 1fr; }
            .devices-header { flex-direction: column; gap: 12px; }
            body { padding: 8px; }
            .header h1 { font-size: 2rem; }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--komari-text-light);
            font-style: italic;
            padding: 20px;
        }

        .loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ Komari Monitor</h1>
            <div class="subtitle">ÂÆûÊó∂ËÆæÂ§áËøûÊé•ÁõëÊéß + ‰∏Ä‰ΩìÂåñÊµÅÈáèÂàÜÊûê</div>
            <div class="status-pills">
                <div class="status-pill">
                    <i class="fas fa-server"></i>
                    <span id="hostname">Âä†ËΩΩ‰∏≠...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-clock"></i>
                    <span id="uptime">Âä†ËΩΩ‰∏≠...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-time">Âä†ËΩΩ‰∏≠...</span>
                </div>
                <div class="status-pill">
                    <i class="fas fa-tachometer-alt"></i>
                    Ë¥üËΩΩ: <span id="load-avg">Âä†ËΩΩ‰∏≠...</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="system-monitor">
                <div class="monitor-header">
                    <h2><i class="fas fa-chart-area"></i>Á≥ªÁªüÁä∂ÊÄÅ</h2>
                </div>
                <div class="system-stats-grid">
                    <div class="stat-card-small cpu">
                        <div class="stat-header-small">
                            <div class="stat-icon-small cpu">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="stat-info-small">
                                <div class="stat-title-small">CPU</div>
                                <div class="stat-value-small" id="cpu-percent">0%</div>
                            </div>
                        </div>
                        <div class="progress-container-small">
                            <div class="progress-bar-small">
                                <div id="cpu-progress" class="progress-fill-small low" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card-small memory">
                        <div class="stat-header-small">
                            <div class="stat-icon-small memory">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="stat-info-small">
                                <div class="stat-title-small">ÂÜÖÂ≠ò</div>
                                <div class="stat-value-small" id="memory-percent">0%</div>
                            </div>
                        </div>
                        <div class="progress-container-small">
                            <div class="progress-bar-small">
                                <div id="memory-progress" class="progress-fill-small low" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card-small disk">
                        <div class="stat-header-small">
                            <div class="stat-icon-small disk">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="stat-info-small">
                                <div class="stat-title-small">Á£ÅÁõò</div>
                                <div class="stat-value-small" id="disk-percent">0%</div>
                            </div>
                        </div>
                        <div class="progress-container-small">
                            <div class="progress-bar-small">
                                <div id="disk-progress" class="progress-fill-small low" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card-small network-basic">
                        <div class="stat-header-small">
                            <div class="stat-icon-small network-basic">
                                <i class="fas fa-wifi"></i>
                            </div>
                            <div class="stat-info-small">
                                <div class="stat-title-small">ÁΩëÁªú</div>
                                <div class="stat-value-small" id="network-speed-total">0 Mbps</div>
                            </div>
                        </div>
                        <div class="progress-container-small">
                            <div class="progress-bar-small">
                                <div id="network-progress" class="progress-fill-small low" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="network-monitor">
                <div class="monitor-header">
                    <h2><i class="fas fa-chart-line"></i>ÊµÅÈáèÁõëÊéß</h2>
                </div>
                
                <div class="traffic-grid">
                    <div class="traffic-card">
                        <div class="traffic-icon upload">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="traffic-value" id="traffic-sent">0 GB</div>
                        <div class="traffic-label">ÊÄª‰∏ä‰º†</div>
                        <div class="traffic-speed">‚Üë <span id="speed-sent">0</span> Mbps</div>
                    </div>

                    <div class="traffic-card">
                        <div class="traffic-icon download">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="traffic-value" id="traffic-received">0 GB</div>
                        <div class="traffic-label">ÊÄª‰∏ãËΩΩ</div>
                        <div class="traffic-speed">‚Üì <span id="speed-received">0</span> Mbps</div>
                    </div>

                    <div class="traffic-card">
                        <div class="traffic-icon total">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="traffic-value" id="traffic-total">0 GB</div>
                        <div class="traffic-label">ÊÄªÊµÅÈáè</div>
                        <div class="traffic-speed"><span id="speed-total">0</span> Mbps</div>
                    </div>
                </div>

                <div class="monthly-usage">
                    <div class="usage-header">
                        <div class="usage-title">üìä ÊúàÂ∫¶‰ΩøÁî®ÊÉÖÂÜµ</div>
                        <div class="usage-percent" id="usage-percent">0%</div>
                    </div>
                    <div class="progress-bar-large">
                        <div id="usage-progress" class="progress-fill-large" style="width: 0%;"></div>
                    </div>
                    <div class="usage-details">
                        <div class="usage-used">Â∑≤‰ΩøÁî®: <span id="usage-used">0 GB</span></div>
                        <div class="usage-remaining">Ââ©‰Ωô: <span id="usage-remaining">0 GB</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="devices-section">
            <div class="devices-header">
                <h2><i class="fas fa-mobile-alt"></i>ËøûÊé•ËÆæÂ§á</h2>
                <div class="device-stats">
                    <div class="device-count" id="device-count">0 Âè∞ËÆæÂ§á</div>
                    <div class="refresh-indicator">
                        <i class="fas fa-sync-alt"></i>
                        ÂÆûÊó∂Êõ¥Êñ∞
                    </div>
                </div>
            </div>
            <div class="devices-grid" id="devices-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    Ê≠£Âú®Êâ´ÊèèËÆæÂ§á...
                </div>
            </div>
        </div>
    </div>

    <script>
        const KomariMonitor = {
            updateInterval: 2000,
            
            updateText(id, text) {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            },
            
            updateProgress(id, percent) {
                const element = document.getElementById(id);
                if (element) {
                    element.style.width = percent + '%';
                    element.className = 'progress-fill-small';
                    if (percent > 80) element.classList.add('high');
                    else if (percent > 60) element.classList.add('medium');
                    else element.classList.add('low');
                }
            },
            
            formatSpeed(mbps) {
                if (mbps < 1) return (mbps * 1000).toFixed(0) + ' Kbps';
                return mbps.toFixed(2) + ' Mbps';
            },
            
            getDeviceAvatarStyle(device) {
                return `background: ${device.color || '#6C757D'}`;
            },
            
            updateDevices(devices) {
                const grid = document.getElementById('devices-grid');
                const count = document.getElementById('device-count');
                
                count.textContent = `${devices.length} Âè∞ËÆæÂ§á`;
                
                if (devices.length === 0) {
                    grid.innerHTML = `
                        <div class="no-devices">
                            <i class="fas fa-wifi"></i>
                            <h3>ÊöÇÊó†ËÆæÂ§áËøûÊé•</h3>
                            <p>ÂΩìËÆæÂ§áËøûÊé•Âà∞ÊúçÂä°Âô®Êó∂ÔºåÂ∞ÜÂú®Ê≠§ÊòæÁ§∫</p>
                        </div>
                    `;
                    return;
                }
                
                const html = devices.map(device => `
                    <div class="device-card ${device.status === 'inactive' ? 'danger' : device.status === 'idle' ? 'warning' : ''}">
                        <div class="device-status ${device.status}"></div>
                        <div class="device-header">
                            <div class="device-avatar" style="${this.getDeviceAvatarStyle(device)}">
                                <i class="${device.icon}"></i>
                            </div>
                            <div class="device-info">
                                <div class="device-name">${device.hostname !== 'Êú™Áü•ËÆæÂ§á' ? device.hostname : device.device_type}</div>
                                <div class="device-ip">${device.ip}</div>
                            </div>
                        </div>
                        <div class="device-details">
                            <div class="device-detail">
                                <div class="detail-value">${device.connection_count}</div>
                                <div class="detail-label">ËøûÊé•Êï∞</div>
                            </div>
                            <div class="device-detail">
                                <div class="detail-value">${Math.floor(device.connection_duration / 60)}m</div>
                                <div class="detail-label">Âú®Á∫øÊó∂Èïø</div>
                            </div>
                            <div class="device-detail">
                                <div class="detail-value">${device.status_text}</div>
                                <div class="detail-label">Áä∂ÊÄÅ</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                grid.innerHTML = html;
            },
            
            updateData() {
                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    timeout: 10000,
                    success: (data) => {
                        // Êõ¥Êñ∞Á≥ªÁªü‰ø°ÊÅØ
                        if (data.system) {
                            this.updateText('hostname', data.system.hostname);
                            this.updateText('uptime', data.system.uptime);
                            this.updateText('current-time', data.system.current_time);
                            this.updateText('load-avg', data.system.load_avg.join(', '));
                        }
                        
                        // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
                        if (data.cpu) {
                            this.updateText('cpu-percent', data.cpu.percent + '%');
                            this.updateProgress('cpu-progress', data.cpu.percent);
                        }
                        
                        if (data.memory) {
                            this.updateText('memory-percent', data.memory.percent + '%');
                            this.updateProgress('memory-progress', data.memory.percent);
                        }
                        
                        if (data.disk) {
                            this.
