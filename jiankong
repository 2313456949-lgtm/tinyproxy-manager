#!/bin/bash

# ============================================
# Komari è®¾å¤‡ç›‘æ§æ¢é’ˆ - æœ€ç»ˆå®Œæ•´ç‰ˆ v3.0
# åŠŸèƒ½ï¼šä¸€ä½“åŒ–æµé‡ç›‘æ§ + è®¾å¤‡ç›‘æ§ + ä¸€é”®å¸è½½
# ============================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/komari_monitor"
SERVICE_NAME="komari_monitor"
WEB_PORT=5000
MONTHLY_LIMIT_GB=1000
SCRIPT_VERSION="3.0"

# æ‰“å°ç¾åŒ–æ¨ªå¹…
print_banner() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                                  â•‘"
    echo "â•‘         ğŸŒ¸ Komari Monitor v${SCRIPT_VERSION} - ä¸€ä½“åŒ–ç›‘æ§æ¢é’ˆ ğŸŒ¸         â•‘"
    echo "â•‘                                                                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${CYAN}âœ¨ æ ¸å¿ƒåŠŸèƒ½ï¼š${NC}"
    echo "  ğŸ“± å®æ—¶è¿æ¥è®¾å¤‡æ˜¾ç¤º (ä»¿x-uié£æ ¼)"
    echo "  ğŸ”Œ æ–­è¿è‡ªåŠ¨æ¶ˆå¤± (30ç§’è¶…æ—¶)"
    echo "  ğŸ“Š ä¸€ä½“åŒ–æµé‡ç›‘æ§ (å®æ—¶é€Ÿåº¦ + æœˆåº¦ç»Ÿè®¡)"
    echo "  ğŸ¯ æ™ºèƒ½è®¾å¤‡è¯†åˆ« (iOS/Android/Windows/macOS)"
    echo "  ğŸ·ï¸ å‚å•†æ£€æµ‹ (Apple/Samsung/Xiaomi/Huawei)"
    echo "  ğŸ¨ Komari ç°ä»£ç•Œé¢é£æ ¼ (æ¯›ç»ç’ƒæ•ˆæœ)"
    echo "  ğŸ”„ å®æ—¶æ›´æ–° (2ç§’é—´éš”)"
    echo "  ğŸ—‘ï¸ ä¸€é”®å¸è½½åŠŸèƒ½"
    echo ""
}

# æ˜¾ç¤ºèœå•
show_menu() {
    echo -e "${WHITE}è¯·é€‰æ‹©æ“ä½œï¼š${NC}"
    echo -e "  ${GREEN}[1]${NC} å®‰è£… Komari ç›‘æ§æ¢é’ˆ"
    echo -e "  ${RED}[2]${NC} å¸è½½ Komari ç›‘æ§æ¢é’ˆ"
    echo -e "  ${BLUE}[3]${NC} æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo -e "  ${YELLOW}[4]${NC} é‡å¯æœåŠ¡"
    echo -e "  ${CYAN}[5]${NC} æŸ¥çœ‹æ—¥å¿—"
    echo -e "  ${PURPLE}[0]${NC} é€€å‡º"
    echo ""
    read -p "$(echo -e ${WHITE}è¯·è¾“å…¥é€‰æ‹© [0-5]: ${NC})" choice
}

# æ£€æŸ¥æƒé™
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ${NC}"
        echo -e "${YELLOW}è¯·ä½¿ç”¨: sudo $0${NC}"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿ
detect_system() {
    echo -e "${YELLOW}ğŸ” æ£€æµ‹ç³»ç»Ÿç¯å¢ƒ...${NC}"
    
    if [[ -f /etc/debian_version ]]; then
        OS="debian"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
        echo -e "  ${GREEN}âœ“${NC} ç³»ç»Ÿç±»å‹: Debian/Ubuntu"
    elif [[ -f /etc/redhat-release ]]; then
        OS="redhat"
        PKG_MANAGER="yum"
        UPDATE_CMD="yum update -y -q"
        INSTALL_CMD="yum install -y"
        echo -e "  ${GREEN}âœ“${NC} ç³»ç»Ÿç±»å‹: RedHat/CentOS"
    else
        echo -e "${YELLOW}âš ï¸ æœªè¯†åˆ«çš„ç³»ç»Ÿï¼Œå°è¯•ä½¿ç”¨ apt${NC}"
        OS="unknown"
        PKG_MANAGER="apt"
        UPDATE_CMD="apt update -qq"
        INSTALL_CMD="apt install -y"
    fi
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${YELLOW}[1/6] å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…...${NC}"
    
    $UPDATE_CMD > /dev/null 2>&1
    
    if [[ $OS == "debian" ]]; then
        $INSTALL_CMD python3 python3-pip python3-venv curl wget psmisc net-tools iproute2 lsof arp-scan dnsutils > /dev/null 2>&1
    else
        $INSTALL_CMD python3 python3-pip curl wget psmisc net-tools iproute2 lsof bind-utils > /dev/null 2>&1
    fi
    
    # éªŒè¯å…³é”®å·¥å…·
    echo -e "  ${CYAN}ğŸ“¦ æ£€æŸ¥å…³é”®å·¥å…·...${NC}"
    local tools=("python3" "pip3" "netstat" "ss" "arp")
    for tool in "${tools[@]}"; do
        if command -v $tool >/dev/null 2>&1; then
            echo -e "    ${GREEN}âœ“${NC} $tool"
        else
            echo -e "    ${RED}âœ—${NC} $tool æœªæ‰¾åˆ°"
        fi
    done
    
    echo -e "  ${GREEN}âœ“ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# åˆ›å»ºé¡¹ç›®ç»“æ„
create_project() {
    echo -e "${YELLOW}[2/6] åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„...${NC}"
    
    # å¤‡ä»½æ—§ç‰ˆæœ¬
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "  ${YELLOW}å‘ç°æ—§ç‰ˆæœ¬ï¼Œåˆ›å»ºå¤‡ä»½...${NC}"
        mv "$INSTALL_DIR" "${INSTALL_DIR}.backup.$(date +%s)"
    fi
    
    # åˆ›å»ºç›®å½•ç»“æ„
    mkdir -p "$INSTALL_DIR"/{templates,static/{css,js,img},logs,config}
    cd "$INSTALL_DIR"
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    cat <<EOF > config/settings.json
{
    "monthly_limit_gb": ${MONTHLY_LIMIT_GB},
    "update_interval": 2,
    "connection_timeout": 30,
    "web_port": ${WEB_PORT},
    "max_devices": 100,
    "log_level": "INFO",
    "version": "${SCRIPT_VERSION}",
    "theme": "komari"
}
EOF
    
    echo -e "  ${GREEN}âœ“ é¡¹ç›®ç›®å½•åˆ›å»ºå®Œæˆ${NC}"
}

# ç”Ÿæˆå®Œæ•´åç«¯ä»£ç 
create_backend() {
    echo -e "${YELLOW}[3/6] ç”Ÿæˆ Komari ç›‘æ§åç«¯...${NC}"
    
    cat <<'EOF' > app.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Komari è®¾å¤‡ç›‘æ§æ¢é’ˆ - æœ€ç»ˆå®Œæ•´ç‰ˆ v3.0
åŠŸèƒ½ï¼šä¸€ä½“åŒ–æµé‡ç›‘æ§ + è®¾å¤‡ç›‘æ§ + ç°ä»£ç•Œé¢
"""

import json
import time
import subprocess
import re
import os
import logging
from datetime import datetime, timedelta
from flask import Flask, render_template, jsonify
import psutil
import socket
from collections import defaultdict
import threading

app = Flask(__name__)

# é…ç½®æ—¥å¿—
os.makedirs('logs', exist_ok=True)
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/monitor.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# åŠ è½½é…ç½®
try:
    with open('config/settings.json', 'r') as f:
        CONFIG = json.load(f)
except:
    CONFIG = {
        'monthly_limit_gb': 1000,
        'update_interval': 2,
        'connection_timeout': 30,
        'web_port': 5000,
        'max_devices': 100,
        'version': '3.0'
    }

# å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å†å²æ•°æ®
network_history = []
last_network_io = None

class SystemMonitor:
    """ç³»ç»Ÿç›‘æ§æ ¸å¿ƒç±»"""
    
    @staticmethod
    def get_cpu_info():
        """è·å– CPU è¯¦ç»†ä¿¡æ¯"""
        try:
            cpu_percent = psutil.cpu_percent(interval=0.1)
            cpu_count = psutil.cpu_count()
            cpu_freq = psutil.cpu_freq()
            load_avg = os.getloadavg() if hasattr(os, 'getloadavg') else (0, 0, 0)
            
            return {
                'percent': round(cpu_percent, 1),
                'count': cpu_count,
                'freq': round(cpu_freq.current, 0) if cpu_freq else 0,
                'usage_per_cpu': [round(x, 1) for x in psutil.cpu_percent(interval=0.1, percpu=True)],
                'load_avg': [round(x, 2) for x in load_avg]
            }
        except Exception as e:
            logger.error(f"è·å–CPUä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'count': 0, 'freq': 0, 'usage_per_cpu': [], 'load_avg': [0, 0, 0]}
    
    @staticmethod
    def get_memory_info():
        """è·å–å†…å­˜è¯¦ç»†ä¿¡æ¯"""
        try:
            memory = psutil.virtual_memory()
            swap = psutil.swap_memory()
            
            return {
                'percent': round(memory.percent, 1),
                'total': round(memory.total / (1024**3), 2),
                'used': round(memory.used / (1024**3), 2),
                'available': round(memory.available / (1024**3), 2),
                'cached': round((memory.cached if hasattr(memory, 'cached') else 0) / (1024**3), 2),
                'swap_percent': round(swap.percent, 1),
                'swap_total': round(swap.total / (1024**3), 2),
                'swap_used': round(swap.used / (1024**3), 2)
            }
        except Exception as e:
            logger.error(f"è·å–å†…å­˜ä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'available': 0, 'cached': 0, 'swap_percent': 0, 'swap_total': 0, 'swap_used': 0}
    
    @staticmethod
    def get_disk_info():
        """è·å–ç£ç›˜è¯¦ç»†ä¿¡æ¯"""
        try:
            disk = psutil.disk_usage('/')
            disk_io = psutil.disk_io_counters()
            
            return {
                'percent': round(disk.percent, 1),
                'total': round(disk.total / (1024**3), 2),
                'used': round(disk.used / (1024**3), 2),
                'free': round(disk.free / (1024**3), 2),
                'read_mb': round(disk_io.read_bytes / (1024**2), 2) if disk_io else 0,
                'write_mb': round(disk_io.write_bytes / (1024**2), 2) if disk_io else 0,
                'read_count': disk_io.read_count if disk_io else 0,
                'write_count': disk_io.write_count if disk_io else 0
            }
        except Exception as e:
            logger.error(f"è·å–ç£ç›˜ä¿¡æ¯å¤±è´¥: {e}")
            return {'percent': 0, 'total': 0, 'used': 0, 'free': 0, 'read_mb': 0, 'write_mb': 0, 'read_count': 0, 'write_count': 0}
    
    @staticmethod
    def get_network_stats():
        """è·å–ç½‘ç»œæµé‡ç»Ÿè®¡ - ä¸€ä½“åŒ–ç‰ˆæœ¬"""
        global last_network_io, network_history
        
        try:
            current_time = time.time()
            net_io = psutil.net_io_counters()
            
            # åŸºç¡€æ•°æ®
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            total_used = sent_gb + recv_gb
            
            # æœˆåº¦é™åˆ¶è®¡ç®—
            limit = CONFIG['monthly_limit_gb']
            remaining = max(0, limit - total_used)
            percent = min(100, (total_used / limit) * 100)
            
            # å®æ—¶é€Ÿåº¦è®¡ç®—
            speed_sent_mbps = 0
            speed_recv_mbps = 0
            speed_total_mbps = 0
            
            if last_network_io is not None:
                time_diff = current_time - last_network_io['time']
                if time_diff > 0:
                    speed_sent_mbps = ((net_io.bytes_sent - last_network_io['bytes_sent']) * 8) / (time_diff * 1024 * 1024)  # Mbps
                    speed_recv_mbps = ((net_io.bytes_recv - last_network_io['bytes_recv']) * 8) / (time_diff * 1024 * 1024)  # Mbps
                    speed_total_mbps = speed_sent_mbps + speed_recv_mbps
            
            # æ›´æ–°å†å²è®°å½•
            last_network_io = {
                'time': current_time,
                'bytes_sent': net_io.bytes_sent,
                'bytes_recv': net_io.bytes_recv
            }
            
            # ä¿ç•™æœ€è¿‘10åˆ†é’Ÿçš„å†å²æ•°æ®
            network_history.append({
                'time': current_time,
                'sent_speed': speed_sent_mbps,
                'recv_speed': speed_recv_mbps,
                'total_speed': speed_total_mbps
            })
            
            # æ¸…ç†æ—§æ•°æ® (ä¿ç•™10åˆ†é’Ÿ)
            cutoff_time = current_time - 600
            network_history = [h for h in network_history if h['time'] > cutoff_time]
            
            # è®¡ç®—å¹³å‡é€Ÿåº¦
            avg_speeds = {
                'avg_sent_1min': 0,
                'avg_recv_1min': 0,
                'avg_total_1min': 0,
                'avg_sent_5min': 0,
                'avg_recv_5min': 0,
                'avg_total_5min': 0
            }
            
            if network_history:
                # 1åˆ†é’Ÿå¹³å‡
                one_min_data = [h for h in network_history if h['time'] > current_time - 60]
                if one_min_data:
                    avg_speeds['avg_sent_1min'] = sum(h['sent_speed'] for h in one_min_data) / len(one_min_data)
                    avg_speeds['avg_recv_1min'] = sum(h['recv_speed'] for h in one_min_data) / len(one_min_data)
                    avg_speeds['avg_total_1min'] = sum(h['total_speed'] for h in one_min_data) / len(one_min_data)
                
                # 5åˆ†é’Ÿå¹³å‡
                five_min_data = [h for h in network_history if h['time'] > current_time - 300]
                if five_min_data:
                    avg_speeds['avg_sent_5min'] = sum(h['sent_speed'] for h in five_min_data) / len(five_min_data)
                    avg_speeds['avg_recv_5min'] = sum(h['recv_speed'] for h in five_min_data) / len(five_min_data)
                    avg_speeds['avg_total_5min'] = sum(h['total_speed'] for h in five_min_data) / len(five_min_data)
            
            # å³°å€¼é€Ÿåº¦
            max_speeds = {
                'max_sent': max([h['sent_speed'] for h in network_history], default=0),
                'max_recv': max([h['recv_speed'] for h in network_history], default=0),
                'max_total': max([h['total_speed'] for h in network_history], default=0)
            }
            
            # ç½‘ç»œæ¥å£ä¿¡æ¯
            interfaces = []
            try:
                for interface, stats in psutil.net_io_counters(pernic=True).items():
                    if interface != 'lo':  # æ’é™¤å›ç¯æ¥å£
                        interfaces.append({
                            'name': interface,
                            'sent_gb': round(stats.bytes_sent / (1024**3), 3),
                            'recv_gb': round(stats.bytes_recv / (1024**3), 3),
                            'packets_sent': stats.packets_sent,
                            'packets_recv': stats.packets_recv,
                            'errors_in': stats.errin,
                            'errors_out': stats.errout,
                            'drops_in': stats.dropin,
                            'drops_out': stats.dropout
                        })
            except:
                pass
            
            return {
                # åŸºç¡€æµé‡ç»Ÿè®¡
                'sent': round(sent_gb, 3),
                'received': round(recv_gb, 3),
                'total_used': round(total_used, 3),
                'remaining': round(remaining, 3),
                'percent': round(percent, 1),
                'limit': limit,
                
                # å®æ—¶é€Ÿåº¦ (Mbps)
                'speed_sent_mbps': round(speed_sent_mbps, 2),
                'speed_recv_mbps': round(speed_recv_mbps, 2),
                'speed_total_mbps': round(speed_total_mbps, 2),
                
                # å¹³å‡é€Ÿåº¦
                **{k: round(v, 2) for k, v in avg_speeds.items()},
                
                # å³°å€¼é€Ÿåº¦
                **{k: round(v, 2) for k, v in max_speeds.items()},
                
                # åŒ…ç»Ÿè®¡
                'packets_sent': net_io.packets_sent,
                'packets_recv': net_io.packets_recv,
                'errors_in': net_io.errin,
                'errors_out': net_io.errout,
                'drops_in': net_io.dropin,
                'drops_out': net_io.dropout,
                
                # æ¥å£ä¿¡æ¯
                'interfaces': interfaces,
                
                # å†å²æ•°æ® (ç”¨äºå‰ç«¯å›¾è¡¨)
                'speed_history': network_history[-30:] if len(network_history) > 30 else network_history  # æœ€è¿‘30ä¸ªæ•°æ®ç‚¹
            }
        except Exception as e:
            logger.error(f"è·å–ç½‘ç»œç»Ÿè®¡å¤±è´¥: {e}")
            return {
                'sent': 0, 'received': 0, 'total_used': 0, 'remaining': 0, 'percent': 0, 'limit': CONFIG['monthly_limit_gb'],
                'speed_sent_mbps': 0, 'speed_recv_mbps': 0, 'speed_total_mbps': 0,
                'avg_sent_1min': 0, 'avg_recv_1min': 0, 'avg_total_1min': 0,
                'avg_sent_5min': 0, 'avg_recv_5min': 0, 'avg_total_5min': 0,
                'max_sent': 0, 'max_recv': 0, 'max_total': 0,
                'packets_sent': 0, 'packets_recv': 0, 'errors_in': 0, 'errors_out': 0,
                'drops_in': 0, 'drops_out': 0, 'interfaces': [], 'speed_history': []
            }

class DeviceMonitor:
    """è®¾å¤‡è¿æ¥ç›‘æ§ç±»"""
    
    connection_history = {}
    device_cache = {}
    
    # æ›´å®Œæ•´çš„ OUI æ•°æ®åº“
    OUI_DATABASE = {
        # Apple è®¾å¤‡
        'AC:DE:48': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '28:CD:C1': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        'F0:18:98': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '3C:28:6D': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '40:CB:C0': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '28:CF:E9': {'vendor': 'Apple', 'type': 'iPhone/iPad', 'os': 'iOS', 'icon': 'fab fa-apple', 'color': '#007AFF'},
        '24:DA:9B': {'vendor': 'Apple', 'type': 'MacBook', 'os': 'macOS', 'icon': 'fas fa-laptop', 'color': '#A77BF3'},
        '88:E9:FE': {'vendor': 'Apple', 'type': 'MacBook', 'os': 'macOS', 'icon': 'fas fa-laptop', 'color': '#A77BF3'},
        
        # Samsung è®¾å¤‡
        'DC:37:54': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#3DDC84'},
        '28:6A:BA': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#3DDC84'},
        'C4:57:6E': {'vendor': 'Samsung', 'type': 'Galaxyæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#3DDC84'},
        
        # å°ç±³è®¾å¤‡
        '5C:0A:5B': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF6900'},
        '34:CE:00': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF6900'},
        '50:E6:66': {'vendor': 'Xiaomi', 'type': 'å°ç±³æ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF6900'},
        
        # åä¸ºè®¾å¤‡
        '50:8F:4C': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF0000'},
        '00:E0:FC': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF0000'},
        '34:6B:D3': {'vendor': 'Huawei', 'type': 'åä¸ºæ‰‹æœº', 'os': 'Android', 'icon': 'fas fa-mobile-alt', 'color': '#FF0000'},
        
        # OPPO/OnePlus/VIVO
        '40:4E:36': {'vendor': 'OPPO', 'type': 'OPPOæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#1BA784'},
        'AC:E2:D3': {'vendor': 'OnePlus', 'type': 'OnePlusæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#EB0028'},
        '14:AB:C5': {'vendor': 'VIVO', 'type': 'VIVOæ‰‹æœº', 'os': 'Android', 'icon': 'fab fa-android', 'color': '#4285F4'},
    }
    
    @staticmethod
    def get_device_info_by_ip(ip):
        """è·å–è®¾å¤‡ä¿¡æ¯ - å¢å¼ºç‰ˆ"""
        
        # æ£€æŸ¥ç¼“å­˜
        if ip in DeviceMonitor.device_cache:
            cache_time = DeviceMonitor.device_cache[ip].get('cache_time', 0)
            if time.time() - cache_time < 300:  # 5åˆ†é’Ÿç¼“å­˜
                return DeviceMonitor.device_cache[ip]['data']
        
        device_info = {
            'ip': ip,
            'hostname': 'æœªçŸ¥è®¾å¤‡',
            'mac_address': 'æœªè·å–',
            'device_type': 'æœªçŸ¥è®¾å¤‡',
            'os_type': 'Unknown',
            'vendor': 'æœªçŸ¥å‚å•†',
            'icon': 'fas fa-question-circle',
            'device_class': 'unknown',
            'color': '#6C757D'
        }
        
        try:
            # 1. DNS åå‘æŸ¥è¯¢
            try:
                hostname, _, _ = socket.gethostbyaddr(ip)
                device_info['hostname'] = hostname
                
                # æ™ºèƒ½è®¾å¤‡ç±»å‹æ¨æµ‹
                hostname_lower = hostname.lower()
                if any(x in hostname_lower for x in ['iphone', 'ipad', 'ios']):
                    device_info.update({
                        'device_type': 'iPhone/iPad',
                        'os_type': 'iOS',
                        'vendor': 'Apple',
                        'icon': 'fab fa-apple',
                        'device_class': 'ios',
                        'color': '#007AFF'
                    })
                elif any(x in hostname_lower for x in ['xiaomi', 'mi-', 'redmi']):
                    device_info.update({
                        'device_type': 'å°ç±³æ‰‹æœº',
                        'os_type': 'Android',
                        'vendor': 'Xiaomi',
                        'icon': 'fas fa-mobile-alt',
                        'device_class': 'android',
                        'color': '#FF6900'
                    })
                elif any(x in hostname_lower for x in ['android', 'phone']):
                    device_info.update({
                        'device_type': 'Androidæ‰‹æœº',
                        'os_type': 'Android',
                        'icon': 'fab fa-android',
                        'device_class': 'android',
                        'color': '#3DDC84'
                    })
                # ... å…¶ä»–è®¾å¤‡ç±»å‹åˆ¤æ–­
                    
            except:
                pass
            
            # 2. MAC åœ°å€è·å–
            mac_commands = [
                f"arp -n {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $3}}'",
                f"ip neigh show {ip} 2>/dev/null | grep -E '([0-9a-fA-F]{{2}}[:-]){{5}}[0-9a-fA-F]{{2}}' | awk '{{print $5}}'",
            ]
            
            for cmd in mac_commands:
                try:
                    result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=3)
                    if result.returncode == 0 and result.stdout.strip():
                        mac_raw = result.stdout.strip()
                        mac_clean = re.sub(r'[^0-9A-Fa-f]', '', mac_raw)
                        if len(mac_clean) == 12:
                            mac = ':'.join([mac_clean[i:i+2] for i in range(0, 12, 2)]).upper()
                            device_info['mac_address'] = mac
                            
                            # OUI åŒ¹é…
                            oui = mac[:8]
                            if oui in DeviceMonitor.OUI_DATABASE:
                                oui_info = DeviceMonitor.OUI_DATABASE[oui]
                                device_info.update({
                                    'vendor': oui_info['vendor'],
                                    'device_type': oui_info['type'],
                                    'os_type': oui_info['os'],
                                    'icon': oui_info['icon'],
                                    'device_class': oui_info['os'].lower(),
                                    'color': oui_info['color']
                                })
                            break
                except:
                    continue
                    
        except Exception as e:
            logger.error(f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ {ip}: {e}")
        
        # ç¼“å­˜ç»“æœ
        DeviceMonitor.device_cache[ip] = {
            'data': device_info.copy(),
            'cache_time': time.time()
        }
        
        return device_info
    
    @staticmethod
    def get_active_connections():
        """è·å–æ´»è·ƒè¿æ¥è®¾å¤‡"""
        current_time = time.time()
        
        try:
            # ä½¿ç”¨ netstat è·å–è¿æ¥
            cmd = """netstat -tn 2>/dev/null | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | grep -v '127.0.0.1' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort | uniq -c | sort -nr"""
            
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
            
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        count = int(parts[0])
                        ip = parts[1]
                        
                        if not (ip.startswith('127.') or ip == '0.0.0.0'):
                            DeviceMonitor._update_connection_history(ip, count, current_time)
            
            # æ¸…ç†è¶…æ—¶è¿æ¥
            timeout_threshold = current_time - CONFIG['connection_timeout']
            expired_ips = [ip for ip, info in DeviceMonitor.connection_history.items() 
                          if info['last_seen'] < timeout_threshold]
            
            for ip in expired_ips:
                del DeviceMonitor.connection_history[ip]
                if ip in DeviceMonitor.device_cache:
                    del DeviceMonitor.device_cache[ip]
            
            # ç”Ÿæˆè®¾å¤‡åˆ—è¡¨
            device_list = []
            for ip, info in DeviceMonitor.connection_history.items():
                device_info = DeviceMonitor.get_device_info_by_ip(ip)
                
                connection_duration = current_time - info['first_seen']
                time_since_last = current_time - info['last_seen']
                signal_strength = max(10, 100 - int(time_since_last * 5))
                
                if time_since_last < 5:
                    status, status_text = 'active', 'æ´»è·ƒ'
                elif time_since_last < 15:
                    status, status_text = 'idle', 'ç©ºé—²'
                else:
                    status, status_text = 'inactive', 'å³å°†æ–­å¼€'
                
                device = {
                    'ip': ip,
                    'hostname': device_info['hostname'],
                    'device_type': device_info['device_type'],
                    'os_type': device_info['os_type'],
                    'vendor': device_info['vendor'],
                    'mac_address': device_info['mac_address'],
                    'icon': device_info['icon'],
                    'device_class': device_info['device_class'],
                    'color': device_info['color'],
                    'connection_count': info['connection_count'],
                    'total_connections': info.get('total_connections', info['connection_count']),
                    'connection_duration': int(connection_duration),
                    'status': status,
                    'status_text': status_text,
                    'signal_strength': signal_strength,
                    'first_seen_time': datetime.fromtimestamp(info['first_seen']).strftime('%H:%M:%S'),
                    'last_seen_time': datetime.fromtimestamp(info['last_seen']).strftime('%H:%M:%S')
                }
                
                device_list.append(device)
            
            return sorted(device_list, key=lambda x: x['connection_count'], reverse=True)[:CONFIG['max_devices']]
            
        except Exception as e:
            logger.error(f"è·å–æ´»è·ƒè¿æ¥é”™è¯¯: {e}")
            return []
    
    @staticmethod
    def _update_connection_history(ip, count, current_time):
        """æ›´æ–°è¿æ¥å†å²"""
        if ip not in DeviceMonitor.connection_history:
            DeviceMonitor.connection_history[ip] = {
                'first_seen': current_time,
                'last_seen': current_time,
                'connection_count': count,
                'total_connections': count
            }
        else:
            history = DeviceMonitor.connection_history[ip]
            history['last_seen'] = current_time
            history['connection_count'] = max(history['connection_count'], count)
            history['total_connections'] = history.get('total_connections', 0) + count

class SystemInfo:
    """ç³»ç»Ÿä¿¡æ¯ç±»"""
    
    @staticmethod
    def get_system_info():
        """è·å–ç³»ç»Ÿä¿¡æ¯"""
        try:
            uptime_cmd = subprocess.run(['uptime', '-p'], capture_output=True, text=True)
            uptime = uptime_cmd.stdout.strip() if uptime_cmd.returncode == 0 else "æœªçŸ¥"
            
            hostname = socket.gethostname()
            load_avg = os.getloadavg() if hasattr(os, 'getloadavg') else (0, 0, 0)
            boot_time = datetime.fromtimestamp(psutil.boot_time())
            
            return {
                'hostname': hostname,
                'uptime': uptime,
                'platform': f"{psutil.platform.system()} {psutil.platform.release()}",
                'boot_time': boot_time.strftime('%Y-%m-%d %H:%M:%S'),
                'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [round(x, 2) for x in load_avg],
                'python_version': f"{psutil.sys.version_info.major}.{psutil.sys.version_info.minor}",
                'total_processes': len(psutil.pids())
            }
        except Exception as e:
            logger.error(f"è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥: {e}")
            return {
                'hostname': 'æœªçŸ¥', 'uptime': 'æœªçŸ¥', 'platform': 'æœªçŸ¥',
                'boot_time': 'æœªçŸ¥', 'current_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'load_avg': [0, 0, 0], 'python_version': 'æœªçŸ¥', 'total_processes': 0
            }

# Flask è·¯ç”±
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/stats')
def api_stats():
    try:
        start_time = time.time()
        
        data = {
            'system': SystemInfo.get_system_info(),
            'cpu': SystemMonitor.get_cpu_info(),
            'memory': SystemMonitor.get_memory_info(),
            'disk': SystemMonitor.get_disk_info(),
            'network': SystemMonitor.get_network_stats(),
            'active_devices': DeviceMonitor.get_active_connections(),
            'config': CONFIG,
            'timestamp': time.time(),
            'api_response_time': round((time.time() - start_time) * 1000, 2)
        }
        
        return jsonify(data)
        
    except Exception as e:
        logger.error(f"API é”™è¯¯: {e}")
        return jsonify({'error': str(e), 'timestamp': time.time()}), 500

if __name__ == '__main__':
    logger.info("ğŸŒ¸ Komari è®¾å¤‡ç›‘æ§æ¢é’ˆå¯åŠ¨ä¸­...")
    logger.info(f"ğŸ“Š Web é¢æ¿: http://0.0.0.0:{CONFIG['web_port']}")
    logger.info(f"ğŸ”„ æ›´æ–°é—´éš”: {CONFIG['update_interval']} ç§’")
    logger.info(f"ğŸŒ¸ Komari é£æ ¼ä¸€ä½“åŒ–ç›‘æ§")
    
    app.run(host='0.0.0.0', port=CONFIG['web_port'], debug=False, threaded=True)
EOF

    chmod +x app.py
    echo -e "  ${GREEN}âœ“ Komari ç›‘æ§åç«¯ç”Ÿæˆå®Œæˆ${NC}"
}

# ç”Ÿæˆä¸€ä½“åŒ–å‰ç«¯
create_frontend() {
    echo -e "${YELLOW}[4/6] ç”Ÿæˆ Komari ä¸€ä½“åŒ–å‰ç«¯...${NC}"
    
    cat <<'EOF' > templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ Komari Monitor - ä¸€ä½“åŒ–ç›‘æ§</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        /* Komari ä¸€ä½“åŒ–æ ·å¼ */
        :root {
            --komari-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --komari-secondary: linear-gradient(45deg, #667eea, #764ba2);
            --komari-success: linear-gradient(45deg, #48bb78, #38a169);
            --komari-warning: linear-gradient(45deg, #ed8936, #dd6b20);
            --komari-danger: linear-gradient(45deg, #f56565, #e53e3e);
            --komari-glass: rgba(255, 255, 255, 0.95);
            --komari-border: rgba(255, 255, 255, 0.18);
            --komari-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --komari-text: #2d3748;
            --komari-text-light: #718096;
            --komari-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--komari-primary);
            min-height: 100vh;
            padding: 16px;
            color: var(--komari-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ç¾åŒ–å¤´éƒ¨ */
        .header {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--komari-secondary);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--komari-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            animation: headerGlow 4s ease-in-out infinite alternate;
        }

        @keyframes headerGlow {
            from { filter: brightness(1) drop-shadow(0 0 20px rgba(102, 126, 234, 0.3)); }
            to { filter: brightness(1.2) drop-shadow(0 0 30px rgba(102, 126, 234, 0.5)); }
        }

        .header .subtitle {
            color: var(--komari-text-light);
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-pills {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .status-pill {
            background: var(--komari-glass);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--komari-text);
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            position: relative;
        }

        .status-pill:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .status-pill i {
            margin-right: 8px;
            color: #667eea;
        }

        /* ä¸»è¦ç½‘æ ¼å¸ƒå±€ */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ç³»ç»Ÿç›‘æ§åŒºåŸŸ */
        .system-monitor {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--komari-radius);
            padding: 24px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
        }

        .monitor-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .monitor-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--komari-text);
        }

        .monitor-header i {
            margin-right: 12px;
            color: #667eea;
            font-size: 1.4rem;
        }

        /* ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç½‘æ ¼ */
        .system-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card-small {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .stat-card-small::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .stat-card-small.cpu::before { background: var(--komari-danger); }
        .stat-card-small.memory::before { background: var(--komari-success); }
        .stat-card-small.disk::before { background: var(--komari-warning); }
        .stat-card-small.network-basic::before { background: var(--komari-secondary); }

        .stat-card-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-header-small {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-icon-small {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            color: white;
        }

        .stat-icon-small.cpu { background: var(--komari-danger); }
        .stat-icon-small.memory { background: var(--komari-success); }
        .stat-icon-small.disk { background: var(--komari-warning); }
        .stat-icon-small.network-basic { background: var(--komari-secondary); }

        .stat-info-small {
            flex: 1;
        }

        .stat-title-small {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--komari-text);
            margin-bottom: 4px;
        }

        .stat-value-small {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--komari-text);
        }

        .progress-container-small {
            margin-top: 8px;
        }

        .progress-bar-small {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            height: 6px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease;
        }

        .progress-fill-small.low { background: var(--komari-success); }
        .progress-fill-small.medium { background: var(--komari-warning); }
        .progress-fill-small.high { background: var(--komari-danger); }

        /* ç½‘ç»œæµé‡ä¸€ä½“åŒ–ç›‘æ§åŒºåŸŸ */
        .network-monitor {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--komari-radius);
            padding: 24px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
        }

        .network-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .network-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--komari-text);
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .speed-indicator {
            background: var(--komari-secondary);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: speedPulse 2s infinite;
        }

        @keyframes speedPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* æµé‡å¡ç‰‡ç½‘æ ¼ */
        .traffic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .traffic-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .traffic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .traffic-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 1.5rem;
            color: white;
        }

        .traffic-icon.upload { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .traffic-icon.download { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .traffic-icon.total { background: linear-gradient(45deg, #667eea, #764ba2); }

        .traffic-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--komari-text);
            margin-bottom: 4px;
        }

        .traffic-label {
            color: var(--komari-text-light);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .traffic-speed {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
        }

        /* æœˆåº¦ä½¿ç”¨æƒ…å†µ */
        .monthly-usage {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--komari-border);
            backdrop-filter: blur(10px);
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .usage-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--komari-text);
        }

        .usage-percent {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar-large {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill-large {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            background: var(--komari-secondary);
            position: relative;
        }

        .progress-fill-large::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .usage-details {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .usage-used {
            color: var(--komari-text);
            font-weight: 600;
        }

        .usage-remaining {
            color: var(--komari-text-light);
        }

        /* å®æ—¶é€Ÿåº¦å›¾è¡¨ */
        .speed-chart-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--komari-border);
            backdrop-filter: blur(10px);
            height: 300px;
        }

        .chart-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--komari-text);
            margin-bottom: 16px;
            text-align: center;
        }

        /* è®¾å¤‡ç›‘æ§åŒºåŸŸ */
        .devices-section {
            background: var(--komari-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--komari-radius);
            padding: 24px;
            box-shadow: var(--komari-shadow);
            border: 1px solid var(--komari-border);
            grid-column: 1 / -1;
        }

        .devices-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .devices-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--komari-text);
            display: flex;
            align-items: center;
        }

        .devices-header i {
            margin-right: 12px;
            color: #667eea;
            animation: devicePulse 2s infinite;
        }

        @keyframes devicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .device-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .device-count {
            background: var(--komari-secondary);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .refresh-indicator {
            display: flex;
            align-items: center;
            color: var(--komari-text-light);
            font-size: 0.8rem;
        }

        .refresh-indicator i {
            margin-right: 6px;
            animation: spin 1s linear infinite;
        }

        /* è®¾å¤‡å¡ç‰‡ç½‘æ ¼ */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            min-height: 200px;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 14px;
            padding: 18px;
            border: 1px solid var(--komari-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--komari-success);
        }

        .device-card.warning::before { background: var(--komari-warning); }
        .device-card.danger::before { background: var(--komari-danger); }

        .device-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 14px;
        }

        .device-avatar {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-size: 1.5rem;
            color: white;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 700;
            color: var(--komari-text);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .device-ip {
            color: var(--komari-text-light);
            font-size: 0.875rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .device-status {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
        }

        .device-status.active {
            background: #48bb78;
            animation: statusPulse 2s infinite;
        }

        .device-status.idle {
            background: #ed8936;
            animation: statusPulse 3s infinite;
        }

        .device-status.inactive {
            background: #f56565;
            animation: statusBlink 1s infinite;
        }

        .device-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-detail {
            text-align: center;
        }

        .detail-value {
            font-weight: 700;
            color: var(--komari-text);
            font-size: 0.9rem;
        }

        .detail-label {
            color: var(--komari-text-light);
