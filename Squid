#!/bin/bash

# ==================================================
# Squid 一键管理脚本
# ==================================================

RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

CONF_FILE="/etc/squid/squid.conf"
SCRIPT_PATH=$(readlink -f "$0")

# 获取服务器公网IPv4（禁用IPv6）
get_public_ip() {
    local ip=""
    ip=$(curl -4 -s --max-time 5 ifconfig.me 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 ip.sb 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 ipinfo.io/ip 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 api.ipify.org 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(hostname -I | awk '{print $1}')
    echo "$ip"
}

# 检查Root
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 请使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    else
        RELEASE="unknown"
    fi
    [[ "$RELEASE" == "unknown" ]] && echo -e "${RED}无法识别系统类型！${PLAIN}" && exit 1
}

# 安装
install_squid() {
    echo -e "${GREEN}正在安装 Squid...${PLAIN}"
    
    if [[ "$RELEASE" == "centos" ]]; then
        echo -e "${YELLOW}安装 squid...${PLAIN}"
        yum install -y squid
    else
        echo -e "${YELLOW}更新软件源...${PLAIN}"
        apt-get update
        echo -e "${YELLOW}安装 squid...${PLAIN}"
        apt-get install -y squid
    fi

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Squid 安装成功！${PLAIN}"
        
        cp "$SCRIPT_PATH" /usr/local/bin/Squid 2>/dev/null
        chmod +x /usr/local/bin/Squid 2>/dev/null
        echo -e "${YELLOW}提示: 以后可以直接输入 'Squid' 命令来管理${PLAIN}"
        
        # 备份原配置
        [[ -f $CONF_FILE ]] && cp $CONF_FILE ${CONF_FILE}.bak.$(date +%s)
        
        # 设置开机自启
        systemctl enable squid
        echo -e "${GREEN}已设置开机自启${PLAIN}"
        
        sleep 1
        configure_squid
    else
        echo -e "${RED}安装失败，请检查网络或软件源${PLAIN}"
        exit 1
    fi
}

# 配置
configure_squid() {
    echo -e ""
    echo -e "${YELLOW}========== 配置向导 ==========${PLAIN}"
    
    # 端口
    read -p "请输入监听端口 [默认 3128]: " port
    [[ -z "$port" ]] && port="3128"
    
    # 服务器IP（自动获取IPv4，可修改）
    echo -e ""
    echo -e "${YELLOW}正在获取服务器公网IP...${PLAIN}"
    local server_ip=$(get_public_ip)
    
    if [[ -n "$server_ip" ]]; then
        echo -e "检测到服务器IP: ${GREEN}$server_ip${PLAIN}"
        read -p "服务器IP [直接回车使用 $server_ip]: " input_ip
        [[ -n "$input_ip" ]] && server_ip="$input_ip"
    else
        echo -e "${RED}无法自动获取公网IP${PLAIN}"
        read -p "请手动输入服务器IP: " server_ip
        while [[ -z "$server_ip" ]]; do
            echo -e "${RED}服务器IP不能为空！${PLAIN}"
            read -p "请输入服务器IP: " server_ip
        done
    fi
    echo -e "${GREEN}服务器IP已设置: $server_ip${PLAIN}"
    
    # 客户端IP（手动输入）
    echo -e ""
    read -p "请输入允许连接的客户端IP: " client_ip
    while [[ -z "$client_ip" || ! "$client_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; do
        echo -e "${RED}客户端IP不能为空且格式需正确！${PLAIN}"
        read -p "请输入客户端IP (如 192.168.1.100): " client_ip
    done
    
    # 生成配置文件
    cat > $CONF_FILE << EOF
# Squid 配置文件
# 监听端口
http_port $port

# 允许的客户端IP
acl allowed_clients src $client_ip
http_access allow allowed_clients

# 拒绝其他所有访问
http_access deny all

# 禁用IPv6
dns_v4_first on

# 隐藏版本信息
httpd_suppress_version_string on

# 禁用 Via 头
via off

# 禁用 X-Forwarded-For
forwarded_for off

# 请求头隐藏
request_header_access From deny all
request_header_access Server deny all
request_header_access Referer deny all
request_header_access X-Forwarded-For deny all
request_header_access Via deny all

# 缓存设置
cache_mem 64 MB
maximum_object_size 4 MB
cache_dir ufs /var/spool/squid 100 16 256

# 日志设置
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# 连接超时
connect_timeout 60 seconds
read_timeout 60 seconds
request_timeout 60 seconds
EOF

    echo -e "${GREEN}配置文件已生成${PLAIN}"

    # 初始化缓存目录
    echo -e "${YELLOW}正在初始化缓存目录...${PLAIN}"
    squid -z 2>/dev/null

    echo -e ""
    echo -e "${YELLOW}正在重启服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    sleep 2
    systemctl start squid
    
    sleep 2
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}========== 配置完成 ==========${PLAIN}"
        echo -e ""
        echo -e "${BLUE}【代理信息】${PLAIN}"
        echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
        echo -e "监听端口: ${YELLOW}$port${PLAIN}"
        echo -e "客户端IP: ${YELLOW}$client_ip${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
        echo -e ""
        show_usage_with_ip "$server_ip" "$port"
    else
        echo -e "${RED}服务启动失败！错误信息：${PLAIN}"
        journalctl -u squid -n 15 --no-pager
        echo -e ""
        echo -e "${YELLOW}常见问题：${PLAIN}"
        echo -e "1. 端口被占用，请更换端口"
        echo -e "2. 配置文件错误，查看 $CONF_FILE"
        echo -e "3. 检查配置: squid -k parse"
    fi
}

# 卸载
uninstall_squid() {
    echo -e "${YELLOW}正在停止服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    systemctl disable squid 2>/dev/null
    
    echo -e "${YELLOW}正在卸载 Squid...${PLAIN}"
    if [[ "$RELEASE" == "centos" ]]; then
        yum remove -y squid
    else
        apt-get remove -y squid --purge
    fi
    
    rm -rf /etc/squid
    rm -rf /var/spool/squid
    rm -rf /var/log/squid
    rm -f /usr/local/bin/Squid
    echo -e "${GREEN}卸载完成！${PLAIN}"
}

# 启动
start_service() {
    echo -e "${YELLOW}正在启动服务...${PLAIN}"
    systemctl start squid
    sleep 2
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}服务已启动！${PLAIN}"
        show_status
    else
        echo -e "${RED}服务启动失败！${PLAIN}"
        journalctl -u squid -n 10 --no-pager
    fi
}

# 停止
stop_service() {
    echo -e "${YELLOW}正在停止服务...${PLAIN}"
    systemctl stop squid
    echo -e "${GREEN}服务已停止！${PLAIN}"
}

# 重启
restart_service() {
    echo -e "${YELLOW}正在重启服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    sleep 2
    systemctl start squid
    sleep 2
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}服务已重启！${PLAIN}"
        show_status
    else
        echo -e "${RED}服务重启失败！${PLAIN}"
        journalctl -u squid -n 10 --no-pager
    fi
}

# 状态
show_status() {
    echo -e ""
    if systemctl is-active --quiet squid; then
        local port=$(grep "^http_port" $CONF_FILE | awk '{print $2}')
        local client_ip=$(grep "^acl allowed_clients src" $CONF_FILE | awk '{print $4}')
        local server_ip=$(get_public_ip)
        echo -e "${GREEN}Squid 状态: [运行中]${PLAIN}"
        echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
        echo -e "监听端口: ${YELLOW}$port${PLAIN}"
        echo -e "客户端IP: ${YELLOW}$client_ip${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
    else
        echo -e "${RED}Squid 状态: [未运行]${PLAIN}"
    fi
}

# 添加IP
add_ip() {
    echo -e ""
    read -p "请输入要添加的客户端IP: " new_ip
    if [[ "$new_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        if grep -q "acl client_$new_ip" $CONF_FILE; then
            echo -e "${YELLOW}此IP已存在白名单中！${PLAIN}"
        else
            # 在 http_access deny all 之前添加
            sed -i "/^http_access deny all/i acl client_$new_ip src $new_ip\nhttp_access allow client_$new_ip" $CONF_FILE
            echo -e "${GREEN}已添加IP: $new_ip${PLAIN}"
            restart_service
        fi
    else
        echo -e "${RED}IP格式错误！${PLAIN}"
    fi
}

# 改端口
modify_port() {
    local cur=$(grep "^http_port" $CONF_FILE | awk '{print $2}')
    echo -e "当前端口: ${YELLOW}$cur${PLAIN}"
    read -p "请输入新端口: " new_port
    if [[ -n "$new_port" && "$new_port" =~ ^[0-9]+$ ]]; then
        sed -i "s/^http_port .*/http_port $new_port/" $CONF_FILE
        echo -e "${GREEN}端口已修改: $new_port${PLAIN}"
        restart_service
    else
        echo -e "${RED}端口格式错误！${PLAIN}"
    fi
}

# 改客户端IP
modify_client_ip() {
    local cur=$(grep "^acl allowed_clients src" $CONF_FILE | awk '{print $4}')
    echo -e "当前客户端IP: ${YELLOW}$cur${PLAIN}"
    read -p "请输入新客户端IP: " new_ip
    if [[ "$new_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        sed -i "s/^acl allowed_clients src .*/acl allowed_clients src $new_ip/" $CONF_FILE
        echo -e "${GREEN}客户端IP已修改: $new_ip${PLAIN}"
        restart_service
    else
        echo -e "${RED}IP格式错误！${PLAIN}"
    fi
}

# 查看日志
view_logs() {
    echo -e "${BLUE}========== 最近日志 ==========${PLAIN}"
    if [[ -f /var/log/squid/access.log ]]; then
        tail -n 20 /var/log/squid/access.log
    else
        journalctl -u squid -n 20 --no-pager
    fi
}

# 检查配置
check_config() {
    echo -e "${BLUE}========== 检查配置 ==========${PLAIN}"
    squid -k parse
}

# 使用说明（带参数）
show_usage_with_ip() {
    local server_ip="$1"
    local port="$2"
    
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e "${BLUE}【完整代理地址】${PLAIN}"
    echo -e "${GREEN}http://$server_ip:$port${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【环境变量配置】${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【Linux 使用命令】${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}1. 临时设置代理 (仅当前终端有效)${PLAIN}"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export ftp_proxy=http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}2. 一行命令临时设置代理${PLAIN}"
    echo -e "   ${GREEN}export HTTP_PROXY=http://$server_ip:$port HTTPS_PROXY=http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【在另一台机器上测试网络连通】${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}3. 测试代理是否可用${PLAIN}"
    echo -e "   ${GREEN}curl -x http://$server_ip:$port http://httpbin.org/ip${PLAIN}"
    echo -e "   说明: 返回IP地址说明代理正常工作"
    echo -e ""
    echo -e "${YELLOW}4. 测试端口是否开放${PLAIN}"
    echo -e "   ${GREEN}nc -zv $server_ip $port${PLAIN}"
    echo -e "   或者"
    echo -e "   ${GREEN}telnet $server_ip $port${PLAIN}"
    echo -e "   说明: 连接成功说明端口正常开放"
    echo -e ""
    echo -e "${YELLOW}5. 使用wget测试代理${PLAIN}"
    echo -e "   ${GREEN}wget -e use_proxy=yes -e http_proxy=http://$server_ip:$port http://www.google.com -O /tmp/test.html${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}6. 设置代理后测试访问${PLAIN}"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}curl http://httpbin.org/ip${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【永久设置代理】${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}7. 所有用户永久设置${PLAIN}"
    echo -e "   编辑 ${BLUE}/etc/profile${PLAIN} 文件末尾添加:"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   然后执行: ${GREEN}source /etc/profile${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}8. 当前用户永久设置${PLAIN}"
    echo -e "   编辑 ${BLUE}~/.bashrc${PLAIN} 文件末尾添加:"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   然后执行: ${GREEN}source ~/.bashrc${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【常用软件代理设置】${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}9. Docker 使用代理${PLAIN}"
    echo -e "   ${GREEN}docker run --env HTTP_PROXY=http://$server_ip:$port --env HTTPS_PROXY=http://$server_ip:$port image_name${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}10. Git 使用代理${PLAIN}"
    echo -e "   ${GREEN}git config --global http.proxy http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}git config --global https.proxy http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}11. pip 使用代理${PLAIN}"
    echo -e "   ${GREEN}pip install --proxy http://$server_ip:$port package_name${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}12. apt-get 使用代理${PLAIN}"
    echo -e "   ${GREEN}apt-get -o Acquire::http::Proxy=http://$server_ip:$port update${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}13. yum 使用代理${PLAIN}"
    echo -e "   编辑 ${BLUE}/etc/yum.conf${PLAIN} 添加:"
    echo -e "   ${GREEN}proxy=http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}14. systemd 服务使用代理${PLAIN}"
    echo -e "   编辑服务文件 ${BLUE}/etc/systemd/system/xxx.service${PLAIN}"
    echo -e "   在 [Service] 段添加:"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}15. 取消代理设置${PLAIN}"
    echo -e "   ${GREEN}unset http_proxy https_proxy ftp_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY${PLAIN}"
    echo -e ""
    echo -e "${GREEN}==================================${PLAIN}"
}

# 使用说明
show_usage() {
    local port=$(grep "^http_port" $CONF_FILE 2>/dev/null | awk '{print $2}')
    local server_ip=$(get_public_ip)
    [[ -z "$port" ]] && port="3128"
    
    clear
    show_usage_with_ip "$server_ip" "$port"
}

# 菜单
menu() {
    clear
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e "${GREEN}     Squid 一键管理脚本${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e " 快捷管理命令: ${YELLOW}Squid${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e " 1. 安装 Squid"
    echo -e " 2. 卸载 Squid"
    echo -e "${GREEN}----------------------------------${PLAIN}"
    echo -e " 3. 启动服务"
    echo -e " 4. 停止服务"
    echo -e " 5. 重启服务"
    echo -e " 6. 查看状态"
    echo -e "${GREEN}----------------------------------${PLAIN}"
    echo -e " 7. 添加客户端IP"
    echo -e " 8. 修改端口"
    echo -e " 9. 修改客户端IP"
    echo -e "10. 查看日志"
    echo -e "11. 检查配置"
    echo -e "12. 使用说明"
    echo -e " 0. 退出"
    echo -e "${GREEN}==================================${PLAIN}"
    read -p "请输入选项 [0-12]: " choice

    case $choice in
        1) check_sys; install_squid ;;
        2) check_sys; uninstall_squid ;;
        3) start_service ;;
        4) stop_service ;;
        5) restart_service ;;
        6) show_status ;;
        7) add_ip ;;
        8) modify_port ;;
        9) modify_client_ip ;;
        10) view_logs ;;
        11) check_config ;;
        12) show_usage ;;
        0) echo -e "${GREEN}退出脚本${PLAIN}"; exit 0 ;;
        *) echo -e "${RED}输入错误，请重新输入${PLAIN}" ;;
    esac
    
    echo -e ""
    read -p "按 Enter 键继续..."
    menu
}

# 主逻辑
check_root
[[ "$1" == "install" ]] && { check_sys; install_squid; } || menu