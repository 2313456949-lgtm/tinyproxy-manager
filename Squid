#!/bin/bash

# ==================================================
# Squid 一键管理脚本
# ==================================================

RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'

CONF_FILE="/etc/squid/squid.conf"
SCRIPT_URL="https://raw.githubusercontent.com/Laojiu89/hapyy/main/Squid"

# 获取服务器公网IPv4（禁用IPv6）
get_public_ip() {
    local ip=""
    ip=$(curl -4 -s --max-time 5 ifconfig.me 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 ip.sb 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 ipinfo.io/ip 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(curl -4 -s --max-time 5 api.ipify.org 2>/dev/null)
    [[ -z "$ip" ]] && ip=$(hostname -I | awk '{print $1}')
    echo "$ip"
}

# 检查Root
check_root() {
    [[ $EUID -ne 0 ]] && echo -e "${RED}错误: 请使用 root 用户运行此脚本！${PLAIN}" && exit 1
}

# 系统检测
check_sys() {
    if [[ -f /etc/redhat-release ]]; then
        RELEASE="centos"
    elif [[ -f /etc/debian_version ]]; then
        RELEASE="debian"
    else
        RELEASE="unknown"
    fi
    [[ "$RELEASE" == "unknown" ]] && echo -e "${RED}无法识别系统类型！${PLAIN}" && exit 1
}

# 安装快捷命令
install_shortcut() {
    echo -e "${YELLOW}正在安装快捷命令...${PLAIN}"
    curl -sL "$SCRIPT_URL" -o /usr/local/bin/Squid
    chmod +x /usr/local/bin/Squid
    if [[ -f /usr/local/bin/Squid && -s /usr/local/bin/Squid ]]; then
        echo -e "${GREEN}快捷命令安装成功！以后可以直接输入 'Squid' 来管理${PLAIN}"
    else
        echo -e "${YELLOW}快捷命令安装失败，但不影响使用${PLAIN}"
    fi
}

# 安装
install_squid() {
    echo -e "${GREEN}正在安装 Squid...${PLAIN}"
    
    if [[ "$RELEASE" == "centos" ]]; then
        echo -e "${YELLOW}安装 squid...${PLAIN}"
        yum install -y squid
    else
        echo -e "${YELLOW}更新软件源...${PLAIN}"
        apt-get update
        echo -e "${YELLOW}安装 squid...${PLAIN}"
        apt-get install -y squid
    fi

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Squid 安装成功！${PLAIN}"
        
        # 安装快捷命令（从网络下载）
        install_shortcut
        
        # 备份原配置
        [[ -f $CONF_FILE ]] && cp $CONF_FILE ${CONF_FILE}.bak.$(date +%s)
        
        # 设置开机自启
        systemctl enable squid
        echo -e "${GREEN}已设置开机自启${PLAIN}"
        
        sleep 1
        configure_squid
    else
        echo -e "${RED}安装失败，请检查网络或软件源${PLAIN}"
        exit 1
    fi
}

# 配置
configure_squid() {
    echo -e ""
    echo -e "${YELLOW}========== 配置向导 ==========${PLAIN}"
    
    # 端口
    read -p "请输入监听端口 [默认 3128]: " port
    [[ -z "$port" ]] && port="3128"
    
    # 服务器IP（自动获取IPv4，可修改）
    echo -e ""
    echo -e "${YELLOW}正在获取服务器公网IP...${PLAIN}"
    local server_ip=$(get_public_ip)
    
    if [[ -n "$server_ip" ]]; then
        echo -e "检测到服务器IP: ${GREEN}$server_ip${PLAIN}"
        read -p "服务器IP [直接回车使用 $server_ip]: " input_ip
        [[ -n "$input_ip" ]] && server_ip="$input_ip"
    else
        echo -e "${RED}无法自动获取公网IP${PLAIN}"
        read -p "请手动输入服务器IP: " server_ip
        while [[ -z "$server_ip" ]]; do
            echo -e "${RED}服务器IP不能为空！${PLAIN}"
            read -p "请输入服务器IP: " server_ip
        done
    fi
    echo -e "${GREEN}服务器IP已设置: $server_ip${PLAIN}"
    
    # 客户端IP（手动输入）
    echo -e ""
    read -p "请输入允许连接的客户端IP: " client_ip
    while [[ -z "$client_ip" || ! "$client_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$ ]]; do
        echo -e "${RED}客户端IP不能为空且格式需正确！${PLAIN}"
        read -p "请输入客户端IP (如 192.168.1.100 或 192.168.1.0/24): " client_ip
    done
    
    # 生成配置文件
    cat > $CONF_FILE << EOF
# ==================================================
# Squid 代理服务器配置文件
# ==================================================

# 监听端口（仅IPv4）
http_port $port

# ==================================================
# 访问控制列表 (ACL)
# ==================================================

# 本地网络
acl localhost src 127.0.0.1/32
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# SSL端口
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# ==================================================
# IP白名单配置
# ==================================================

# 允许的客户端IP白名单
acl whitelist src $client_ip

# ==================================================
# 访问控制规则
# ==================================================

# 拒绝非安全端口
http_access deny !Safe_ports

# 拒绝非SSL端口的CONNECT请求
http_access deny CONNECT !SSL_ports

# 允许本地访问
http_access allow localhost

# 允许白名单IP访问
http_access allow whitelist

# 拒绝其他所有访问
http_access deny all

# ==================================================
# 匿名代理设置（隐藏真实IP）
# ==================================================

# 禁用IPv6
dns_v4_first on

# 隐藏Squid版本信息
httpd_suppress_version_string on

# 禁用Via头
via off

# 禁用X-Forwarded-For（高匿代理）
forwarded_for off

# 请求头隐藏
request_header_access From deny all
request_header_access Server deny all
request_header_access Referer deny all
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Cache-Control deny all

# ==================================================
# 缓存设置
# ==================================================

cache_mem 128 MB
maximum_object_size 64 MB
minimum_object_size 0 KB
cache_dir ufs /var/spool/squid 1000 16 256

# ==================================================
# 日志设置
# ==================================================

access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# ==================================================
# 超时设置
# ==================================================

connect_timeout 60 seconds
read_timeout 60 seconds
request_timeout 60 seconds
client_lifetime 1 day
pconn_timeout 60 seconds

# ==================================================
# 性能优化
# ==================================================

# DNS缓存
dns_nameservers 8.8.8.8 8.8.4.4
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute
EOF

    echo -e "${GREEN}配置文件已生成${PLAIN}"

    # 创建缓存目录
    mkdir -p /var/spool/squid
    mkdir -p /var/log/squid
    chown -R squid:squid /var/spool/squid 2>/dev/null || chown -R proxy:proxy /var/spool/squid 2>/dev/null
    chown -R squid:squid /var/log/squid 2>/dev/null || chown -R proxy:proxy /var/log/squid 2>/dev/null

    # 初始化缓存目录
    echo -e "${YELLOW}正在初始化缓存目录...${PLAIN}"
    squid -z 2>/dev/null
    sleep 3

    echo -e ""
    echo -e "${YELLOW}正在启动服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    sleep 2
    systemctl start squid
    
    sleep 3
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}========== 配置完成 ==========${PLAIN}"
        echo -e ""
        echo -e "${BLUE}【代理信息】${PLAIN}"
        echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
        echo -e "监听端口: ${YELLOW}$port${PLAIN}"
        echo -e "客户端IP: ${YELLOW}$client_ip${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
        echo -e ""
        show_usage_with_ip "$server_ip" "$port"
    else
        echo -e "${RED}服务启动失败！错误信息：${PLAIN}"
        journalctl -u squid -n 15 --no-pager
        echo -e ""
        echo -e "${YELLOW}尝试检查配置文件...${PLAIN}"
        squid -k parse
        echo -e ""
        echo -e "${YELLOW}常见问题：${PLAIN}"
        echo -e "1. 端口被占用，请更换端口"
        echo -e "2. 配置文件错误，运行: squid -k parse"
        echo -e "3. 查看日志: tail -f /var/log/squid/cache.log"
    fi
}

# 卸载
uninstall_squid() {
    echo -e "${YELLOW}正在停止服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    systemctl disable squid 2>/dev/null
    
    echo -e "${YELLOW}正在卸载 Squid...${PLAIN}"
    if [[ "$RELEASE" == "centos" ]]; then
        yum remove -y squid
    else
        apt-get remove -y squid --purge
    fi
    
    rm -rf /etc/squid
    rm -rf /var/spool/squid
    rm -rf /var/log/squid
    rm -f /usr/local/bin/Squid
    echo -e "${GREEN}卸载完成！${PLAIN}"
}

# 启动
start_service() {
    echo -e "${YELLOW}正在启动服务...${PLAIN}"
    systemctl start squid
    sleep 2
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}服务已启动！${PLAIN}"
        show_status
    else
        echo -e "${RED}服务启动失败！${PLAIN}"
        journalctl -u squid -n 10 --no-pager
    fi
}

# 停止
stop_service() {
    echo -e "${YELLOW}正在停止服务...${PLAIN}"
    systemctl stop squid
    echo -e "${GREEN}服务已停止！${PLAIN}"
}

# 重启
restart_service() {
    echo -e "${YELLOW}正在重启服务...${PLAIN}"
    systemctl stop squid 2>/dev/null
    sleep 2
    systemctl start squid
    sleep 2
    if systemctl is-active --quiet squid; then
        echo -e "${GREEN}服务已重启！${PLAIN}"
        show_status
    else
        echo -e "${RED}服务重启失败！${PLAIN}"
        journalctl -u squid -n 10 --no-pager
    fi
}

# 状态
show_status() {
    echo -e ""
    if systemctl is-active --quiet squid; then
        local port=$(grep "^http_port" $CONF_FILE 2>/dev/null | awk '{print $2}')
        local server_ip=$(get_public_ip)
        echo -e "${GREEN}Squid 状态: [运行中]${PLAIN}"
        echo -e "服务器地址: ${YELLOW}$server_ip${PLAIN}"
        echo -e "监听端口: ${YELLOW}$port${PLAIN}"
        echo -e "代理地址: ${GREEN}http://$server_ip:$port${PLAIN}"
        echo -e ""
        echo -e "${BLUE}【开机自启状态】${PLAIN}"
        if systemctl is-enabled --quiet squid; then
            echo -e "开机自启: ${GREEN}已启用${PLAIN}"
        else
            echo -e "开机自启: ${RED}未启用${PLAIN}"
        fi
        echo -e ""
        echo -e "${BLUE}【当前白名单IP】${PLAIN}"
        grep "^acl whitelist src\|^acl client_" $CONF_FILE 2>/dev/null | awk '{print $4}'
    else
        echo -e "${RED}Squid 状态: [未运行]${PLAIN}"
    fi
}

# 查看白名单
view_whitelist() {
    echo -e ""
    echo -e "${BLUE}========== IP白名单列表 ==========${PLAIN}"
    echo -e ""
    local count=1
    while read line; do
        local ip=$(echo "$line" | awk '{print $4}')
        echo -e " ${GREEN}$count.${PLAIN} $ip"
        ((count++))
    done < <(grep "^acl whitelist src\|^acl client_" $CONF_FILE 2>/dev/null)
    echo -e ""
    echo -e "${BLUE}==================================${PLAIN}"
}

# 添加IP到白名单
add_ip() {
    echo -e ""
    echo -e "${BLUE}【添加IP到白名单】${PLAIN}"
    echo -e "支持格式:"
    echo -e "  单个IP: ${GREEN}192.168.1.100${PLAIN}"
    echo -e "  IP段:   ${GREEN}192.168.1.0/24${PLAIN}"
    echo -e ""
    read -p "请输入要添加的IP: " new_ip
    
    if [[ "$new_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$ ]]; then
        # 生成唯一的ACL名称
        local acl_name="client_$(echo $new_ip | tr './' '__')"
        
        if grep -q "src $new_ip" $CONF_FILE 2>/dev/null; then
            echo -e "${YELLOW}此IP已存在白名单中！${PLAIN}"
        else
            # 在 http_access deny all 之前添加
            sed -i "/^# 拒绝其他所有访问/i # 白名单IP: $new_ip\nacl $acl_name src $new_ip\nhttp_access allow $acl_name\n" $CONF_FILE
            echo -e "${GREEN}已添加IP到白名单: $new_ip${PLAIN}"
            restart_service
        fi
    else
        echo -e "${RED}IP格式错误！${PLAIN}"
    fi
}

# 删除白名单IP
del_ip() {
    echo -e ""
    view_whitelist
    echo -e ""
    read -p "请输入要删除的IP: " del_ip
    
    if [[ -z "$del_ip" ]]; then
        echo -e "${RED}IP不能为空！${PLAIN}"
        return
    fi
    
    if grep -q "src $del_ip" $CONF_FILE 2>/dev/null; then
        # 删除相关的ACL和http_access行
        local acl_name=$(grep "src $del_ip" $CONF_FILE | awk '{print $2}')
        sed -i "/acl $acl_name src/d" $CONF_FILE
        sed -i "/http_access allow $acl_name/d" $CONF_FILE
        sed -i "/# 白名单IP: $del_ip/d" $CONF_FILE
        echo -e "${GREEN}已从白名单删除IP: $del_ip${PLAIN}"
        restart_service
    else
        echo -e "${RED}此IP不在白名单中！${PLAIN}"
    fi
}

# 改端口
modify_port() {
    local cur=$(grep "^http_port" $CONF_FILE 2>/dev/null | awk '{print $2}')
    echo -e "当前端口: ${YELLOW}$cur${PLAIN}"
    read -p "请输入新端口: " new_port
    if [[ -n "$new_port" && "$new_port" =~ ^[0-9]+$ ]]; then
        sed -i "s/^http_port .*/http_port $new_port/" $CONF_FILE
        echo -e "${GREEN}端口已修改: $new_port${PLAIN}"
        restart_service
    else
        echo -e "${RED}端口格式错误！${PLAIN}"
    fi
}

# 开机自启管理
manage_autostart() {
    echo -e ""
    echo -e "${BLUE}========== 开机自启管理 ==========${PLAIN}"
    if systemctl is-enabled --quiet squid; then
        echo -e "当前状态: ${GREEN}已启用${PLAIN}"
    else
        echo -e "当前状态: ${RED}未启用${PLAIN}"
    fi
    echo -e ""
    echo -e " 1. 启用开机自启"
    echo -e " 2. 禁用开机自启"
    echo -e " 0. 返回"
    echo -e ""
    read -p "请选择: " choice
    
    case $choice in
        1)
            systemctl enable squid
            echo -e "${GREEN}已启用开机自启${PLAIN}"
            ;;
        2)
            systemctl disable squid
            echo -e "${GREEN}已禁用开机自启${PLAIN}"
            ;;
        0)
            return
            ;;
        *)
            echo -e "${RED}输入错误${PLAIN}"
            ;;
    esac
}

# 访问控制管理
access_control() {
    echo -e ""
    echo -e "${BLUE}========== 访问控制管理 ==========${PLAIN}"
    echo -e ""
    echo -e " 1. 查看白名单"
    echo -e " 2. 添加IP到白名单"
    echo -e " 3. 删除白名单IP"
    echo -e " 4. 允许所有IP访问 (不推荐)"
    echo -e " 5. 仅允许白名单访问"
    echo -e " 0. 返回"
    echo -e ""
    read -p "请选择: " choice
    
    case $choice in
        1)
            view_whitelist
            ;;
        2)
            add_ip
            ;;
        3)
            del_ip
            ;;
        4)
            echo -e "${RED}警告: 允许所有IP访问会带来安全风险！${PLAIN}"
            read -p "确认要允许所有IP访问吗？(y/n): " confirm
            if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
                sed -i "s/^http_access deny all/http_access allow all/" $CONF_FILE
                echo -e "${GREEN}已允许所有IP访问${PLAIN}"
                restart_service
            fi
            ;;
        5)
            sed -i "s/^http_access allow all/http_access deny all/" $CONF_FILE
            echo -e "${GREEN}已设置为仅允许白名单访问${PLAIN}"
            restart_service
            ;;
        0)
            return
            ;;
        *)
            echo -e "${RED}输入错误${PLAIN}"
            ;;
    esac
}

# 查看日志
view_logs() {
    echo -e "${BLUE}========== 日志查看 ==========${PLAIN}"
    echo -e ""
    echo -e " 1. 访问日志 (access.log)"
    echo -e " 2. 缓存日志 (cache.log)"
    echo -e " 3. 系统日志 (journalctl)"
    echo -e " 0. 返回"
    echo -e ""
    read -p "请选择: " choice
    
    case $choice in
        1)
            if [[ -f /var/log/squid/access.log ]]; then
                tail -n 30 /var/log/squid/access.log
            else
                echo -e "${RED}访问日志不存在${PLAIN}"
            fi
            ;;
        2)
            if [[ -f /var/log/squid/cache.log ]]; then
                tail -n 30 /var/log/squid/cache.log
            else
                echo -e "${RED}缓存日志不存在${PLAIN}"
            fi
            ;;
        3)
            journalctl -u squid -n 30 --no-pager
            ;;
        0)
            return
            ;;
        *)
            echo -e "${RED}输入错误${PLAIN}"
            ;;
    esac
}

# 检查配置
check_config() {
    echo -e "${BLUE}========== 检查配置语法 ==========${PLAIN}"
    squid -k parse
    if [ $? -eq 0 ]; then
        echo -e ""
        echo -e "${GREEN}配置文件语法正确！${PLAIN}"
    fi
}

# 使用说明（带参数）
show_usage_with_ip() {
    local server_ip="$1"
    local port="$2"
    
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e "${BLUE}【完整代理地址】${PLAIN}"
    echo -e "${GREEN}http://$server_ip:$port${PLAIN}"
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e ""
    echo -e "${BLUE}【环境变量配置】${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e ""
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e "${BLUE}【在另外一台服务器上使用代理】${PLAIN}"
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}方法1: 临时设置代理 (仅当前终端有效)${PLAIN}"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export ftp_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export no_proxy=localhost,127.0.0.1${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}方法2: 一行命令设置代理${PLAIN}"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}方法3: 永久设置代理 (所有用户)${PLAIN}"
    echo -e "   编辑 ${BLUE}/etc/profile${PLAIN} 或 ${BLUE}/etc/environment${PLAIN} 文件末尾添加:"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export ftp_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export no_proxy=localhost,127.0.0.1${PLAIN}"
    echo -e "   然后执行: ${GREEN}source /etc/profile${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}方法4: 当前用户永久设置${PLAIN}"
    echo -e "   编辑 ${BLUE}~/.bashrc${PLAIN} 或 ${BLUE}~/.bash_profile${PLAIN} 文件末尾添加:"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   然后执行: ${GREEN}source ~/.bashrc${PLAIN}"
    echo -e ""
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e "${BLUE}【测试代理连接】${PLAIN}"
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}1. 测试代理是否可用${PLAIN}"
    echo -e "   ${GREEN}curl -x http://$server_ip:$port http://httpbin.org/ip${PLAIN}"
    echo -e "   说明: 返回代理服务器IP地址说明代理正常工作"
    echo -e ""
    echo -e "${YELLOW}2. 测试端口是否开放${PLAIN}"
    echo -e "   ${GREEN}nc -zv $server_ip $port${PLAIN}"
    echo -e "   或者"
    echo -e "   ${GREEN}telnet $server_ip $port${PLAIN}"
    echo -e "   说明: 连接成功说明端口正常开放"
    echo -e ""
    echo -e "${YELLOW}3. 使用wget测试代理${PLAIN}"
    echo -e "   ${GREEN}wget -e use_proxy=yes -e http_proxy=http://$server_ip:$port http://www.google.com -O /tmp/test.html${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}4. 设置代理后测试访问${PLAIN}"
    echo -e "   ${GREEN}export http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}export https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}curl -I http://www.google.com${PLAIN}"
    echo -e "   ${GREEN}curl http://httpbin.org/ip${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}5. 测试HTTPS代理${PLAIN}"
    echo -e "   ${GREEN}curl -x http://$server_ip:$port https://www.google.com${PLAIN}"
    echo -e ""
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e "${BLUE}【常用软件代理设置】${PLAIN}"
    echo -e "${GREEN}==================================================================${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}Docker 使用代理${PLAIN}"
    echo -e "   方法1: 运行时指定"
    echo -e "   ${GREEN}docker run --env HTTP_PROXY=http://$server_ip:$port --env HTTPS_PROXY=http://$server_ip:$port image_name${PLAIN}"
    echo -e ""
    echo -e "   方法2: Docker守护进程代理"
    echo -e "   创建文件 ${BLUE}/etc/systemd/system/docker.service.d/proxy.conf${PLAIN}"
    echo -e "   ${GREEN}[Service]${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   然后执行:"
    echo -e "   ${GREEN}systemctl daemon-reload${PLAIN}"
    echo -e "   ${GREEN}systemctl restart docker${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}Git 使用代理${PLAIN}"
    echo -e "   ${GREEN}git config --global http.proxy http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}git config --global https.proxy http://$server_ip:$port${PLAIN}"
    echo -e "   取消代理:"
    echo -e "   ${GREEN}git config --global --unset http.proxy${PLAIN}"
    echo -e "   ${GREEN}git config --global --unset https.proxy${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}pip 使用代理${PLAIN}"
    echo -e "   ${GREEN}pip install --proxy http://$server_ip:$port package_name${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}apt-get 使用代理${PLAIN}"
    echo -e "   临时使用:"
    echo -e "   ${GREEN}apt-get -o Acquire::http::Proxy=http://$server_ip:$port update${PLAIN}"
    echo -e ""
    echo -e "   永久设置: 编辑 ${BLUE}/etc/apt/apt.conf.d/proxy.conf${PLAIN}"
    echo -e "   ${GREEN}Acquire::http::Proxy \"http://$server_ip:$port\";${PLAIN}"
    echo -e "   ${GREEN}Acquire::https::Proxy \"http://$server_ip:$port\";${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}yum 使用代理${PLAIN}"
    echo -e "   编辑 ${BLUE}/etc/yum.conf${PLAIN} 添加:"
    echo -e "   ${GREEN}proxy=http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}wget 使用代理${PLAIN}"
    echo -e "   临时使用:"
    echo -e "   ${GREEN}wget -e http_proxy=http://$server_ip:$port URL${PLAIN}"
    echo -e ""
    echo -e "   永久设置: 编辑 ${BLUE}~/.wgetrc${PLAIN}"
    echo -e "   ${GREEN}http_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}https_proxy=http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}use_proxy=on${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}curl 使用代理${PLAIN}"
    echo -e "   ${GREEN}curl -x http://$server_ip:$port URL${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}npm 使用代理${PLAIN}"
    echo -e "   ${GREEN}npm config set proxy http://$server_ip:$port${PLAIN}"
    echo -e "   ${GREEN}npm config set https-proxy http://$server_ip:$port${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}systemd 服务使用代理${PLAIN}"
    echo -e "   编辑服务文件 ${BLUE}/etc/systemd/system/xxx.service${PLAIN}"
    echo -e "   在 [Service] 段添加:"
    echo -e "   ${GREEN}Environment=\"HTTP_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"HTTPS_PROXY=http://$server_ip:$port\"${PLAIN}"
    echo -e "   ${GREEN}Environment=\"NO_PROXY=localhost,127.0.0.1\"${PLAIN}"
    echo -e ""
    echo -e "${YELLOW}取消代理设置${PLAIN}"
    echo -e "   ${GREEN}unset http_proxy https_proxy ftp_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY no_proxy NO_PROXY${PLAIN}"
    echo -e ""
    echo -e "${GREEN}==================================================================${PLAIN}"
}

# 使用说明
show_usage() {
    local port=$(grep "^http_port" $CONF_FILE 2>/dev/null | awk '{print $2}')
    local server_ip=$(get_public_ip)
    [[ -z "$port" ]] && port="3128"
    
    clear
    show_usage_with_ip "$server_ip" "$port"
}

# 菜单
menu() {
    clear
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e "${GREEN}     Squid 一键管理脚本${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e " 快捷管理命令: ${YELLOW}Squid${PLAIN}"
    echo -e "${GREEN}==================================${PLAIN}"
    echo -e " 1. 安装 Squid"
    echo -e " 2. 卸载 Squid"
    echo -e "${GREEN}----------------------------------${PLAIN}"
    echo -e " 3. 启动服务"
    echo -e " 4. 停止服务"
    echo -e " 5. 重启服务"
    echo -e " 6. 查看状态"
    echo -e "${GREEN}----------------------------------${PLAIN}"
    echo -e " 7. 访问控制 (IP白名单)"
    echo -e " 8. 修改端口"
    echo -e " 9. 开机自启管理"
    echo -e "10. 查看日志"
    echo -e "11. 检查配置"
    echo -e "12. 使用说明"
    echo -e " 0. 退出"
    echo -e "${GREEN}==================================${PLAIN}"
    read -p "请输入选项 [0-12]: " choice

    case $choice in
        1) check_sys; install_squid ;;
        2) check_sys; uninstall_squid ;;
        3) start_service ;;
        4) stop_service ;;
        5) restart_service ;;
        6) show_status ;;
        7) access_control ;;
        8) modify_port ;;
        9) manage_autostart ;;
        10) view_logs ;;
        11) check_config ;;
        12) show_usage ;;
        0) echo -e "${GREEN}退出脚本${PLAIN}"; exit 0 ;;
        *) echo -e "${RED}输入错误，请重新输入${PLAIN}" ;;
    esac
    
    echo -e ""
    read -p "按 Enter 键继续..."
    menu
}

# 主逻辑
check_root
[[ "$1" == "install" ]] && { check_sys; install_squid; } || menu
